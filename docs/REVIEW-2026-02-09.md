# Проектный разбор (2026-02-09)

Ниже краткие выводы по состоянию проекта и рискам, с опорой на текущие файлы, включая `docs/TESTING.md`.

## Что сделано хорошо

- Чётко описана архитектура n8n и логика v6, включая knowledge base и hardcoded onboarding.  
  `docs/ARCHITECTURE.md`
- Есть воспроизводимая E2E схема тестирования через webhook-симуляцию.  
  `docs/TESTING.md`
- Схема БД покрывает ключевые сущности, есть миграции и ограничения целостности.  
  `database/schema.sql`

## Риски и несоответствия

1. Еженедельный workflow не заполняет `week_end`, а поле обязательное.  
   `database/schema.sql:139`, `n8n-workflows/workflow-weekly-summary.json:210`
2. В setup перепутаны ключи Supabase: `anon key` указан как `service role`.  
   Это противоречит RLS-практике и заметке в схеме.  
   `setup/SETUP-GUIDE.md:101`, `setup/SETUP-GUIDE.md:164`, `database/schema.sql:348`
3. Документация местами не обновлена (v5/v6, N8N Cloud vs self-hosted).  
   `README.md:47`, `README.md:64`, `docs/ARCHITECTURE.md:11`
4. В репозитории есть артефакты от локального Python-исполнения.  
   `n8n-workflows/__pycache__/`
5. В JSON workflow зафиксированы ID и имена credentials, что мешает переносимости и может вести к ошибкам импорта.  
   `n8n-workflows/workflow-main-chatbot-v6.json:25`

## Рекомендации по приоритету

1. Исправить `weekly-summary`: добавить `week_end` и, по возможности, контроль ошибок записи плана.  
2. Привести `setup/SETUP-GUIDE.md` к корректным ключам Supabase и убрать потенциально вводящие в заблуждение формулировки.  
3. Обновить `README.md` и `docs/PROJECT-WORK-PLAN.md` под реальную структуру (v6, self-hosted).  
4. Добавить `__pycache__/` в `.gitignore` или удалить из репозитория.  
5. Отдельно документировать, как чистить `credentials` в JSON перед публикацией.

## Тестирование

Подход с webhook-симуляцией выглядит рабочим и масштабируемым.  
Рекомендация: добавить один сценарий на проверку weekly-summary, чтобы ловить падения вставки в `weekly_plans` после изменений схемы.

## Следующие шаги (предлагаемые)

1. Подтвердить, какие файлы нужно править первыми: workflow или docs.
2. При необходимости я могу предложить патч, который синхронизирует docs и добавит недостающие поля в workflow.

---

## Результаты исправлений (9 февраля 2026)

### Замечание 1: `week_end` отсутствует в weekly-summary workflow
**Статус:** Исправлено

**Что было:** Нода `Save New Plan` в `workflow-weekly-summary.json` записывала `week_start`, но не `week_end`. Поле `week_end DATE NOT NULL` в `schema.sql` — обязательное, поэтому INSERT падал.

**Что сделано:**
- В ноде `Build Summary Prompt` добавлен расчёт `next_sunday` (nextMonday + 6 дней) и передача в выходные данные
- В ноде `Parse Response` добавлена передача `next_sunday` дальше по цепочке
- В ноде `Save New Plan` добавлено поле `week_end` со значением `$('Parse Response').first().json.next_sunday`

**Файл:** `n8n-workflows/workflow-weekly-summary.json`

---

### Замечание 2: Перепутаны ключи Supabase в SETUP-GUIDE
**Статус:** Исправлено

**Что было:** В инструкции по настройке Supabase credential в n8n было написано `Service Role Secret: ваш SUPABASE_ANON_KEY`. Anon key подчиняется RLS и не имеет доступа к данным других пользователей. В `schema.sql` прямо указано, что n8n использует `service_role key`.

**Что сделано:**
- Заменено `SUPABASE_ANON_KEY` на `SUPABASE_SERVICE_ROLE_KEY` в секции сохранения ключей
- Заменено `anon public key` на `service_role key` в инструкции что копировать
- Добавлено пояснение о разнице между anon и service_role ключами и почему нужен именно service_role

**Файл:** `setup/SETUP-GUIDE.md`

---

### Замечание 3: README устарел (v5, N8N Cloud)
**Статус:** Исправлено

**Что было:**
- Указано `N8N Cloud` вместо `self-hosted`
- Основной workflow — `v5.json` вместо `v6.json`
- Не упомянуты: база знаний, E2E тесты, weekly-summary, ARCHITECTURE.md, TESTING.md
- Стоимость включала `N8N Cloud: $50` при том что n8n self-hosted

**Что сделано:**
- Стек: `N8N Cloud` → `n8n (self-hosted)`, добавлены GPT-4o Vision и база знаний
- Структура проекта: добавлены v6 workflow, weekly-summary, e2e-tests, prepare-data-v6.js
- Документация: добавлены ARCHITECTURE.md, TESTING.md, coach-knowledge/
- MVP Scope: обновлён список реализованных фич (стратегии, Vision, cron, тесты)
- Стоимость: убран N8N Cloud, пересчитан production ($175 вместо $225)
- Версия: `1.5` → `2.0 (v6)`

**Файл:** `README.md`

---

### Замечание 4: `__pycache__/` не в `.gitignore`
**Статус:** Исправлено

**Что было:** Файл `n8n-workflows/__pycache__/add-test-webhook.cpython-313.pyc` не был закоммичен, но `.gitignore` не содержал правил для Python-артефактов. При `git add -A` файл мог попасть в коммит.

**Что сделано:**
- Добавлены правила `__pycache__/` и `*.pyc` в `.gitignore`

**Файл:** `.gitignore`

---

### Замечание 5: Credential ID в JSON workflow
**Статус:** Принято к сведению, не исправлено

**Причина:** Это стандартное поведение n8n — при экспорте workflow credential references всегда включаются. При импорте на другой инстанс n8n предлагает переназначить credentials. Технически это не баг, а особенность платформы.

---

### Дополнительно: тест для weekly_plans
**Статус:** Добавлено в беклог

Рекомендация из аудита — добавить E2E тест для проверки генерации недельного плана. Записано в `docs/BACKLOG.md`.
