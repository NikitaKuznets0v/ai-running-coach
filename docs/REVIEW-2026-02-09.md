# Проектный разбор (2026-02-09)

Ниже краткие выводы по состоянию проекта и рискам, с опорой на текущие файлы, включая `docs/TESTING.md`.

## Что сделано хорошо

- Чётко описана архитектура n8n и логика v6, включая knowledge base и hardcoded onboarding.  
  `docs/ARCHITECTURE.md`
- Есть воспроизводимая E2E схема тестирования через webhook-симуляцию.  
  `docs/TESTING.md`
- Схема БД покрывает ключевые сущности, есть миграции и ограничения целостности.  
  `database/schema.sql`

## Риски и несоответствия

1. Еженедельный workflow не заполняет `week_end`, а поле обязательное.  
   `database/schema.sql:139`, `n8n-workflows/workflow-weekly-summary.json:210`
2. В setup перепутаны ключи Supabase: `anon key` указан как `service role`.  
   Это противоречит RLS-практике и заметке в схеме.  
   `setup/SETUP-GUIDE.md:101`, `setup/SETUP-GUIDE.md:164`, `database/schema.sql:348`
3. Документация местами не обновлена (v5/v6, N8N Cloud vs self-hosted).  
   `README.md:47`, `README.md:64`, `docs/ARCHITECTURE.md:11`
4. В репозитории есть артефакты от локального Python-исполнения.  
   `n8n-workflows/__pycache__/`
5. В JSON workflow зафиксированы ID и имена credentials, что мешает переносимости и может вести к ошибкам импорта.  
   `n8n-workflows/workflow-main-chatbot-v6.json:25`

## Рекомендации по приоритету

1. Исправить `weekly-summary`: добавить `week_end` и, по возможности, контроль ошибок записи плана.  
2. Привести `setup/SETUP-GUIDE.md` к корректным ключам Supabase и убрать потенциально вводящие в заблуждение формулировки.  
3. Обновить `README.md` и `docs/PROJECT-WORK-PLAN.md` под реальную структуру (v6, self-hosted).  
4. Добавить `__pycache__/` в `.gitignore` или удалить из репозитория.  
5. Отдельно документировать, как чистить `credentials` в JSON перед публикацией.

## Тестирование

Подход с webhook-симуляцией выглядит рабочим и масштабируемым.  
Рекомендация: добавить один сценарий на проверку weekly-summary, чтобы ловить падения вставки в `weekly_plans` после изменений схемы.

## Следующие шаги (предлагаемые)

1. Подтвердить, какие файлы нужно править первыми: workflow или docs.
2. При необходимости я могу предложить патч, который синхронизирует docs и добавит недостающие поля в workflow.

---

## Результаты исправлений (9 февраля 2026)

### Замечание 1: `week_end` отсутствует в weekly-summary workflow
**Статус:** Исправлено

**Что было:** Нода `Save New Plan` в `workflow-weekly-summary.json` записывала `week_start`, но не `week_end`. Поле `week_end DATE NOT NULL` в `schema.sql` — обязательное, поэтому INSERT падал.

**Что сделано:**
- В ноде `Build Summary Prompt` добавлен расчёт `next_sunday` (nextMonday + 6 дней) и передача в выходные данные
- В ноде `Parse Response` добавлена передача `next_sunday` дальше по цепочке
- В ноде `Save New Plan` добавлено поле `week_end` со значением `$('Parse Response').first().json.next_sunday`

**Файл:** `n8n-workflows/workflow-weekly-summary.json`

---

### Замечание 2: Перепутаны ключи Supabase в SETUP-GUIDE
**Статус:** Исправлено

**Что было:** В инструкции по настройке Supabase credential в n8n было написано `Service Role Secret: ваш SUPABASE_ANON_KEY`. Anon key подчиняется RLS и не имеет доступа к данным других пользователей. В `schema.sql` прямо указано, что n8n использует `service_role key`.

**Что сделано:**
- Заменено `SUPABASE_ANON_KEY` на `SUPABASE_SERVICE_ROLE_KEY` в секции сохранения ключей
- Заменено `anon public key` на `service_role key` в инструкции что копировать
- Добавлено пояснение о разнице между anon и service_role ключами и почему нужен именно service_role

**Файл:** `setup/SETUP-GUIDE.md`

---

### Замечание 3: README устарел (v5, N8N Cloud)
**Статус:** Исправлено

**Что было:**
- Указано `N8N Cloud` вместо `self-hosted`
- Основной workflow — `v5.json` вместо `v6.json`
- Не упомянуты: база знаний, E2E тесты, weekly-summary, ARCHITECTURE.md, TESTING.md
- Стоимость включала `N8N Cloud: $50` при том что n8n self-hosted

**Что сделано:**
- Стек: `N8N Cloud` → `n8n (self-hosted)`, добавлены GPT-4o Vision и база знаний
- Структура проекта: добавлены v6 workflow, weekly-summary, e2e-tests, prepare-data-v6.js
- Документация: добавлены ARCHITECTURE.md, TESTING.md, coach-knowledge/
- MVP Scope: обновлён список реализованных фич (стратегии, Vision, cron, тесты)
- Стоимость: убран N8N Cloud, пересчитан production ($175 вместо $225)
- Версия: `1.5` → `2.0 (v6)`

**Файл:** `README.md`

---

### Замечание 4: `__pycache__/` не в `.gitignore`
**Статус:** Исправлено

**Что было:** Файл `n8n-workflows/__pycache__/add-test-webhook.cpython-313.pyc` не был закоммичен, но `.gitignore` не содержал правил для Python-артефактов. При `git add -A` файл мог попасть в коммит.

**Что сделано:**
- Добавлены правила `__pycache__/` и `*.pyc` в `.gitignore`

**Файл:** `.gitignore`

---

### Замечание 5: Credential ID в JSON workflow
**Статус:** Принято к сведению, не исправлено

**Причина:** Это стандартное поведение n8n — при экспорте workflow credential references всегда включаются. При импорте на другой инстанс n8n предлагает переназначить credentials. Технически это не баг, а особенность платформы.

---

### Дополнительно: тест для weekly_plans
**Статус:** Добавлено в беклог

Рекомендация из аудита — добавить E2E тест для проверки генерации недельного плана. Записано в `docs/BACKLOG.md`.

---

## Дополнительные исправления после повторной проверки (9 февраля 2026)

### Исправление A: Синхронизация шаблона ключей с setup-гайдом
**Статус:** Исправлено

**Что было:** В `API-KEYS-TEMPLATE.env` оставался `SUPABASE_ANON_KEY`, хотя в `SETUP-GUIDE.md` уже используется `SUPABASE_SERVICE_ROLE_KEY`.

**Что сделано:**
- Переименован ключ в шаблоне: `SUPABASE_ANON_KEY` → `SUPABASE_SERVICE_ROLE_KEY`

**Файл:** `setup/API-KEYS-TEMPLATE.env`

---

### Исправление B: UTC-сдвиг даты в weekly-summary
**Статус:** Исправлено

**Что было:** `next_sunday` формировался через `toISOString().split('T')[0]` (UTC), что может дать смещение даты относительно локальной зоны сервера.

**Что сделано:**
- Добавлена локальная функция форматирования `localDateISO(d)` на базе `getFullYear/getMonth/getDate`
- `next_monday` и `next_sunday` теперь формируются в локальной дате, без UTC-сдвига

**Файл:** `n8n-workflows/workflow-weekly-summary.json`

---

## Диагностика после подключения к n8n + Supabase (2026-02-09, 18:24 UTC)

### Что подтверждено фактами

- В `Supabase` таблица `weekly_plans` пустая: `0` записей.
- Таблицы `training_strategies` и `trainings` заполняются корректно:
  - есть активная стратегия (`status=active`)
  - есть запись тренировки от `2026-02-09` с `avg_heart_rate=142`
- В main workflow на сервере ветка сохранения плана подключена:
  - `Send to Telegram` -> `Is Plan Generation?` -> `Save Plan`
  - то есть пользователь может получить план в Telegram, даже если запись в БД не произошла.

### Почему пока нет записи в `weekly_plans`

- Последние execution, которые мы просмотрели, были ДО деплоя фикса распознавания ответа `"да"` (workflow обновлён в `2026-02-09T18:05:02Z`).
- В этих execution `Save Plan` не запускался, потому что это были онбординг/профильные сообщения и ветка plan-generation туда не попадала.
- Следовательно, отсутствие записи в `weekly_plans` на текущем срезе объяснимо: после фикса ещё не было проверочного диалога "стратегия -> да -> запись плана".

### Дополнительный комментарий по полям БД

- Поля вроде `max_heart_rate` в `trainings` сейчас не всегда заполняются, потому что OCR/парсер часто даёт только средний пульс.
- Это не ошибка схемы: поле используется как опциональное и остаётся `null`, если источник не дал значение.

---

## Повторная проверка диалога и логики плана (2026-02-12)

### Что проверялось

- Реальная переписка пользователя в `chat_history`
- Сценарий mid-week:
  - `начинаем`
  - `эту неделю`
  - `с понедельника`
- Наличие и использование `preferred_training_days`

### Найденные проблемы

1. `начинаем` не попадало в ветку plan-request из-за regex `начн`.
2. `эту неделю` не распознавалось как запрос плана из-за `\b` в кириллическом шаблоне (`^эт[уаоой]\b`).
3. LLM-план на «эту неделю» периодически выходил за границы недели (добавлял понедельник/вторник следующей недели), несмотря на prompt-ограничения.

### Что исправлено

- Расширен regex plan-request:
  - `начн` -> `нач(?:н|ин)` (теперь ловит `начинаем`)
  - `^эт[уаоой]\b` -> `^эт[уаоой]` (корректно ловит `эту неделю`)
- Для сценария `mid-week + эту неделю` добавлена детерминированная ветка в `Prepare Data`:
  - не зависит от генерации LLM
  - строит план только на оставшиеся дни текущей недели
  - учитывает `preferred_training_days` через парсинг дней недели
  - формирует план с фиксированным форматом (тип, дистанция, темп, пульс, RPE)
- Workflow опубликован на сервер n8n (`7Ar459SadzSXgUEv`) после каждого фикса.

**Файлы:**
- `n8n-workflows/prepare-data-v6.js`
- `n8n-workflows/workflow-main-chatbot-v6.json`

### Результат ретеста

- `начинаем` -> бот корректно спрашивает выбор:
  - остаток текущей недели
  - или старт с понедельника
- `эту неделю` -> бот выдаёт план на даты `2026-02-12..2026-02-15`, без дней следующей недели
- `с понедельника` -> бот выдаёт полную неделю с понедельника
- `preferred_training_days` читаются из профиля и отражаются в логике выбора дней

### Остаточный риск

- `Save Plan` в `weekly_plans` падает при повторной генерации на ту же неделю:
  - ошибка `duplicate key value violates unique constraint "unique_user_week"`
  - ключ: `(user_id, week_start)`
- Нужен отдельный фикс upsert/update для `Save Plan` (сейчас нода делает `create`).

---

## Техдолг: идемпотентная запись недельного плана + контекст для генерации (2026-02-12)

### Что сделано

1. Закрыта проблема `unique_user_week` при повторной генерации:
   - добавлена нода `Delete Existing Plan` перед `Save Plan`
   - удаление идёт по `(user_id, week_start)` текущего целевого плана
   - после этого выполняется `Save Plan` (`create`)

2. Исправлена запись дат недели:
   - `Prepare Data` теперь выставляет `plan_week_start` / `plan_week_end`
   - `Extract Response` пробрасывает их дальше
   - `Save Plan` пишет `week_start/week_end` из `plan_week_start/plan_week_end` вместо `$now`

3. Усилен контекст планогенерации:
   - в prompt явно добавлено требование учитывать:
     - пульс покоя (`resting_hr`)
     - результаты тестирования (`vo2max`, `lthr`, `has_lab_testing`)
     - результаты текущих тренировок пользователя за неделю

### Обновлённые файлы

- `n8n-workflows/prepare-data-v6.js`
- `n8n-workflows/workflow-main-chatbot-v6.json`

### Зачем это важно

- План на одну и ту же неделю теперь можно пересоздавать без падения на unique constraint.
- Неделя сохраняется корректно для сценариев:
  - остаток текущей недели
  - следующая полная неделя с понедельника
- В генерацию плана принудительно включены все ключевые данные онбординга и свежие тренировочные факты.
