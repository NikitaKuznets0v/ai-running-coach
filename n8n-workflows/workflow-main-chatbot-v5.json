{
    "updatedAt": "2026-02-06T23:32:39.651Z",
    "createdAt": "2026-02-03T14:16:53.371Z",
    "id": "7Ar459SadzSXgUEv",
    "name": "AI Running Coach - Main Chatbot v5 (Photo + Stats)",
    "description": null,
    "active": true,
    "isArchived": false,
    "nodes": [
        {
            "id": "telegram-trigger",
            "parameters": {
                "updates": [
                    "message"
                ],
                "additionalFields": {}
            },
            "name": "TelegramTrigger",
            "type": "n8n-nodes-base.telegramTrigger",
            "typeVersion": 1.2,
            "position": [
                240,
                400
            ],
            "credentials": {
                "telegramApi": {
                    "id": "SLNhx6dJUSPFBV35",
                    "name": "Telegram Bot - Running Coach"
                }
            }
        },
        {
            "id": "extract-message",
            "parameters": {
                "functionCode": "const msg = items[0].json.message;\n\n// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ\nlet messageType = 'text';\nlet photoFileId = null;\nlet photoCaption = '';\n\nif (msg.photo && msg.photo.length > 0) {\n  messageType = 'photo';\n  // Ð‘ÐµÑ€Ñ‘Ð¼ Ñ„Ð¾Ñ‚Ð¾ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐµ Ð² Ð¼Ð°ÑÑÐ¸Ð²Ðµ)\n  photoFileId = msg.photo[msg.photo.length - 1].file_id;\n  photoCaption = msg.caption || '';\n}\n\nreturn [{\n  json: {\n    telegram_id: msg.from.id,\n    chat_id: msg.chat.id,\n    username: msg.from.username || '',\n    first_name: msg.from.first_name || 'Ð”Ñ€ÑƒÐ³',\n    last_name: msg.from.last_name || '',\n    message_text: msg.text || photoCaption || '',\n    message_id: msg.message_id,\n    message_type: messageType,\n    photo_file_id: photoFileId\n  }\n}];"
            },
            "name": "Extract Message",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                440,
                400
            ]
        },
        {
            "id": "get-user",
            "parameters": {
                "operation": "getAll",
                "tableId": "users",
                "returnAll": false,
                "limit": 1,
                "filterType": "manual",
                "matchType": "allFilters",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "telegram_id",
                            "condition": "eq",
                            "keyValue": "={{ $json.telegram_id }}"
                        }
                    ]
                }
            },
            "name": "Get User",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                640,
                400
            ],
            "alwaysOutputData": true,
            "credentials": {
                "supabaseApi": {
                    "id": "CJ3Z1MvRt6BxblaB",
                    "name": "Supabase - Running Coach"
                }
            }
        },
        {
            "id": "check-user",
            "parameters": {
                "functionCode": "const messageData = $('Extract Message').first().json;\n\nif (items.length === 0 || !items[0].json || !items[0].json.id) {\n  return [{\n    json: {\n      userExists: false,\n      telegram_id: messageData.telegram_id,\n      chat_id: messageData.chat_id,\n      username: messageData.username,\n      first_name: messageData.first_name,\n      last_name: messageData.last_name,\n      message_text: messageData.message_text,\n      message_id: messageData.message_id,\n      message_type: messageData.message_type,\n      photo_file_id: messageData.photo_file_id\n    }\n  }];\n} else {\n  const userData = items[0].json;\n  return [{\n    json: {\n      userExists: true,\n      user_id: userData.id,\n      telegram_id: userData.telegram_id,\n      first_name: userData.first_name || messageData.first_name,\n      onboarding_stage: userData.onboarding_stage || 'started',\n      level: userData.level,\n      age: userData.age,\n      height_cm: userData.height_cm,\n      weight_kg: userData.weight_kg,\n      weekly_runs: userData.weekly_runs,\n      goal: userData.goal,\n      current_5k_pace_seconds: userData.current_5k_pace_seconds,\n      race_date: userData.race_date,\n      race_distance: userData.race_distance,\n      target_time_seconds: userData.target_time_seconds,\n      resting_hr: userData.resting_hr,\n      max_hr: userData.max_hr,\n      has_lab_testing: userData.has_lab_testing,\n      vo2max: userData.vo2max,\n      lthr: userData.lthr,\n      hr_zone1_max: userData.hr_zone1_max,\n      hr_zone2_max: userData.hr_zone2_max,\n      hr_zone3_max: userData.hr_zone3_max,\n      hr_zone4_max: userData.hr_zone4_max,\n      hr_zone5_max: userData.hr_zone5_max,\n      chat_id: messageData.chat_id,\n      message_text: messageData.message_text,\n      message_id: messageData.message_id,\n      message_type: messageData.message_type,\n      photo_file_id: messageData.photo_file_id\n    }\n  }];\n}"
            },
            "name": "Check User",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                840,
                400
            ]
        },
        {
            "id": "show-typing",
            "parameters": {
                "operation": "sendChatAction",
                "chatId": "={{ $json.chat_id.toString() }}",
                "action": "typing"
            },
            "name": "Show Typing",
            "type": "n8n-nodes-base.telegram",
            "typeVersion": 1.2,
            "position": [
                1040,
                400
            ],
            "credentials": {
                "telegramApi": {
                    "id": "SLNhx6dJUSPFBV35",
                    "name": "Telegram Bot - Running Coach"
                }
            }
        },
        {
            "id": "route-after-typing",
            "parameters": {
                "functionCode": "const data = $('Check User').first().json;\nreturn [{json: data}];"
            },
            "name": "Route After Typing",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                1240,
                400
            ]
        },
        {
            "id": "is-photo",
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "photo-check",
                            "leftValue": "={{ $json.message_type }}",
                            "rightValue": "photo",
                            "operator": {
                                "type": "string",
                                "operation": "equals"
                            }
                        },
                        {
                            "id": "completed-check",
                            "leftValue": "={{ $json.onboarding_stage }}",
                            "rightValue": "completed",
                            "operator": {
                                "type": "string",
                                "operation": "equals"
                            }
                        }
                    ],
                    "combinator": "and"
                }
            },
            "name": "Is Photo?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                1440,
                400
            ]
        },
        {
            "id": "parse-vision-response",
            "parameters": {
                "functionCode": "const checkUserData = $('Check User').first().json;\nconst visionResponse = items[0].json;\nconst aiContent = visionResponse.choices[0].message.content;\n\nlet parsed;\ntry {\n  parsed = JSON.parse(aiContent);\n} catch (e) {\n  parsed = {\n    recognized: false,\n    response: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ñ„Ð¾Ñ‚Ð¾. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÐµÑ‰Ñ‘ Ñ€Ð°Ð· Ð¸Ð»Ð¸ Ð½Ð°Ð¿Ð¸ÑˆÐ¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼.'\n  };\n}\n\n// ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Telegram\nlet responseText = parsed.response || 'Ð¤Ð¾Ñ‚Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾';\nresponseText = responseText\n  .replace(/\\*/g, 'â€¢')\n  .replace(/_/g, ' ')\n  .replace(/`/g, \"'\")\n  .replace(/\\[/g, '(')\n  .replace(/\\]/g, ')');\n\nreturn [{\n  json: {\n    user_id: checkUserData.user_id,\n    chat_id: checkUserData.chat_id,\n    message_id: checkUserData.message_id,\n    recognized: parsed.recognized || false,\n    confidence: parsed.confidence || 'low',\n    training_data: parsed.data || null,\n    source_app: parsed.source_app || null,\n    response_text: responseText,\n    is_photo_training: true\n  }\n}];"
            },
            "name": "Parse Vision Response",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                2240,
                200
            ]
        },
        {
            "id": "is-training-recognized",
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "recognized-check",
                            "leftValue": "={{ $json.recognized }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "equals"
                            }
                        }
                    ],
                    "combinator": "and"
                }
            },
            "name": "Training Recognized?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                2440,
                200
            ]
        },
        {
            "id": "save-photo-training",
            "parameters": {
                "operation": "create",
                "tableId": "trainings",
                "dataToSend": "defineBelow",
                "fieldsUi": {
                    "fieldValues": [
                        {
                            "fieldId": "user_id",
                            "fieldValue": "={{ $json.user_id }}"
                        },
                        {
                            "fieldId": "date",
                            "fieldValue": "={{ $now.format('yyyy-MM-dd') }}"
                        },
                        {
                            "fieldId": "day_of_week",
                            "fieldValue": "={{ $now.format('EEEE').toLowerCase() }}"
                        },
                        {
                            "fieldId": "type",
                            "fieldValue": "={{ $json.training_data.type || 'easy_run' }}"
                        },
                        {
                            "fieldId": "distance_km",
                            "fieldValue": "={{ $json.training_data.distance_km }}"
                        },
                        {
                            "fieldId": "duration_seconds",
                            "fieldValue": "={{ $json.training_data.duration_seconds }}"
                        },
                        {
                            "fieldId": "avg_pace_seconds",
                            "fieldValue": "={{ $json.training_data.avg_pace_seconds }}"
                        },
                        {
                            "fieldId": "avg_heart_rate",
                            "fieldValue": "={{ $json.training_data.avg_heart_rate }}"
                        },
                        {
                            "fieldId": "max_heart_rate",
                            "fieldValue": "={{ $json.training_data.max_heart_rate }}"
                        },
                        {
                            "fieldId": "calories",
                            "fieldValue": "={{ $json.training_data.calories }}"
                        },
                        {
                            "fieldId": "elevation_gain_m",
                            "fieldValue": "={{ $json.training_data.elevation_gain_m }}"
                        },
                        {
                            "fieldId": "source",
                            "fieldValue": "screenshot"
                        },
                        {
                            "fieldId": "is_planned",
                            "fieldValue": "={{ false }}"
                        }
                    ]
                }
            },
            "name": "Save Photo Training",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                2640,
                100
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "CJ3Z1MvRt6BxblaB",
                    "name": "Supabase - Running Coach"
                }
            }
        },
        {
            "id": "format-photo-response",
            "parameters": {
                "functionCode": "const parseData = $('Parse Vision Response').first().json;\nconst td = parseData.training_data || {};\n\nconst formatPace = (s) => {\n  if (!s) return 'Ð½/Ð´';\n  return Math.floor(s/60) + ':' + String(s % 60).padStart(2, '0');\n};\n\nlet text = 'ðŸ“ Ð¢Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð·Ð°Ð¿Ð¸ÑÐ°Ð½Ð°!\\n\\n';\ntext += 'â€¢ Ð”Ð¸ÑÑ‚Ð°Ð½Ñ†Ð¸Ñ: ' + (td.distance_km || 'Ð½/Ð´') + ' ÐºÐ¼\\n';\ntext += 'â€¢ Ð’Ñ€ÐµÐ¼Ñ: ' + (td.duration_seconds ? Math.floor(td.duration_seconds/60) + ' Ð¼Ð¸Ð½' : 'Ð½/Ð´') + '\\n';\ntext += 'â€¢ Ð¢ÐµÐ¼Ð¿: ' + formatPace(td.avg_pace_seconds) + '/ÐºÐ¼\\n';\nif (td.avg_heart_rate) text += 'â€¢ ÐŸÑƒÐ»ÑŒÑ: ' + td.avg_heart_rate + ' ÑƒÐ´/Ð¼Ð¸Ð½\\n';\nif (td.calories) text += 'â€¢ ÐšÐ°Ð»Ð¾Ñ€Ð¸Ð¸: ' + td.calories + '\\n';\nif (td.elevation_gain_m) text += 'â€¢ ÐÐ°Ð±Ð¾Ñ€ Ð²Ñ‹ÑÐ¾Ñ‚Ñ‹: ' + td.elevation_gain_m + ' Ð¼\\n';\ntext += '\\nðŸ’ª ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°!';\n\nreturn [{\n  json: {\n    chat_id: parseData.chat_id,\n    response_text: text\n  }\n}];"
            },
            "name": "Format Photo Response",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                2840,
                100
            ]
        },
        {
            "id": "send-photo-response",
            "parameters": {
                "operation": "sendMessage",
                "chatId": "={{ $json.chat_id.toString() }}",
                "text": "={{ $json.response_text }}",
                "additionalFields": {
                    "appendAttribution": false
                }
            },
            "name": "Send Photo Response",
            "type": "n8n-nodes-base.telegram",
            "typeVersion": 1.2,
            "position": [
                3040,
                100
            ],
            "credentials": {
                "telegramApi": {
                    "id": "SLNhx6dJUSPFBV35",
                    "name": "Telegram Bot - Running Coach"
                }
            }
        },
        {
            "id": "send-not-recognized",
            "parameters": {
                "operation": "sendMessage",
                "chatId": "={{ $json.chat_id.toString() }}",
                "text": "={{ $json.response_text }}",
                "additionalFields": {
                    "appendAttribution": false
                }
            },
            "name": "Send Not Recognized",
            "type": "n8n-nodes-base.telegram",
            "typeVersion": 1.2,
            "position": [
                2640,
                300
            ],
            "credentials": {
                "telegramApi": {
                    "id": "SLNhx6dJUSPFBV35",
                    "name": "Telegram Bot - Running Coach"
                }
            }
        },
        {
            "id": "user-not-found",
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "c1",
                            "leftValue": "={{ $json.userExists }}",
                            "rightValue": false,
                            "operator": {
                                "type": "boolean",
                                "operation": "equals"
                            }
                        }
                    ],
                    "combinator": "and"
                }
            },
            "name": "User Not Found?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                1640,
                500
            ]
        },
        {
            "id": "create-user",
            "parameters": {
                "operation": "create",
                "tableId": "users",
                "dataToSend": "defineBelow",
                "fieldsUi": {
                    "fieldValues": [
                        {
                            "fieldId": "telegram_id",
                            "fieldValue": "={{ $json.telegram_id }}"
                        },
                        {
                            "fieldId": "username",
                            "fieldValue": "={{ $json.username }}"
                        },
                        {
                            "fieldId": "first_name",
                            "fieldValue": "={{ $json.first_name }}"
                        },
                        {
                            "fieldId": "last_name",
                            "fieldValue": "={{ $json.last_name }}"
                        },
                        {
                            "fieldId": "onboarding_stage",
                            "fieldValue": "started"
                        },
                        {
                            "fieldId": "language",
                            "fieldValue": "ru"
                        }
                    ]
                }
            },
            "name": "Create User",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                1840,
                400
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "CJ3Z1MvRt6BxblaB",
                    "name": "Supabase - Running Coach"
                }
            }
        },
        {
            "id": "get-user-again",
            "parameters": {
                "operation": "getAll",
                "tableId": "users",
                "returnAll": false,
                "limit": 1,
                "filterType": "manual",
                "matchType": "allFilters",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "telegram_id",
                            "condition": "eq",
                            "keyValue": "={{ $('Check User').first().json.telegram_id }}"
                        }
                    ]
                }
            },
            "name": "Get User Again",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                2040,
                400
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "CJ3Z1MvRt6BxblaB",
                    "name": "Supabase - Running Coach"
                }
            }
        },
        {
            "id": "prepare-new-user",
            "parameters": {
                "functionCode": "const messageData = $('Check User').first().json;\nconst userData = items[0].json;\nreturn [{\n  json: {\n    userExists: true,\n    user_id: userData.id,\n    first_name: userData.first_name || messageData.first_name,\n    onboarding_stage: userData.onboarding_stage || 'started',\n    chat_id: messageData.chat_id,\n    message_text: messageData.message_text,\n    message_id: messageData.message_id,\n    active_plan: null,\n    recent_trainings: []\n  }\n}];"
            },
            "name": "Prepare New User Data",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                2240,
                400
            ]
        },
        {
            "id": "get-active-plan",
            "parameters": {
                "operation": "getAll",
                "tableId": "weekly_plans",
                "returnAll": false,
                "limit": 1,
                "filterType": "manual",
                "matchType": "allFilters",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "user_id",
                            "condition": "eq",
                            "keyValue": "={{ $('Check User').first().json.user_id }}"
                        },
                        {
                            "keyName": "status",
                            "condition": "eq",
                            "keyValue": "active"
                        }
                    ]
                },
                "options": {
                    "orderByColumn": "created_at",
                    "orderType": "desc"
                }
            },
            "name": "Get Active Plan",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                1840,
                600
            ],
            "alwaysOutputData": true,
            "credentials": {
                "supabaseApi": {
                    "id": "CJ3Z1MvRt6BxblaB",
                    "name": "Supabase - Running Coach"
                }
            }
        },
        {
            "id": "get-recent-trainings",
            "parameters": {
                "operation": "getAll",
                "tableId": "trainings",
                "returnAll": false,
                "limit": 10,
                "filterType": "manual",
                "matchType": "allFilters",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "user_id",
                            "condition": "eq",
                            "keyValue": "={{ $('Check User').first().json.user_id }}"
                        }
                    ]
                },
                "options": {
                    "orderByColumn": "date",
                    "orderType": "desc"
                }
            },
            "name": "Get Recent Trainings",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                2040,
                600
            ],
            "alwaysOutputData": true,
            "credentials": {
                "supabaseApi": {
                    "id": "CJ3Z1MvRt6BxblaB",
                    "name": "Supabase - Running Coach"
                }
            }
        },
        {
            "id": "merge-context",
            "parameters": {
                "functionCode": "const checkUserData = $('Check User').first().json;\nconst planItems = $('Get Active Plan').all();\nconst trainingItems = $('Get Recent Trainings').all();\nconst strategyItems = items;\n\nlet activePlan = null;\nif (planItems.length > 0 && planItems[0].json && planItems[0].json.id) {\n  activePlan = planItems[0].json;\n}\n\nlet recentTrainings = [];\nif (trainingItems.length > 0) {\n  recentTrainings = trainingItems.map(t => t.json).filter(t => t && t.id);\n}\n\nlet activeStrategy = null;\nif (strategyItems.length > 0 && strategyItems[0].json && strategyItems[0].json.id) {\n  activeStrategy = strategyItems[0].json;\n}\n\nreturn [{\n  json: {\n    ...checkUserData,\n    active_plan: activePlan,\n    recent_trainings: recentTrainings,\n    active_strategy: activeStrategy\n  }\n}];"
            },
            "name": "Merge Context",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                2340,
                600
            ]
        },
        {
            "id": "merge-flows",
            "parameters": {
                "mode": "append",
                "options": {}
            },
            "name": "Merge User Flows",
            "type": "n8n-nodes-base.merge",
            "typeVersion": 3,
            "position": [
                2440,
                500
            ]
        },
        {
            "id": "prepare-data",
            "parameters": {
                "functionCode": "const data = items[0].json;\nconst message = data.message_text;\nconst stage = data.onboarding_stage || 'started';\nconst firstName = data.first_name || 'Ð´Ñ€ÑƒÐ³';\n\nlet systemPrompt = '';\nlet nextStage = stage;\nlet isPlanGeneration = false;\n\nconst JSON_FORMAT = 'ÐžÑ‚Ð²ÐµÑ‚ÑŒ JSON: {\"extracted\": {...}, \"response\": \"Ñ‚ÐµÐºÑÑ‚\"}. ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ * _ ` [ ]';\n\nconst formatPace = (sec) => {\n  if (!sec) return 'Ð½/Ð´';\n  return Math.floor(sec/60) + ':' + (sec%60).toString().padStart(2,'0');\n};\n\n// ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº\nlet trainingsContext = '';\nconst trainings = data.recent_trainings || [];\nif (trainings.length > 0) {\n  trainingsContext = '\\n\\nÐ£ ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¯ Ð•Ð¡Ð¢Ð¬ ' + trainings.length + ' Ð—ÐÐŸÐ˜Ð¡ÐÐÐÐ«Ð¥ Ð¢Ð Ð•ÐÐ˜Ð ÐžÐ’ÐžÐš:\\n';\n  trainings.slice(0, 10).forEach(t => {\n    trainingsContext += 'â€¢ ' + t.date + ': ' + (t.distance_km || '?') + ' ÐºÐ¼';\n    if (t.duration_seconds) trainingsContext += ', ' + Math.round(t.duration_seconds/60) + ' Ð¼Ð¸Ð½';\n    if (t.avg_pace_seconds) trainingsContext += ', Ñ‚ÐµÐ¼Ð¿ ' + formatPace(t.avg_pace_seconds) + '/ÐºÐ¼';\n    if (t.avg_heart_rate) trainingsContext += ', Ð¿ÑƒÐ»ÑŒÑ ' + t.avg_heart_rate;\n    if (t.type) trainingsContext += ' (' + t.type + ')';\n    trainingsContext += '\\n';\n  });\n} else {\n  trainingsContext = '\\n\\nÐ¢Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð¿Ð¾ÐºÐ° Ð½Ðµ Ð·Ð°Ð¿Ð¸ÑÐ°Ð½Ð¾.\\n';\n}\n\n// ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð¿Ð»Ð°Ð½Ð°\nlet planContext = '';\nif (data.active_plan && data.active_plan.plan_data) {\n  try {\n    const pd = typeof data.active_plan.plan_data === 'string' ? JSON.parse(data.active_plan.plan_data) : data.active_plan.plan_data;\n    planContext = '\\nÐÐšÐ¢Ð˜Ð’ÐÐ«Ð™ ÐŸÐ›ÐÐ: ' + (pd.raw_plan || '').substring(0, 500);\n  } catch(e) {}\n}\n\n// ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¸\nlet strategyContext = '';\nlet currentPhase = null;\nif (data.active_strategy && data.active_strategy.phases) {\n  try {\n    const strategy = data.active_strategy;\n    const phases = typeof strategy.phases === 'string' ? JSON.parse(strategy.phases) : strategy.phases;\n    const startDate = new Date(strategy.start_date);\n    const now = new Date();\n    const weeksSinceStart = Math.max(1, Math.ceil((now - startDate) / (7 * 24 * 60 * 60 * 1000)));\n\n    for (const phase of phases) {\n      if (weeksSinceStart >= phase.start_week && weeksSinceStart <= phase.end_week) {\n        currentPhase = phase;\n        break;\n      }\n    }\n\n    strategyContext = '\\n\\nÐ¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯ ÐŸÐžÐ”Ð“ÐžÐ¢ÐžÐ’ÐšÐ˜:';\n    strategyContext += '\\nâ€¢ Ð¦ÐµÐ»ÑŒ: ' + (strategy.race_distance || '') + (strategy.race_date ? ' (' + strategy.race_date + ')' : '');\n    strategyContext += '\\nâ€¢ Ð’ÑÐµÐ³Ð¾ Ð½ÐµÐ´ÐµÐ»ÑŒ: ' + strategy.total_weeks + ', Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ Ð½ÐµÐ´ÐµÐ»Ñ: ' + weeksSinceStart;\n    if (currentPhase) {\n      strategyContext += '\\nâ€¢ Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ñ„Ð°Ð·Ð°: ' + currentPhase.display_name + ' (Ð½ÐµÐ´. ' + currentPhase.start_week + '-' + currentPhase.end_week + ')';\n      strategyContext += '\\nâ€¢ Ð¤Ð¾ÐºÑƒÑ: ' + currentPhase.focus;\n      strategyContext += '\\nâ€¢ ÐžÐ±ÑŠÑ‘Ð¼: ' + currentPhase.target_weekly_km_min + '-' + currentPhase.target_weekly_km_max + ' ÐºÐ¼/Ð½ÐµÐ´';\n      strategyContext += '\\nâ€¢ ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸: ' + (currentPhase.key_workouts || []).join(', ');\n    }\n    strategyContext += '\\nâ€¢ Ð’ÑÐµ Ñ„Ð°Ð·Ñ‹: ';\n    phases.forEach(p => {\n      const isCurrent = (currentPhase && p.name === currentPhase.name) ? ' [Ð¢Ð•ÐšÐ£Ð©ÐÐ¯]' : '';\n      strategyContext += p.display_name + ' (Ð½ÐµÐ´.' + p.start_week + '-' + p.end_week + ')' + isCurrent + ', ';\n    });\n    strategyContext += '\\n';\n  } catch(e) {\n    strategyContext = '';\n  }\n}\n\nif (stage !== 'completed') {\n  // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð´Ð»Ñ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°\n  const profileInfo = 'Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: '\n    + (data.race_distance ? 'Ð´Ð¸ÑÑ‚Ð°Ð½Ñ†Ð¸Ñ=' + data.race_distance + ', ' : '')\n    + (data.race_date ? 'Ð´Ð°Ñ‚Ð°=' + data.race_date + ', ' : '')\n    + (data.target_time_seconds ? 'Ñ†ÐµÐ»ÑŒ=' + data.target_time_seconds + 'ÑÐµÐº, ' : '')\n    + (data.weekly_runs ? 'Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº/Ð½ÐµÐ´=' + data.weekly_runs + ', ' : '')\n    + (data.level ? 'ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ=' + data.level : '');\n\n  const prompts = {\n    'started': 'ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐ¹ ' + firstName + '. ÐŸÑ€ÐµÐ´ÑÑ‚Ð°Ð²ÑŒÑÑ AI-Ñ‚Ñ€ÐµÐ½ÐµÑ€Ð¾Ð¼ Ð¿Ð¾ Ð±ÐµÐ³Ñƒ. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ: Ð½Ð¾Ð²Ð¸Ñ‡Ð¾Ðº/Ð»ÑŽÐ±Ð¸Ñ‚ÐµÐ»ÑŒ/Ð¿Ñ€Ð¾Ð´Ð²Ð¸Ð½ÑƒÑ‚Ñ‹Ð¹. ' + JSON_FORMAT,\n    'profile': 'ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸ level: beginner/intermediate/advanced. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚. ' + JSON_FORMAT + ' extracted: {level: ...}',\n    'physical': 'Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ age. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ñ€Ð¾ÑÑ‚ Ð¸ Ð²ÐµÑ. ' + JSON_FORMAT + ' extracted: {age: Ñ‡Ð¸ÑÐ»Ð¾}',\n    'heart_rate': 'Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ height_cm, weight_kg. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ð¿ÑƒÐ»ÑŒÑ Ð¿Ð¾ÐºÐ¾Ñ. ' + JSON_FORMAT + ' extracted: {height_cm, weight_kg}',\n    'running_info': 'Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ resting_hr. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ñ‚ÐµÐ¼Ð¿ Ð½Ð° 5ÐºÐ¼. ' + JSON_FORMAT + ' extracted: {resting_hr}',\n    'lab_testing': 'Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ current_5k_pace_seconds (Ñ‚ÐµÐ¼Ð¿ Ð² ÑÐµÐº/ÐºÐ¼). Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ð¿Ñ€Ð¾ VO2max Ñ‚ÐµÑÑ‚. ' + JSON_FORMAT + ' extracted: {current_5k_pace_seconds}',\n    'training_freq': 'Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ has_lab_testing. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ð´Ð½ÐµÐ¹ Ð² Ð½ÐµÐ´ÐµÐ»ÑŽ (3-6). ' + JSON_FORMAT + ' extracted: {has_lab_testing, vo2max?, lthr?}',\n    'race_details': 'Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ weekly_runs (Ñ‡Ð¸ÑÐ»Ð¾). Ð¢Ð°ÐºÐ¶Ðµ ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐºÐ°Ð·Ð°Ð» Ð´Ð¸ÑÑ‚Ð°Ð½Ñ†Ð¸ÑŽ/Ð´Ð°Ñ‚Ñƒ/Ñ†ÐµÐ»ÑŒ Ð·Ð°Ð±ÐµÐ³Ð° - Ð¸Ð·Ð²Ð»ÐµÐºÐ¸ Ð¸Ñ… Ñ‚Ð¾Ð¶Ðµ. '\n      + 'Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ð´Ð¸ÑÑ‚Ð°Ð½Ñ†Ð¸ÑŽ Ð·Ð°Ð±ÐµÐ³Ð°, Ð´Ð°Ñ‚Ñƒ, Ñ†ÐµÐ»ÐµÐ²Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ. '\n      + 'Ð’ ÐºÐ¾Ð½Ñ†Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° ÑÐºÐ°Ð¶Ð¸: \"ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾! Ð¡ÐµÐ¹Ñ‡Ð°Ñ ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÑŽ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸ÑŽ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸!\" '\n      + JSON_FORMAT + ' extracted: {weekly_runs, race_distance: 5k/10k/half/marathon, race_date: YYYY-MM-DD, target_time_seconds: Ñ‡Ð¸ÑÐ»Ð¾}',\n    'strategy_preview': profileInfo + '\\n\\n'\n      + 'Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—Ð£Ð™ Ð”ÐÐÐÐ«Ð• ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¯ Ð’Ð«Ð¨Ð•. Ð•ÑÐ»Ð¸ Ð² ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ ÐµÑÑ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¸Ñ….\\n\\n'\n      + 'Ð¡Ð“Ð•ÐÐ•Ð Ð˜Ð Ð£Ð™ Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð® ÐŸÐžÐ”Ð“ÐžÐ¢ÐžÐ’ÐšÐ˜ Ðš Ð—ÐÐ‘Ð•Ð“Ð£.\\n\\n'\n      + 'Ð˜ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð˜Ð˜:\\n'\n      + '1. Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ð¹ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð½ÐµÐ´ÐµÐ»ÑŒ Ð¾Ñ‚ ÑÐµÐ³Ð¾Ð´Ð½Ñ (' + new Date().toISOString().split('T')[0] + ') Ð´Ð¾ Ð´Ð°Ñ‚Ñ‹ Ð·Ð°Ð±ÐµÐ³Ð°\\n'\n      + '2. Ð Ð°Ð·Ð´ÐµÐ»Ð¸ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÑƒ Ð½Ð° 4 Ñ„Ð°Ð·Ñ‹:\\n'\n      + '   - base (Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´): ~30% Ð½ÐµÐ´ÐµÐ»ÑŒ\\n'\n      + '   - development (Ð Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ): ~30% Ð½ÐµÐ´ÐµÐ»ÑŒ\\n'\n      + '   - specialization (Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ): ~25% Ð½ÐµÐ´ÐµÐ»ÑŒ\\n'\n      + '   - taper (ÐŸÐ¾Ð´Ð²Ð¾Ð´ÐºÐ°): ~15% Ð½ÐµÐ´ÐµÐ»ÑŒ (Ð¼Ð¸Ð½ 1, Ð¼Ð°ÐºÑ 3)\\n'\n      + '3. Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ñ„Ð°Ð·Ñ‹ Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ð¹: start_week, end_week, duration_weeks, focus, target_weekly_km_min, target_weekly_km_max, key_workouts, intensity_distribution\\n\\n'\n      + 'Ð¤ÐžÐ ÐœÐÐ¢ ÐžÐ¢Ð’Ð•Ð¢Ð Ð’ response (Ð¡Ð¢Ð ÐžÐ“Ðž Ð¡ÐžÐ‘Ð›Ð®Ð”ÐÐ™):\\n'\n      + 'ÐŸÐ¾ÐºÐ°Ð¶Ð¸ Ð¢ÐžÐ›Ð¬ÐšÐž Ð²Ñ‹ÑÐ¾ÐºÐ¾ÑƒÑ€Ð¾Ð²Ð½ÐµÐ²Ñ‹Ð¹ Ð¾Ð±Ð·Ð¾Ñ€ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¸ Ð¿Ð¾ Ñ„Ð°Ð·Ð°Ð¼.\\n'\n      + 'ÐÐ• ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ™ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð»Ð°Ð½ Ð½Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ! ÐÐ• Ñ€Ð°ÑÐ¿Ð¸ÑÑ‹Ð²Ð°Ð¹ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð¿Ð¾ Ð´Ð½ÑÐ¼!\\n'\n      + 'Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð°:\\n\\n'\n      + 'Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸ Ðº (Ð´Ð¸ÑÑ‚Ð°Ð½Ñ†Ð¸Ñ) (Ð´Ð°Ñ‚Ð° Ð·Ð°Ð±ÐµÐ³Ð°)\\n'\n      + 'Ð’ÑÐµÐ³Ð¾ N Ð½ÐµÐ´ÐµÐ»ÑŒ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸\\n\\n'\n      + 'Ð¤Ð°Ð·Ð° 1: ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ (Ð½ÐµÐ´ÐµÐ»Ð¸ X-Y, Z Ð½ÐµÐ´ÐµÐ»ÑŒ)\\n'\n      + 'Ð¤Ð¾ÐºÑƒÑ: Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð² 1 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸\\n'\n      + 'ÐžÐ±ÑŠÑ‘Ð¼: XX-YY ÐºÐ¼/Ð½ÐµÐ´\\n'\n      + 'ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸: Ð¿ÐµÑ€ÐµÑ‡Ð¸ÑÐ»Ð¸Ñ‚ÑŒ ÐºÑ€Ð°Ñ‚ÐºÐ¾\\n\\n'\n      + 'Ð¤Ð°Ð·Ð° 2: ...\\n'\n      + '(Ð¸ Ñ‚Ð°Ðº Ð´Ð°Ð»ÐµÐµ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ñ„Ð°Ð·Ñ‹)\\n\\n'\n      + 'Ð’ ÑÐ°Ð¼Ð¾Ð¼ ÐºÐ¾Ð½Ñ†Ðµ Ð½Ð°Ð¿Ð¸ÑˆÐ¸: ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼? Ð•ÑÐ»Ð¸ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¸Ñ‚, ÑÐºÐ°Ð¶Ð¸ Ð¸ Ñ ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÑŽ Ð¿Ð»Ð°Ð½ Ð½Ð° Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ!\\n\\n'\n      + 'ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ðµ Ñ‚Ð¸Ñ€Ðµ Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ¾Ð².\\n\\n'\n      + JSON_FORMAT + '\\n'\n      + 'extracted: { race_distance: \"' + (data.race_distance || 'half') + '\", race_date: \"' + (data.race_date || new Date(Date.now() + 16*7*24*60*60*1000).toISOString().split('T')[0]) + '\", target_time_seconds: ' + (data.target_time_seconds || 6300) + ', strategy_generated: true, total_weeks: Ñ‡Ð¸ÑÐ»Ð¾, strategy_summary: \"ÐºÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ\", phases: [{name, display_name, start_week, end_week, duration_weeks, focus, target_weekly_km_min, target_weekly_km_max, key_workouts: [\"Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ°1\", \"Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ°2\"], intensity_distribution: \"80/20 Ð¸Ð»Ð¸ Ð¿Ð¾Ð´Ð¾Ð±Ð½Ð¾Ðµ\"}] }'\n  };\n  systemPrompt = prompts[stage] || prompts['started'];\n  const nextStages = {started:'profile', profile:'physical', physical:'heart_rate', heart_rate:'running_info', running_info:'lab_testing', lab_testing:'training_freq', training_freq:'race_details', race_details:'strategy_preview', strategy_preview:'completed'};\n  nextStage = nextStages[stage] || stage;\n} else {\n  const isStrategyQuestion = /ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³|Ñ„Ð°Ð·[Ð°Ñ‹ÑƒÐµÐ¸]|Ð¿ÐµÑ€Ð¸Ð¾Ð´|ÑÑ‚Ð°Ð¿ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸|Ð¿Ð»Ð°Ð½ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸|ÐºÐ°Ðº.*Ð¸Ð´Ñƒ|Ð´Ð¾Ð»Ð³Ð¾ÑÑ€Ð¾Ñ‡|Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð².*Ð·Ð°Ð±ÐµÐ³/i.test(message);\n\n  if (isStrategyQuestion && data.active_strategy) {\n    systemPrompt = 'Ð¢Ñ‹ AI-Ñ‚Ñ€ÐµÐ½ÐµÑ€ Ð¿Ð¾ Ð±ÐµÐ³Ñƒ Ð´Ð»Ñ ' + firstName + '. ÐÐ• Ð·Ð´Ð¾Ñ€Ð¾Ð²Ð°Ð¹ÑÑ.'\n      + strategyContext + trainingsContext + planContext\n      + '\\n\\nÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ð¾ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¸: \"' + message + '\"'\n      + '\\n\\nÐžÑ‚Ð²ÐµÑ‚ÑŒ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ñ„Ð°Ð·Ðµ, Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐµ Ð¸ Ñ‡Ñ‚Ð¾ Ð²Ð¿ÐµÑ€ÐµÐ´Ð¸.'\n      + '\\n\\n' + JSON_FORMAT;\n  } else if (/Ð¿Ð»Ð°Ð½|ÑÐ¾ÑÑ‚Ð°Ð²|Ð´Ð°Ð²Ð°Ð¹|Ð½Ð°Ñ‡Ð½|Ð³Ð¾Ñ‚Ð¾Ð²|Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ðº|Ð½ÐµÐ´ÐµÐ»/i.test(message)) {\n    isPlanGeneration = true;\n    systemPrompt = 'AI-Ñ‚Ñ€ÐµÐ½ÐµÑ€ Ð´Ð»Ñ ' + firstName + '. Ð¡Ð¾ÑÑ‚Ð°Ð²ÑŒ Ð¿Ð»Ð°Ð½ Ð½Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ (' + (data.weekly_runs || 3) + ' Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº).'\n      + strategyContext + trainingsContext + planContext\n      + (currentPhase ? '\\n\\nÐ’ÐÐ–ÐÐž: ÐŸÐ»Ð°Ð½ Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¾Ð²Ð°Ñ‚ÑŒ Ð¢Ð•ÐšÐ£Ð©Ð•Ð™ Ð¤ÐÐ—Ð•: ' + currentPhase.display_name + '. Ð¤Ð¾ÐºÑƒÑ: ' + currentPhase.focus + '. ÐžÐ±ÑŠÑ‘Ð¼: ' + currentPhase.target_weekly_km_min + '-' + currentPhase.target_weekly_km_max + ' ÐºÐ¼.' : '')\n      + ' ' + JSON_FORMAT + ' extracted: {plan_generated: true, total_km: Ñ‡Ð¸ÑÐ»Ð¾}';\n  } else {\n    systemPrompt = 'Ð¢Ñ‹ AI-Ñ‚Ñ€ÐµÐ½ÐµÑ€ Ð¿Ð¾ Ð±ÐµÐ³Ñƒ Ð´Ð»Ñ ' + firstName + '. ÐÐ• Ð·Ð´Ð¾Ñ€Ð¾Ð²Ð°Ð¹ÑÑ.'\n      + strategyContext + trainingsContext + planContext\n      + '\\n\\nÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚: \"' + message + '\"'\n      + '\\n\\nÐŸÐ ÐÐ’Ð˜Ð›Ð ÐžÐ¢Ð’Ð•Ð¢Ð:\\n1. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð”ÐÐÐÐ«Ð• Ð¢Ð Ð•ÐÐ˜Ð ÐžÐ’ÐžÐš Ð²Ñ‹ÑˆÐµ'\n      + '\\n2. Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ - ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ñ„Ð°Ð·Ñƒ'\n      + '\\n3. Ð‘ÑƒÐ´ÑŒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼: ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ Ñ†Ð¸Ñ„Ñ€Ñ‹'\n      + '\\n4. Ð”Ð°Ð¹ ÐºÑ€Ð°Ñ‚ÐºÑƒÑŽ Ð¾Ñ†ÐµÐ½ÐºÑƒ Ð¸ ÑÐ¾Ð²ÐµÑ‚'\n      + '\\n\\n' + JSON_FORMAT;\n  }\n}\n\nreturn [{\n  json: {\n    user_id: data.user_id,\n    chat_id: data.chat_id,\n    message_text: message,\n    message_id: data.message_id,\n    system_prompt: systemPrompt,\n    onboarding_stage: stage,\n    next_stage: nextStage,\n    is_plan_generation: isPlanGeneration,\n    weekly_runs: data.weekly_runs\n  }\n}];"
            },
            "name": "Prepare Data",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                2640,
                500
            ]
        },
        {
            "id": "call-openai",
            "parameters": {
                "method": "POST",
                "url": "https://api.openai.com/v1/chat/completions",
                "authentication": "predefinedCredentialType",
                "nodeCredentialType": "openAiApi",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"model\": \"gpt-4o-mini\",\n  \"messages\": [\n    {\"role\": \"system\", \"content\": {{ JSON.stringify($json.system_prompt) }}},\n    {\"role\": \"user\", \"content\": {{ JSON.stringify($json.message_text) }}}\n  ],\n  \"temperature\": 0.7,\n  \"max_tokens\": 1500,\n  \"response_format\": {\"type\": \"json_object\"}\n}"
            },
            "name": "Call OpenAI",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                2840,
                500
            ],
            "credentials": {
                "openAiApi": {
                    "id": "koikxNcf4ds6vKgZ",
                    "name": "OpenAI - Running Coach"
                }
            }
        },
        {
            "id": "extract-response",
            "parameters": {
                "functionCode": "const response = items[0].json;\nconst prepareData = $('Prepare Data').first().json;\nconst aiContent = response.choices[0].message.content;\n\nlet extracted = {};\nlet responseText = aiContent;\n\ntry {\n  const parsed = JSON.parse(aiContent);\n  extracted = parsed.extracted || {};\n  responseText = parsed.response || aiContent;\n} catch (e) {}\n\nresponseText = responseText.replace(/\\*\\*(.+?)\\*\\*/g, '$1').replace(/\\*(.+?)\\*/g, '$1').replace(/_/g, ' ').replace(/`/g, \"'\").replace(/\\[/g, '(').replace(/\\]/g, ')');\n\nreturn [{\n  json: {\n    user_id: prepareData.user_id,\n    chat_id: prepareData.chat_id,\n    response_text: responseText,\n    onboarding_stage: prepareData.onboarding_stage,\n    next_stage: prepareData.next_stage,\n    extracted_data: extracted,\n    is_plan_generation: prepareData.is_plan_generation,\n    weekly_runs: prepareData.weekly_runs\n  }\n}];"
            },
            "name": "Extract Response",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                3040,
                500
            ]
        },
        {
            "id": "send-telegram",
            "parameters": {
                "operation": "sendMessage",
                "chatId": "={{ $json.chat_id.toString() }}",
                "text": "={{ $json.response_text }}",
                "additionalFields": {
                    "appendAttribution": false
                }
            },
            "name": "Send to Telegram",
            "type": "n8n-nodes-base.telegram",
            "typeVersion": 1.2,
            "position": [
                3240,
                500
            ],
            "credentials": {
                "telegramApi": {
                    "id": "SLNhx6dJUSPFBV35",
                    "name": "Telegram Bot - Running Coach"
                }
            }
        },
        {
            "id": "is-onboarding",
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "c1",
                            "leftValue": "={{ $('Extract Response').first().json.onboarding_stage }}",
                            "rightValue": "completed",
                            "operator": {
                                "type": "string",
                                "operation": "notEquals"
                            }
                        }
                    ],
                    "combinator": "and"
                }
            },
            "name": "Is Onboarding?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                3440,
                500
            ]
        },
        {
            "id": "build-update",
            "parameters": {
                "functionCode": "const data = $('Extract Response').first().json;\nconst ext = data.extracted_data || {};\nconst updateFields = {};\nlet nextStage = data.next_stage;\n\nif (data.onboarding_stage === 'started') updateFields.goal = 'race';\nif (data.onboarding_stage === 'strategy_preview' && ext.strategy_generated) nextStage = 'completed';\nif (nextStage && nextStage !== data.onboarding_stage) updateFields.onboarding_stage = nextStage;\n\n['level','age','height_cm','weight_kg','current_5k_pace_seconds','weekly_runs','race_distance','race_date','target_time_seconds','resting_hr','max_hr','has_lab_testing','vo2max','lthr'].forEach(k => { if (ext[k] !== undefined) updateFields[k] = ext[k]; });\n\nreturn [{\n  json: {\n    user_id: data.user_id,\n    update_fields: updateFields,\n    has_updates: Object.keys(updateFields).length > 0,\n    is_strategy_stage: data.onboarding_stage === 'strategy_preview' && ext.strategy_generated === true\n  }\n}];"
            },
            "name": "Build Update Data",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                3640,
                400
            ]
        },
        {
            "id": "has-updates",
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "c1",
                            "leftValue": "={{ $json.has_updates }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "equals"
                            }
                        }
                    ],
                    "combinator": "and"
                }
            },
            "name": "Has Updates?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                3840,
                400
            ]
        },
        {
            "id": "update-user",
            "parameters": {
                "operation": "update",
                "tableId": "users",
                "filterType": "manual",
                "matchType": "allFilters",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "id",
                            "condition": "eq",
                            "keyValue": "={{ $json.user_id }}"
                        }
                    ]
                },
                "dataToSend": "defineBelow",
                "fieldsUi": {
                    "fieldValues": [
                        {
                            "fieldId": "onboarding_stage",
                            "fieldValue": "={{ $json.update_fields.onboarding_stage }}"
                        },
                        {
                            "fieldId": "level",
                            "fieldValue": "={{ $json.update_fields.level }}"
                        },
                        {
                            "fieldId": "age",
                            "fieldValue": "={{ $json.update_fields.age }}"
                        },
                        {
                            "fieldId": "weekly_runs",
                            "fieldValue": "={{ $json.update_fields.weekly_runs }}"
                        },
                        {
                            "fieldId": "race_date",
                            "fieldValue": "={{ $json.update_fields.race_date }}"
                        },
                        {
                            "fieldId": "race_distance",
                            "fieldValue": "={{ $json.update_fields.race_distance }}"
                        },
                        {
                            "fieldId": "resting_hr",
                            "fieldValue": "={{ $json.update_fields.resting_hr }}"
                        }
                    ]
                }
            },
            "name": "Update User Profile",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                4040,
                300
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "CJ3Z1MvRt6BxblaB",
                    "name": "Supabase - Running Coach"
                }
            }
        },
        {
            "id": "is-plan-gen",
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "c1",
                            "leftValue": "={{ $('Extract Response').first().json.is_plan_generation }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "equals"
                            }
                        }
                    ],
                    "combinator": "and"
                }
            },
            "name": "Is Plan Generation?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                3640,
                600
            ]
        },
        {
            "id": "save-plan",
            "parameters": {
                "operation": "create",
                "tableId": "weekly_plans",
                "dataToSend": "defineBelow",
                "fieldsUi": {
                    "fieldValues": [
                        {
                            "fieldId": "user_id",
                            "fieldValue": "={{ $('Extract Response').first().json.user_id }}"
                        },
                        {
                            "fieldId": "week_start",
                            "fieldValue": "={{ $now.format('yyyy-MM-dd') }}"
                        },
                        {
                            "fieldId": "plan_data",
                            "fieldValue": "={{ JSON.stringify({raw_plan: $('Extract Response').first().json.response_text}) }}"
                        },
                        {
                            "fieldId": "status",
                            "fieldValue": "active"
                        }
                    ]
                }
            },
            "name": "Save Plan",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                3840,
                600
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "CJ3Z1MvRt6BxblaB",
                    "name": "Supabase - Running Coach"
                }
            }
        },
        {
            "id": "download-photo-telegram",
            "parameters": {
                "resource": "file",
                "operation": "get",
                "fileId": "={{ $(\"Check User\").first().json.photo_file_id }}",
                "download": true
            },
            "name": "Download Photo",
            "type": "n8n-nodes-base.telegram",
            "typeVersion": 1.2,
            "position": [
                1640,
                200
            ],
            "credentials": {
                "telegramApi": {
                    "id": "SLNhx6dJUSPFBV35",
                    "name": "Telegram Bot - Running Coach"
                }
            }
        },
        {
            "id": "move-binary-to-json",
            "parameters": {
                "mode": "binaryToJson",
                "setAllData": false,
                "sourceKey": "data",
                "destinationKey": "base64_image",
                "options": {
                    "keepAsBase64": true
                }
            },
            "name": "Binary to Base64",
            "type": "n8n-nodes-base.moveBinaryData",
            "typeVersion": 1,
            "position": [
                1840,
                200
            ]
        },
        {
            "id": "prepare-vision-data",
            "parameters": {
                "functionCode": "const checkUserData = $(\"Check User\").first().json;\nconst base64Data = items[0].json.base64_image;\n\nreturn [{\n  json: {\n    user_id: checkUserData.user_id,\n    chat_id: checkUserData.chat_id,\n    message_text: checkUserData.message_text,\n    message_id: checkUserData.message_id,\n    base64_image: base64Data,\n    mime_type: \"image/jpeg\"\n  }\n}];"
            },
            "name": "Prepare Vision Data",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                2040,
                200
            ]
        },
        {
            "id": "call-gpt4o-vision",
            "parameters": {
                "method": "POST",
                "url": "https://api.openai.com/v1/chat/completions",
                "authentication": "predefinedCredentialType",
                "nodeCredentialType": "openAiApi",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"model\": \"gpt-4o\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Ð Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð¹ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÑƒ Ñ Ñ„Ð¾Ñ‚Ð¾. Ð’ÐµÑ€Ð½Ð¸ JSON: {\\\"recognized\\\": true/false, \\\"data\\\": {\\\"distance_km\\\": Ñ‡Ð¸ÑÐ»Ð¾, \\\"duration_seconds\\\": Ñ‡Ð¸ÑÐ»Ð¾, \\\"avg_pace_seconds\\\": Ñ‡Ð¸ÑÐ»Ð¾, \\\"avg_heart_rate\\\": Ñ‡Ð¸ÑÐ»Ð¾ Ð¸Ð»Ð¸ null, \\\"type\\\": \\\"easy_run\\\"/\\\"tempo\\\"/\\\"intervals\\\"}, \\\"response\\\": \\\"Ñ‚ÐµÐºÑÑ‚\\\"}\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"image_url\",\n          \"image_url\": {\n            \"url\": \"data:{{ $json.mime_type }};base64,{{ $json.base64_image }}\"\n          }\n        },\n        {\n          \"type\": \"text\", \n          \"text\": \"Ð Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð¹ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÑƒ\"\n        }\n      ]\n    }\n  ],\n  \"max_tokens\": 500,\n  \"response_format\": {\"type\": \"json_object\"}\n}"
            },
            "name": "GPT-4o Vision",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                2240,
                200
            ],
            "credentials": {
                "openAiApi": {
                    "id": "koikxNcf4ds6vKgZ",
                    "name": "OpenAI - Running Coach"
                }
            }
        },
        {
            "id": "get-strategy",
            "parameters": {
                "operation": "getAll",
                "tableId": "training_strategies",
                "returnAll": false,
                "limit": 1,
                "filterType": "manual",
                "matchType": "allFilters",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "user_id",
                            "condition": "eq",
                            "keyValue": "={{ $('Check User').first().json.user_id }}"
                        },
                        {
                            "keyName": "status",
                            "condition": "eq",
                            "keyValue": "active"
                        }
                    ]
                },
                "options": {
                    "orderByColumn": "created_at",
                    "orderType": "desc"
                }
            },
            "name": "Get Strategy",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                2140,
                600
            ],
            "alwaysOutputData": true,
            "credentials": {
                "supabaseApi": {
                    "id": "CJ3Z1MvRt6BxblaB",
                    "name": "Supabase - Running Coach"
                }
            }
        },
        {
            "id": "is-strategy-stage",
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "strategy-check",
                            "leftValue": "={{ $('Build Update Data').first().json.is_strategy_stage }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "equals"
                            }
                        }
                    ],
                    "combinator": "and"
                }
            },
            "name": "Is Strategy Stage?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                4240,
                300
            ]
        },
        {
            "id": "save-strategy",
            "parameters": {
                "operation": "create",
                "tableId": "training_strategies",
                "dataToSend": "defineBelow",
                "fieldsUi": {
                    "fieldValues": [
                        {
                            "fieldId": "user_id",
                            "fieldValue": "={{ $('Extract Response').first().json.user_id }}"
                        },
                        {
                            "fieldId": "goal_type",
                            "fieldValue": "race"
                        },
                        {
                            "fieldId": "race_distance",
                            "fieldValue": "={{ $('Extract Response').first().json.extracted_data.race_distance }}"
                        },
                        {
                            "fieldId": "race_date",
                            "fieldValue": "={{ $('Extract Response').first().json.extracted_data.race_date }}"
                        },
                        {
                            "fieldId": "target_time_seconds",
                            "fieldValue": "={{ $('Extract Response').first().json.extracted_data.target_time_seconds }}"
                        },
                        {
                            "fieldId": "total_weeks",
                            "fieldValue": "={{ $('Extract Response').first().json.extracted_data.total_weeks }}"
                        },
                        {
                            "fieldId": "phases",
                            "fieldValue": "={{ JSON.stringify($('Extract Response').first().json.extracted_data.phases) }}"
                        },
                        {
                            "fieldId": "summary",
                            "fieldValue": "={{ $('Extract Response').first().json.extracted_data.strategy_summary }}"
                        },
                        {
                            "fieldId": "start_date",
                            "fieldValue": "={{ $now.format('yyyy-MM-dd') }}"
                        },
                        {
                            "fieldId": "end_date",
                            "fieldValue": "={{ $('Extract Response').first().json.extracted_data.race_date }}"
                        },
                        {
                            "fieldId": "status",
                            "fieldValue": "active"
                        }
                    ]
                }
            },
            "name": "Save Strategy",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                4440,
                200
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "CJ3Z1MvRt6BxblaB",
                    "name": "Supabase - Running Coach"
                }
            }
        }
    ],
    "connections": {
        "TelegramTrigger": {
            "main": [
                [
                    {
                        "node": "Extract Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Extract Message": {
            "main": [
                [
                    {
                        "node": "Get User",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get User": {
            "main": [
                [
                    {
                        "node": "Check User",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check User": {
            "main": [
                [
                    {
                        "node": "Show Typing",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Show Typing": {
            "main": [
                [
                    {
                        "node": "Route After Typing",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Route After Typing": {
            "main": [
                [
                    {
                        "node": "Is Photo?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Is Photo?": {
            "main": [
                [
                    {
                        "node": "Download Photo",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "User Not Found?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "GPT-4o Vision": {
            "main": [
                [
                    {
                        "node": "Parse Vision Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Vision Response": {
            "main": [
                [
                    {
                        "node": "Training Recognized?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Training Recognized?": {
            "main": [
                [
                    {
                        "node": "Save Photo Training",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Send Not Recognized",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Save Photo Training": {
            "main": [
                [
                    {
                        "node": "Format Photo Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Photo Response": {
            "main": [
                [
                    {
                        "node": "Send Photo Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "User Not Found?": {
            "main": [
                [
                    {
                        "node": "Create User",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Get Active Plan",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create User": {
            "main": [
                [
                    {
                        "node": "Get User Again",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get User Again": {
            "main": [
                [
                    {
                        "node": "Prepare New User Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare New User Data": {
            "main": [
                [
                    {
                        "node": "Merge User Flows",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Active Plan": {
            "main": [
                [
                    {
                        "node": "Get Recent Trainings",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Recent Trainings": {
            "main": [
                [
                    {
                        "node": "Get Strategy",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge Context": {
            "main": [
                [
                    {
                        "node": "Merge User Flows",
                        "type": "main",
                        "index": 1
                    }
                ]
            ]
        },
        "Merge User Flows": {
            "main": [
                [
                    {
                        "node": "Prepare Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Data": {
            "main": [
                [
                    {
                        "node": "Call OpenAI",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Call OpenAI": {
            "main": [
                [
                    {
                        "node": "Extract Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Extract Response": {
            "main": [
                [
                    {
                        "node": "Send to Telegram",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send to Telegram": {
            "main": [
                [
                    {
                        "node": "Is Onboarding?",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Is Plan Generation?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Is Onboarding?": {
            "main": [
                [
                    {
                        "node": "Build Update Data",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        },
        "Build Update Data": {
            "main": [
                [
                    {
                        "node": "Has Updates?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Has Updates?": {
            "main": [
                [
                    {
                        "node": "Update User Profile",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        },
        "Is Plan Generation?": {
            "main": [
                [
                    {
                        "node": "Save Plan",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        },
        "Download Photo": {
            "main": [
                [
                    {
                        "node": "Binary to Base64",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Binary to Base64": {
            "main": [
                [
                    {
                        "node": "Prepare Vision Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Vision Data": {
            "main": [
                [
                    {
                        "node": "GPT-4o Vision",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Strategy": {
            "main": [
                [
                    {
                        "node": "Merge Context",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Update User Profile": {
            "main": [
                [
                    {
                        "node": "Is Strategy Stage?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Is Strategy Stage?": {
            "main": [
                [
                    {
                        "node": "Save Strategy",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        }
    },
    "settings": {
        "executionOrder": "v1",
        "callerPolicy": "workflowsFromSameOwner",
        "availableInMCP": false
    },
    "staticData": null,
    "meta": null,
    "pinData": null,
    "versionId": "7ae6bb6d-8da4-4b38-8e71-009144a2fa42",
    "activeVersionId": "7ae6bb6d-8da4-4b38-8e71-009144a2fa42",
    "versionCounter": 67,
    "triggerCount": 1,
    "shared": [
        {
            "updatedAt": "2026-02-03T14:16:53.371Z",
            "createdAt": "2026-02-03T14:16:53.371Z",
            "role": "workflow:owner",
            "workflowId": "7Ar459SadzSXgUEv",
            "projectId": "jjRGAgVN0Om9gEix",
            "project": {
                "updatedAt": "2025-11-17T04:59:06.055Z",
                "createdAt": "2025-11-14T08:46:34.197Z",
                "id": "jjRGAgVN0Om9gEix",
                "name": "Nikita Kuznetsov <knu@skbkontur.ru>",
                "type": "personal",
                "icon": null,
                "description": null,
                "creatorId": "70308841-4ee1-48e9-854d-73f215836be6",
                "projectRelations": [
                    {
                        "updatedAt": "2025-11-14T08:46:34.197Z",
                        "createdAt": "2025-11-14T08:46:34.197Z",
                        "userId": "70308841-4ee1-48e9-854d-73f215836be6",
                        "projectId": "jjRGAgVN0Om9gEix",
                        "user": {
                            "updatedAt": "2026-02-06T23:26:54.198Z",
                            "createdAt": "2025-11-14T08:46:34.197Z",
                            "id": "70308841-4ee1-48e9-854d-73f215836be6",
                            "email": "knu@skbkontur.ru",
                            "firstName": "Nikita",
                            "lastName": "Kuznetsov",
                            "personalizationAnswers": {
                                "version": "v4",
                                "personalization_survey_submitted_at": "2025-11-17T04:59:14.713Z",
                                "personalization_survey_n8n_version": "1.117.3"
                            },
                            "settings": {
                                "firstSuccessfulWorkflowId": "OElc53ji11bXjJWq",
                                "userActivated": true,
                                "userActivatedAt": 1769961636692
                            },
                            "disabled": false,
                            "mfaEnabled": false,
                            "lastActiveAt": "2026-02-06",
                            "isPending": false
                        }
                    }
                ]
            }
        }
    ],
    "tags": [],
    "activeVersion": {
        "updatedAt": "2026-02-06T23:32:39.653Z",
        "createdAt": "2026-02-06T23:32:39.653Z",
        "versionId": "7ae6bb6d-8da4-4b38-8e71-009144a2fa42",
        "workflowId": "7Ar459SadzSXgUEv",
        "nodes": [
            {
                "id": "telegram-trigger",
                "parameters": {
                    "updates": [
                        "message"
                    ],
                    "additionalFields": {}
                },
                "name": "TelegramTrigger",
                "type": "n8n-nodes-base.telegramTrigger",
                "typeVersion": 1.2,
                "position": [
                    240,
                    400
                ],
                "credentials": {
                    "telegramApi": {
                        "id": "SLNhx6dJUSPFBV35",
                        "name": "Telegram Bot - Running Coach"
                    }
                }
            },
            {
                "id": "extract-message",
                "parameters": {
                    "functionCode": "const msg = items[0].json.message;\n\n// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ\nlet messageType = 'text';\nlet photoFileId = null;\nlet photoCaption = '';\n\nif (msg.photo && msg.photo.length > 0) {\n  messageType = 'photo';\n  // Ð‘ÐµÑ€Ñ‘Ð¼ Ñ„Ð¾Ñ‚Ð¾ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐµ Ð² Ð¼Ð°ÑÑÐ¸Ð²Ðµ)\n  photoFileId = msg.photo[msg.photo.length - 1].file_id;\n  photoCaption = msg.caption || '';\n}\n\nreturn [{\n  json: {\n    telegram_id: msg.from.id,\n    chat_id: msg.chat.id,\n    username: msg.from.username || '',\n    first_name: msg.from.first_name || 'Ð”Ñ€ÑƒÐ³',\n    last_name: msg.from.last_name || '',\n    message_text: msg.text || photoCaption || '',\n    message_id: msg.message_id,\n    message_type: messageType,\n    photo_file_id: photoFileId\n  }\n}];"
                },
                "name": "Extract Message",
                "type": "n8n-nodes-base.function",
                "typeVersion": 1,
                "position": [
                    440,
                    400
                ]
            },
            {
                "id": "get-user",
                "parameters": {
                    "operation": "getAll",
                    "tableId": "users",
                    "returnAll": false,
                    "limit": 1,
                    "filterType": "manual",
                    "matchType": "allFilters",
                    "filters": {
                        "conditions": [
                            {
                                "keyName": "telegram_id",
                                "condition": "eq",
                                "keyValue": "={{ $json.telegram_id }}"
                            }
                        ]
                    }
                },
                "name": "Get User",
                "type": "n8n-nodes-base.supabase",
                "typeVersion": 1,
                "position": [
                    640,
                    400
                ],
                "alwaysOutputData": true,
                "credentials": {
                    "supabaseApi": {
                        "id": "CJ3Z1MvRt6BxblaB",
                        "name": "Supabase - Running Coach"
                    }
                }
            },
            {
                "id": "check-user",
                "parameters": {
                    "functionCode": "const messageData = $('Extract Message').first().json;\n\nif (items.length === 0 || !items[0].json || !items[0].json.id) {\n  return [{\n    json: {\n      userExists: false,\n      telegram_id: messageData.telegram_id,\n      chat_id: messageData.chat_id,\n      username: messageData.username,\n      first_name: messageData.first_name,\n      last_name: messageData.last_name,\n      message_text: messageData.message_text,\n      message_id: messageData.message_id,\n      message_type: messageData.message_type,\n      photo_file_id: messageData.photo_file_id\n    }\n  }];\n} else {\n  const userData = items[0].json;\n  return [{\n    json: {\n      userExists: true,\n      user_id: userData.id,\n      telegram_id: userData.telegram_id,\n      first_name: userData.first_name || messageData.first_name,\n      onboarding_stage: userData.onboarding_stage || 'started',\n      level: userData.level,\n      age: userData.age,\n      height_cm: userData.height_cm,\n      weight_kg: userData.weight_kg,\n      weekly_runs: userData.weekly_runs,\n      goal: userData.goal,\n      current_5k_pace_seconds: userData.current_5k_pace_seconds,\n      race_date: userData.race_date,\n      race_distance: userData.race_distance,\n      target_time_seconds: userData.target_time_seconds,\n      resting_hr: userData.resting_hr,\n      max_hr: userData.max_hr,\n      has_lab_testing: userData.has_lab_testing,\n      vo2max: userData.vo2max,\n      lthr: userData.lthr,\n      hr_zone1_max: userData.hr_zone1_max,\n      hr_zone2_max: userData.hr_zone2_max,\n      hr_zone3_max: userData.hr_zone3_max,\n      hr_zone4_max: userData.hr_zone4_max,\n      hr_zone5_max: userData.hr_zone5_max,\n      chat_id: messageData.chat_id,\n      message_text: messageData.message_text,\n      message_id: messageData.message_id,\n      message_type: messageData.message_type,\n      photo_file_id: messageData.photo_file_id\n    }\n  }];\n}"
                },
                "name": "Check User",
                "type": "n8n-nodes-base.function",
                "typeVersion": 1,
                "position": [
                    840,
                    400
                ]
            },
            {
                "id": "show-typing",
                "parameters": {
                    "operation": "sendChatAction",
                    "chatId": "={{ $json.chat_id.toString() }}",
                    "action": "typing"
                },
                "name": "Show Typing",
                "type": "n8n-nodes-base.telegram",
                "typeVersion": 1.2,
                "position": [
                    1040,
                    400
                ],
                "credentials": {
                    "telegramApi": {
                        "id": "SLNhx6dJUSPFBV35",
                        "name": "Telegram Bot - Running Coach"
                    }
                }
            },
            {
                "id": "route-after-typing",
                "parameters": {
                    "functionCode": "const data = $('Check User').first().json;\nreturn [{json: data}];"
                },
                "name": "Route After Typing",
                "type": "n8n-nodes-base.function",
                "typeVersion": 1,
                "position": [
                    1240,
                    400
                ]
            },
            {
                "id": "is-photo",
                "parameters": {
                    "conditions": {
                        "options": {
                            "caseSensitive": true,
                            "typeValidation": "strict"
                        },
                        "conditions": [
                            {
                                "id": "photo-check",
                                "leftValue": "={{ $json.message_type }}",
                                "rightValue": "photo",
                                "operator": {
                                    "type": "string",
                                    "operation": "equals"
                                }
                            },
                            {
                                "id": "completed-check",
                                "leftValue": "={{ $json.onboarding_stage }}",
                                "rightValue": "completed",
                                "operator": {
                                    "type": "string",
                                    "operation": "equals"
                                }
                            }
                        ],
                        "combinator": "and"
                    }
                },
                "name": "Is Photo?",
                "type": "n8n-nodes-base.if",
                "typeVersion": 2,
                "position": [
                    1440,
                    400
                ]
            },
            {
                "id": "parse-vision-response",
                "parameters": {
                    "functionCode": "const checkUserData = $('Check User').first().json;\nconst visionResponse = items[0].json;\nconst aiContent = visionResponse.choices[0].message.content;\n\nlet parsed;\ntry {\n  parsed = JSON.parse(aiContent);\n} catch (e) {\n  parsed = {\n    recognized: false,\n    response: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ñ„Ð¾Ñ‚Ð¾. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÐµÑ‰Ñ‘ Ñ€Ð°Ð· Ð¸Ð»Ð¸ Ð½Ð°Ð¿Ð¸ÑˆÐ¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼.'\n  };\n}\n\n// ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Telegram\nlet responseText = parsed.response || 'Ð¤Ð¾Ñ‚Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾';\nresponseText = responseText\n  .replace(/\\*/g, 'â€¢')\n  .replace(/_/g, ' ')\n  .replace(/`/g, \"'\")\n  .replace(/\\[/g, '(')\n  .replace(/\\]/g, ')');\n\nreturn [{\n  json: {\n    user_id: checkUserData.user_id,\n    chat_id: checkUserData.chat_id,\n    message_id: checkUserData.message_id,\n    recognized: parsed.recognized || false,\n    confidence: parsed.confidence || 'low',\n    training_data: parsed.data || null,\n    source_app: parsed.source_app || null,\n    response_text: responseText,\n    is_photo_training: true\n  }\n}];"
                },
                "name": "Parse Vision Response",
                "type": "n8n-nodes-base.function",
                "typeVersion": 1,
                "position": [
                    2240,
                    200
                ]
            },
            {
                "id": "is-training-recognized",
                "parameters": {
                    "conditions": {
                        "options": {
                            "caseSensitive": true,
                            "typeValidation": "strict"
                        },
                        "conditions": [
                            {
                                "id": "recognized-check",
                                "leftValue": "={{ $json.recognized }}",
                                "rightValue": true,
                                "operator": {
                                    "type": "boolean",
                                    "operation": "equals"
                                }
                            }
                        ],
                        "combinator": "and"
                    }
                },
                "name": "Training Recognized?",
                "type": "n8n-nodes-base.if",
                "typeVersion": 2,
                "position": [
                    2440,
                    200
                ]
            },
            {
                "id": "save-photo-training",
                "parameters": {
                    "operation": "create",
                    "tableId": "trainings",
                    "dataToSend": "defineBelow",
                    "fieldsUi": {
                        "fieldValues": [
                            {
                                "fieldId": "user_id",
                                "fieldValue": "={{ $json.user_id }}"
                            },
                            {
                                "fieldId": "date",
                                "fieldValue": "={{ $now.format('yyyy-MM-dd') }}"
                            },
                            {
                                "fieldId": "day_of_week",
                                "fieldValue": "={{ $now.format('EEEE').toLowerCase() }}"
                            },
                            {
                                "fieldId": "type",
                                "fieldValue": "={{ $json.training_data.type || 'easy_run' }}"
                            },
                            {
                                "fieldId": "distance_km",
                                "fieldValue": "={{ $json.training_data.distance_km }}"
                            },
                            {
                                "fieldId": "duration_seconds",
                                "fieldValue": "={{ $json.training_data.duration_seconds }}"
                            },
                            {
                                "fieldId": "avg_pace_seconds",
                                "fieldValue": "={{ $json.training_data.avg_pace_seconds }}"
                            },
                            {
                                "fieldId": "avg_heart_rate",
                                "fieldValue": "={{ $json.training_data.avg_heart_rate }}"
                            },
                            {
                                "fieldId": "max_heart_rate",
                                "fieldValue": "={{ $json.training_data.max_heart_rate }}"
                            },
                            {
                                "fieldId": "calories",
                                "fieldValue": "={{ $json.training_data.calories }}"
                            },
                            {
                                "fieldId": "elevation_gain_m",
                                "fieldValue": "={{ $json.training_data.elevation_gain_m }}"
                            },
                            {
                                "fieldId": "source",
                                "fieldValue": "screenshot"
                            },
                            {
                                "fieldId": "is_planned",
                                "fieldValue": "={{ false }}"
                            }
                        ]
                    }
                },
                "name": "Save Photo Training",
                "type": "n8n-nodes-base.supabase",
                "typeVersion": 1,
                "position": [
                    2640,
                    100
                ],
                "credentials": {
                    "supabaseApi": {
                        "id": "CJ3Z1MvRt6BxblaB",
                        "name": "Supabase - Running Coach"
                    }
                }
            },
            {
                "id": "format-photo-response",
                "parameters": {
                    "functionCode": "const parseData = $('Parse Vision Response').first().json;\nconst td = parseData.training_data || {};\n\nconst formatPace = (s) => {\n  if (!s) return 'Ð½/Ð´';\n  return Math.floor(s/60) + ':' + String(s % 60).padStart(2, '0');\n};\n\nlet text = 'ðŸ“ Ð¢Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð·Ð°Ð¿Ð¸ÑÐ°Ð½Ð°!\\n\\n';\ntext += 'â€¢ Ð”Ð¸ÑÑ‚Ð°Ð½Ñ†Ð¸Ñ: ' + (td.distance_km || 'Ð½/Ð´') + ' ÐºÐ¼\\n';\ntext += 'â€¢ Ð’Ñ€ÐµÐ¼Ñ: ' + (td.duration_seconds ? Math.floor(td.duration_seconds/60) + ' Ð¼Ð¸Ð½' : 'Ð½/Ð´') + '\\n';\ntext += 'â€¢ Ð¢ÐµÐ¼Ð¿: ' + formatPace(td.avg_pace_seconds) + '/ÐºÐ¼\\n';\nif (td.avg_heart_rate) text += 'â€¢ ÐŸÑƒÐ»ÑŒÑ: ' + td.avg_heart_rate + ' ÑƒÐ´/Ð¼Ð¸Ð½\\n';\nif (td.calories) text += 'â€¢ ÐšÐ°Ð»Ð¾Ñ€Ð¸Ð¸: ' + td.calories + '\\n';\nif (td.elevation_gain_m) text += 'â€¢ ÐÐ°Ð±Ð¾Ñ€ Ð²Ñ‹ÑÐ¾Ñ‚Ñ‹: ' + td.elevation_gain_m + ' Ð¼\\n';\ntext += '\\nðŸ’ª ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°!';\n\nreturn [{\n  json: {\n    chat_id: parseData.chat_id,\n    response_text: text\n  }\n}];"
                },
                "name": "Format Photo Response",
                "type": "n8n-nodes-base.function",
                "typeVersion": 1,
                "position": [
                    2840,
                    100
                ]
            },
            {
                "id": "send-photo-response",
                "parameters": {
                    "operation": "sendMessage",
                    "chatId": "={{ $json.chat_id.toString() }}",
                    "text": "={{ $json.response_text }}",
                    "additionalFields": {
                        "appendAttribution": false
                    }
                },
                "name": "Send Photo Response",
                "type": "n8n-nodes-base.telegram",
                "typeVersion": 1.2,
                "position": [
                    3040,
                    100
                ],
                "credentials": {
                    "telegramApi": {
                        "id": "SLNhx6dJUSPFBV35",
                        "name": "Telegram Bot - Running Coach"
                    }
                }
            },
            {
                "id": "send-not-recognized",
                "parameters": {
                    "operation": "sendMessage",
                    "chatId": "={{ $json.chat_id.toString() }}",
                    "text": "={{ $json.response_text }}",
                    "additionalFields": {
                        "appendAttribution": false
                    }
                },
                "name": "Send Not Recognized",
                "type": "n8n-nodes-base.telegram",
                "typeVersion": 1.2,
                "position": [
                    2640,
                    300
                ],
                "credentials": {
                    "telegramApi": {
                        "id": "SLNhx6dJUSPFBV35",
                        "name": "Telegram Bot - Running Coach"
                    }
                }
            },
            {
                "id": "user-not-found",
                "parameters": {
                    "conditions": {
                        "options": {
                            "caseSensitive": true,
                            "typeValidation": "strict"
                        },
                        "conditions": [
                            {
                                "id": "c1",
                                "leftValue": "={{ $json.userExists }}",
                                "rightValue": false,
                                "operator": {
                                    "type": "boolean",
                                    "operation": "equals"
                                }
                            }
                        ],
                        "combinator": "and"
                    }
                },
                "name": "User Not Found?",
                "type": "n8n-nodes-base.if",
                "typeVersion": 2,
                "position": [
                    1640,
                    500
                ]
            },
            {
                "id": "create-user",
                "parameters": {
                    "operation": "create",
                    "tableId": "users",
                    "dataToSend": "defineBelow",
                    "fieldsUi": {
                        "fieldValues": [
                            {
                                "fieldId": "telegram_id",
                                "fieldValue": "={{ $json.telegram_id }}"
                            },
                            {
                                "fieldId": "username",
                                "fieldValue": "={{ $json.username }}"
                            },
                            {
                                "fieldId": "first_name",
                                "fieldValue": "={{ $json.first_name }}"
                            },
                            {
                                "fieldId": "last_name",
                                "fieldValue": "={{ $json.last_name }}"
                            },
                            {
                                "fieldId": "onboarding_stage",
                                "fieldValue": "started"
                            },
                            {
                                "fieldId": "language",
                                "fieldValue": "ru"
                            }
                        ]
                    }
                },
                "name": "Create User",
                "type": "n8n-nodes-base.supabase",
                "typeVersion": 1,
                "position": [
                    1840,
                    400
                ],
                "credentials": {
                    "supabaseApi": {
                        "id": "CJ3Z1MvRt6BxblaB",
                        "name": "Supabase - Running Coach"
                    }
                }
            },
            {
                "id": "get-user-again",
                "parameters": {
                    "operation": "getAll",
                    "tableId": "users",
                    "returnAll": false,
                    "limit": 1,
                    "filterType": "manual",
                    "matchType": "allFilters",
                    "filters": {
                        "conditions": [
                            {
                                "keyName": "telegram_id",
                                "condition": "eq",
                                "keyValue": "={{ $('Check User').first().json.telegram_id }}"
                            }
                        ]
                    }
                },
                "name": "Get User Again",
                "type": "n8n-nodes-base.supabase",
                "typeVersion": 1,
                "position": [
                    2040,
                    400
                ],
                "credentials": {
                    "supabaseApi": {
                        "id": "CJ3Z1MvRt6BxblaB",
                        "name": "Supabase - Running Coach"
                    }
                }
            },
            {
                "id": "prepare-new-user",
                "parameters": {
                    "functionCode": "const messageData = $('Check User').first().json;\nconst userData = items[0].json;\nreturn [{\n  json: {\n    userExists: true,\n    user_id: userData.id,\n    first_name: userData.first_name || messageData.first_name,\n    onboarding_stage: userData.onboarding_stage || 'started',\n    chat_id: messageData.chat_id,\n    message_text: messageData.message_text,\n    message_id: messageData.message_id,\n    active_plan: null,\n    recent_trainings: []\n  }\n}];"
                },
                "name": "Prepare New User Data",
                "type": "n8n-nodes-base.function",
                "typeVersion": 1,
                "position": [
                    2240,
                    400
                ]
            },
            {
                "id": "get-active-plan",
                "parameters": {
                    "operation": "getAll",
                    "tableId": "weekly_plans",
                    "returnAll": false,
                    "limit": 1,
                    "filterType": "manual",
                    "matchType": "allFilters",
                    "filters": {
                        "conditions": [
                            {
                                "keyName": "user_id",
                                "condition": "eq",
                                "keyValue": "={{ $('Check User').first().json.user_id }}"
                            },
                            {
                                "keyName": "status",
                                "condition": "eq",
                                "keyValue": "active"
                            }
                        ]
                    },
                    "options": {
                        "orderByColumn": "created_at",
                        "orderType": "desc"
                    }
                },
                "name": "Get Active Plan",
                "type": "n8n-nodes-base.supabase",
                "typeVersion": 1,
                "position": [
                    1840,
                    600
                ],
                "alwaysOutputData": true,
                "credentials": {
                    "supabaseApi": {
                        "id": "CJ3Z1MvRt6BxblaB",
                        "name": "Supabase - Running Coach"
                    }
                }
            },
            {
                "id": "get-recent-trainings",
                "parameters": {
                    "operation": "getAll",
                    "tableId": "trainings",
                    "returnAll": false,
                    "limit": 10,
                    "filterType": "manual",
                    "matchType": "allFilters",
                    "filters": {
                        "conditions": [
                            {
                                "keyName": "user_id",
                                "condition": "eq",
                                "keyValue": "={{ $('Check User').first().json.user_id }}"
                            }
                        ]
                    },
                    "options": {
                        "orderByColumn": "date",
                        "orderType": "desc"
                    }
                },
                "name": "Get Recent Trainings",
                "type": "n8n-nodes-base.supabase",
                "typeVersion": 1,
                "position": [
                    2040,
                    600
                ],
                "alwaysOutputData": true,
                "credentials": {
                    "supabaseApi": {
                        "id": "CJ3Z1MvRt6BxblaB",
                        "name": "Supabase - Running Coach"
                    }
                }
            },
            {
                "id": "merge-context",
                "parameters": {
                    "functionCode": "const checkUserData = $('Check User').first().json;\nconst planItems = $('Get Active Plan').all();\nconst trainingItems = $('Get Recent Trainings').all();\nconst strategyItems = items;\n\nlet activePlan = null;\nif (planItems.length > 0 && planItems[0].json && planItems[0].json.id) {\n  activePlan = planItems[0].json;\n}\n\nlet recentTrainings = [];\nif (trainingItems.length > 0) {\n  recentTrainings = trainingItems.map(t => t.json).filter(t => t && t.id);\n}\n\nlet activeStrategy = null;\nif (strategyItems.length > 0 && strategyItems[0].json && strategyItems[0].json.id) {\n  activeStrategy = strategyItems[0].json;\n}\n\nreturn [{\n  json: {\n    ...checkUserData,\n    active_plan: activePlan,\n    recent_trainings: recentTrainings,\n    active_strategy: activeStrategy\n  }\n}];"
                },
                "name": "Merge Context",
                "type": "n8n-nodes-base.function",
                "typeVersion": 1,
                "position": [
                    2340,
                    600
                ]
            },
            {
                "id": "merge-flows",
                "parameters": {
                    "mode": "append",
                    "options": {}
                },
                "name": "Merge User Flows",
                "type": "n8n-nodes-base.merge",
                "typeVersion": 3,
                "position": [
                    2440,
                    500
                ]
            },
            {
                "id": "prepare-data",
                "parameters": {
                    "functionCode": "const data = items[0].json;\nconst message = data.message_text;\nconst stage = data.onboarding_stage || 'started';\nconst firstName = data.first_name || 'Ð´Ñ€ÑƒÐ³';\n\nlet systemPrompt = '';\nlet nextStage = stage;\nlet isPlanGeneration = false;\n\nconst JSON_FORMAT = 'ÐžÑ‚Ð²ÐµÑ‚ÑŒ JSON: {\"extracted\": {...}, \"response\": \"Ñ‚ÐµÐºÑÑ‚\"}. ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ * _ ` [ ]';\n\nconst formatPace = (sec) => {\n  if (!sec) return 'Ð½/Ð´';\n  return Math.floor(sec/60) + ':' + (sec%60).toString().padStart(2,'0');\n};\n\n// ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº\nlet trainingsContext = '';\nconst trainings = data.recent_trainings || [];\nif (trainings.length > 0) {\n  trainingsContext = '\\n\\nÐ£ ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¯ Ð•Ð¡Ð¢Ð¬ ' + trainings.length + ' Ð—ÐÐŸÐ˜Ð¡ÐÐÐÐ«Ð¥ Ð¢Ð Ð•ÐÐ˜Ð ÐžÐ’ÐžÐš:\\n';\n  trainings.slice(0, 10).forEach(t => {\n    trainingsContext += 'â€¢ ' + t.date + ': ' + (t.distance_km || '?') + ' ÐºÐ¼';\n    if (t.duration_seconds) trainingsContext += ', ' + Math.round(t.duration_seconds/60) + ' Ð¼Ð¸Ð½';\n    if (t.avg_pace_seconds) trainingsContext += ', Ñ‚ÐµÐ¼Ð¿ ' + formatPace(t.avg_pace_seconds) + '/ÐºÐ¼';\n    if (t.avg_heart_rate) trainingsContext += ', Ð¿ÑƒÐ»ÑŒÑ ' + t.avg_heart_rate;\n    if (t.type) trainingsContext += ' (' + t.type + ')';\n    trainingsContext += '\\n';\n  });\n} else {\n  trainingsContext = '\\n\\nÐ¢Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð¿Ð¾ÐºÐ° Ð½Ðµ Ð·Ð°Ð¿Ð¸ÑÐ°Ð½Ð¾.\\n';\n}\n\n// ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð¿Ð»Ð°Ð½Ð°\nlet planContext = '';\nif (data.active_plan && data.active_plan.plan_data) {\n  try {\n    const pd = typeof data.active_plan.plan_data === 'string' ? JSON.parse(data.active_plan.plan_data) : data.active_plan.plan_data;\n    planContext = '\\nÐÐšÐ¢Ð˜Ð’ÐÐ«Ð™ ÐŸÐ›ÐÐ: ' + (pd.raw_plan || '').substring(0, 500);\n  } catch(e) {}\n}\n\n// ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¸\nlet strategyContext = '';\nlet currentPhase = null;\nif (data.active_strategy && data.active_strategy.phases) {\n  try {\n    const strategy = data.active_strategy;\n    const phases = typeof strategy.phases === 'string' ? JSON.parse(strategy.phases) : strategy.phases;\n    const startDate = new Date(strategy.start_date);\n    const now = new Date();\n    const weeksSinceStart = Math.max(1, Math.ceil((now - startDate) / (7 * 24 * 60 * 60 * 1000)));\n\n    for (const phase of phases) {\n      if (weeksSinceStart >= phase.start_week && weeksSinceStart <= phase.end_week) {\n        currentPhase = phase;\n        break;\n      }\n    }\n\n    strategyContext = '\\n\\nÐ¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯ ÐŸÐžÐ”Ð“ÐžÐ¢ÐžÐ’ÐšÐ˜:';\n    strategyContext += '\\nâ€¢ Ð¦ÐµÐ»ÑŒ: ' + (strategy.race_distance || '') + (strategy.race_date ? ' (' + strategy.race_date + ')' : '');\n    strategyContext += '\\nâ€¢ Ð’ÑÐµÐ³Ð¾ Ð½ÐµÐ´ÐµÐ»ÑŒ: ' + strategy.total_weeks + ', Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ Ð½ÐµÐ´ÐµÐ»Ñ: ' + weeksSinceStart;\n    if (currentPhase) {\n      strategyContext += '\\nâ€¢ Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ñ„Ð°Ð·Ð°: ' + currentPhase.display_name + ' (Ð½ÐµÐ´. ' + currentPhase.start_week + '-' + currentPhase.end_week + ')';\n      strategyContext += '\\nâ€¢ Ð¤Ð¾ÐºÑƒÑ: ' + currentPhase.focus;\n      strategyContext += '\\nâ€¢ ÐžÐ±ÑŠÑ‘Ð¼: ' + currentPhase.target_weekly_km_min + '-' + currentPhase.target_weekly_km_max + ' ÐºÐ¼/Ð½ÐµÐ´';\n      strategyContext += '\\nâ€¢ ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸: ' + (currentPhase.key_workouts || []).join(', ');\n    }\n    strategyContext += '\\nâ€¢ Ð’ÑÐµ Ñ„Ð°Ð·Ñ‹: ';\n    phases.forEach(p => {\n      const isCurrent = (currentPhase && p.name === currentPhase.name) ? ' [Ð¢Ð•ÐšÐ£Ð©ÐÐ¯]' : '';\n      strategyContext += p.display_name + ' (Ð½ÐµÐ´.' + p.start_week + '-' + p.end_week + ')' + isCurrent + ', ';\n    });\n    strategyContext += '\\n';\n  } catch(e) {\n    strategyContext = '';\n  }\n}\n\nif (stage !== 'completed') {\n  // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð´Ð»Ñ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°\n  const profileInfo = 'Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: '\n    + (data.race_distance ? 'Ð´Ð¸ÑÑ‚Ð°Ð½Ñ†Ð¸Ñ=' + data.race_distance + ', ' : '')\n    + (data.race_date ? 'Ð´Ð°Ñ‚Ð°=' + data.race_date + ', ' : '')\n    + (data.target_time_seconds ? 'Ñ†ÐµÐ»ÑŒ=' + data.target_time_seconds + 'ÑÐµÐº, ' : '')\n    + (data.weekly_runs ? 'Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº/Ð½ÐµÐ´=' + data.weekly_runs + ', ' : '')\n    + (data.level ? 'ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ=' + data.level : '');\n\n  const prompts = {\n    'started': 'ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐ¹ ' + firstName + '. ÐŸÑ€ÐµÐ´ÑÑ‚Ð°Ð²ÑŒÑÑ AI-Ñ‚Ñ€ÐµÐ½ÐµÑ€Ð¾Ð¼ Ð¿Ð¾ Ð±ÐµÐ³Ñƒ. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ: Ð½Ð¾Ð²Ð¸Ñ‡Ð¾Ðº/Ð»ÑŽÐ±Ð¸Ñ‚ÐµÐ»ÑŒ/Ð¿Ñ€Ð¾Ð´Ð²Ð¸Ð½ÑƒÑ‚Ñ‹Ð¹. ' + JSON_FORMAT,\n    'profile': 'ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸ level: beginner/intermediate/advanced. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚. ' + JSON_FORMAT + ' extracted: {level: ...}',\n    'physical': 'Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ age. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ñ€Ð¾ÑÑ‚ Ð¸ Ð²ÐµÑ. ' + JSON_FORMAT + ' extracted: {age: Ñ‡Ð¸ÑÐ»Ð¾}',\n    'heart_rate': 'Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ height_cm, weight_kg. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ð¿ÑƒÐ»ÑŒÑ Ð¿Ð¾ÐºÐ¾Ñ. ' + JSON_FORMAT + ' extracted: {height_cm, weight_kg}',\n    'running_info': 'Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ resting_hr. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ñ‚ÐµÐ¼Ð¿ Ð½Ð° 5ÐºÐ¼. ' + JSON_FORMAT + ' extracted: {resting_hr}',\n    'lab_testing': 'Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ current_5k_pace_seconds (Ñ‚ÐµÐ¼Ð¿ Ð² ÑÐµÐº/ÐºÐ¼). Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ð¿Ñ€Ð¾ VO2max Ñ‚ÐµÑÑ‚. ' + JSON_FORMAT + ' extracted: {current_5k_pace_seconds}',\n    'training_freq': 'Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ has_lab_testing. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ð´Ð½ÐµÐ¹ Ð² Ð½ÐµÐ´ÐµÐ»ÑŽ (3-6). ' + JSON_FORMAT + ' extracted: {has_lab_testing, vo2max?, lthr?}',\n    'race_details': 'Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ weekly_runs (Ñ‡Ð¸ÑÐ»Ð¾). Ð¢Ð°ÐºÐ¶Ðµ ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐºÐ°Ð·Ð°Ð» Ð´Ð¸ÑÑ‚Ð°Ð½Ñ†Ð¸ÑŽ/Ð´Ð°Ñ‚Ñƒ/Ñ†ÐµÐ»ÑŒ Ð·Ð°Ð±ÐµÐ³Ð° - Ð¸Ð·Ð²Ð»ÐµÐºÐ¸ Ð¸Ñ… Ñ‚Ð¾Ð¶Ðµ. '\n      + 'Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ð´Ð¸ÑÑ‚Ð°Ð½Ñ†Ð¸ÑŽ Ð·Ð°Ð±ÐµÐ³Ð°, Ð´Ð°Ñ‚Ñƒ, Ñ†ÐµÐ»ÐµÐ²Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ. '\n      + 'Ð’ ÐºÐ¾Ð½Ñ†Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° ÑÐºÐ°Ð¶Ð¸: \"ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾! Ð¡ÐµÐ¹Ñ‡Ð°Ñ ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÑŽ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸ÑŽ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸!\" '\n      + JSON_FORMAT + ' extracted: {weekly_runs, race_distance: 5k/10k/half/marathon, race_date: YYYY-MM-DD, target_time_seconds: Ñ‡Ð¸ÑÐ»Ð¾}',\n    'strategy_preview': profileInfo + '\\n\\n'\n      + 'Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—Ð£Ð™ Ð”ÐÐÐÐ«Ð• ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¯ Ð’Ð«Ð¨Ð•. Ð•ÑÐ»Ð¸ Ð² ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ ÐµÑÑ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¸Ñ….\\n\\n'\n      + 'Ð¡Ð“Ð•ÐÐ•Ð Ð˜Ð Ð£Ð™ Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð® ÐŸÐžÐ”Ð“ÐžÐ¢ÐžÐ’ÐšÐ˜ Ðš Ð—ÐÐ‘Ð•Ð“Ð£:\\n'\n      + '1. Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ð¹ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð½ÐµÐ´ÐµÐ»ÑŒ Ð¾Ñ‚ ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð´Ð¾ Ð´Ð°Ñ‚Ñ‹ Ð·Ð°Ð±ÐµÐ³Ð°\\n'\n      + '2. Ð Ð°Ð·Ð´ÐµÐ»Ð¸ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÑƒ Ð½Ð° 4 Ñ„Ð°Ð·Ñ‹:\\n'\n      + '   - base (Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹): ~30% Ð½ÐµÐ´ÐµÐ»ÑŒ\\n'\n      + '   - development (Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ): ~30% Ð½ÐµÐ´ÐµÐ»ÑŒ\\n'\n      + '   - specialization (ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ): ~25% Ð½ÐµÐ´ÐµÐ»ÑŒ\\n'\n      + '   - taper (Ñ‚ÐµÐ¹Ð¿ÐµÑ€): ~15% Ð½ÐµÐ´ÐµÐ»ÑŒ (Ð¼Ð¸Ð½ 1, Ð¼Ð°ÐºÑ 3)\\n'\n      + '3. Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ñ„Ð°Ð·Ñ‹: start_week, end_week, duration_weeks, focus, target_weekly_km_min, target_weekly_km_max, key_workouts, intensity_distribution\\n'\n      + '4. Ð’ response Ð¿Ð¾ÐºÐ°Ð¶Ð¸ ÐºÑ€Ð°ÑÐ¸Ð²Ñ‹Ð¹ Ð¾Ð±Ð·Ð¾Ñ€ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¸\\n\\n'\n      + JSON_FORMAT + '\\n'\n      + 'extracted: { race_distance: ' + (data.race_distance || 'half') + ', race_date: ' + (data.race_date || new Date(Date.now() + 16*7*24*60*60*1000).toISOString().split('T')[0]) + ', target_time_seconds: ' + (data.target_time_seconds || 6300) + ', strategy_generated: true, total_weeks: Ñ‡Ð¸ÑÐ»Ð¾, strategy_summary: \"ÐºÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ\", phases: [{name, display_name, start_week, end_week, duration_weeks, focus, target_weekly_km_min, target_weekly_km_max, key_workouts: [...], intensity_distribution}] }'\n  };\n  systemPrompt = prompts[stage] || prompts['started'];\n  const nextStages = {started:'profile', profile:'physical', physical:'heart_rate', heart_rate:'running_info', running_info:'lab_testing', lab_testing:'training_freq', training_freq:'race_details', race_details:'strategy_preview', strategy_preview:'completed'};\n  nextStage = nextStages[stage] || stage;\n} else {\n  const isStrategyQuestion = /ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³|Ñ„Ð°Ð·[Ð°Ñ‹ÑƒÐµÐ¸]|Ð¿ÐµÑ€Ð¸Ð¾Ð´|ÑÑ‚Ð°Ð¿ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸|Ð¿Ð»Ð°Ð½ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸|ÐºÐ°Ðº.*Ð¸Ð´Ñƒ|Ð´Ð¾Ð»Ð³Ð¾ÑÑ€Ð¾Ñ‡|Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð².*Ð·Ð°Ð±ÐµÐ³/i.test(message);\n\n  if (isStrategyQuestion && data.active_strategy) {\n    systemPrompt = 'Ð¢Ñ‹ AI-Ñ‚Ñ€ÐµÐ½ÐµÑ€ Ð¿Ð¾ Ð±ÐµÐ³Ñƒ Ð´Ð»Ñ ' + firstName + '. ÐÐ• Ð·Ð´Ð¾Ñ€Ð¾Ð²Ð°Ð¹ÑÑ.'\n      + strategyContext + trainingsContext + planContext\n      + '\\n\\nÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ð¾ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¸: \"' + message + '\"'\n      + '\\n\\nÐžÑ‚Ð²ÐµÑ‚ÑŒ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ñ„Ð°Ð·Ðµ, Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐµ Ð¸ Ñ‡Ñ‚Ð¾ Ð²Ð¿ÐµÑ€ÐµÐ´Ð¸.'\n      + '\\n\\n' + JSON_FORMAT;\n  } else if (/Ð¿Ð»Ð°Ð½|ÑÐ¾ÑÑ‚Ð°Ð²|Ð´Ð°Ð²Ð°Ð¹|Ð½Ð°Ñ‡Ð½|Ð³Ð¾Ñ‚Ð¾Ð²|Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ðº|Ð½ÐµÐ´ÐµÐ»/i.test(message)) {\n    isPlanGeneration = true;\n    systemPrompt = 'AI-Ñ‚Ñ€ÐµÐ½ÐµÑ€ Ð´Ð»Ñ ' + firstName + '. Ð¡Ð¾ÑÑ‚Ð°Ð²ÑŒ Ð¿Ð»Ð°Ð½ Ð½Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ (' + (data.weekly_runs || 3) + ' Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº).'\n      + strategyContext + trainingsContext + planContext\n      + (currentPhase ? '\\n\\nÐ’ÐÐ–ÐÐž: ÐŸÐ»Ð°Ð½ Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¾Ð²Ð°Ñ‚ÑŒ Ð¢Ð•ÐšÐ£Ð©Ð•Ð™ Ð¤ÐÐ—Ð•: ' + currentPhase.display_name + '. Ð¤Ð¾ÐºÑƒÑ: ' + currentPhase.focus + '. ÐžÐ±ÑŠÑ‘Ð¼: ' + currentPhase.target_weekly_km_min + '-' + currentPhase.target_weekly_km_max + ' ÐºÐ¼.' : '')\n      + ' ' + JSON_FORMAT + ' extracted: {plan_generated: true, total_km: Ñ‡Ð¸ÑÐ»Ð¾}';\n  } else {\n    systemPrompt = 'Ð¢Ñ‹ AI-Ñ‚Ñ€ÐµÐ½ÐµÑ€ Ð¿Ð¾ Ð±ÐµÐ³Ñƒ Ð´Ð»Ñ ' + firstName + '. ÐÐ• Ð·Ð´Ð¾Ñ€Ð¾Ð²Ð°Ð¹ÑÑ.'\n      + strategyContext + trainingsContext + planContext\n      + '\\n\\nÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚: \"' + message + '\"'\n      + '\\n\\nÐŸÐ ÐÐ’Ð˜Ð›Ð ÐžÐ¢Ð’Ð•Ð¢Ð:\\n1. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð”ÐÐÐÐ«Ð• Ð¢Ð Ð•ÐÐ˜Ð ÐžÐ’ÐžÐš Ð²Ñ‹ÑˆÐµ'\n      + '\\n2. Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ - ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ñ„Ð°Ð·Ñƒ'\n      + '\\n3. Ð‘ÑƒÐ´ÑŒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼: ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ Ñ†Ð¸Ñ„Ñ€Ñ‹'\n      + '\\n4. Ð”Ð°Ð¹ ÐºÑ€Ð°Ñ‚ÐºÑƒÑŽ Ð¾Ñ†ÐµÐ½ÐºÑƒ Ð¸ ÑÐ¾Ð²ÐµÑ‚'\n      + '\\n\\n' + JSON_FORMAT;\n  }\n}\n\nreturn [{\n  json: {\n    user_id: data.user_id,\n    chat_id: data.chat_id,\n    message_text: message,\n    message_id: data.message_id,\n    system_prompt: systemPrompt,\n    onboarding_stage: stage,\n    next_stage: nextStage,\n    is_plan_generation: isPlanGeneration,\n    weekly_runs: data.weekly_runs\n  }\n}];"
                },
                "name": "Prepare Data",
                "type": "n8n-nodes-base.function",
                "typeVersion": 1,
                "position": [
                    2640,
                    500
                ]
            },
            {
                "id": "call-openai",
                "parameters": {
                    "method": "POST",
                    "url": "https://api.openai.com/v1/chat/completions",
                    "authentication": "predefinedCredentialType",
                    "nodeCredentialType": "openAiApi",
                    "sendBody": true,
                    "specifyBody": "json",
                    "jsonBody": "={\n  \"model\": \"gpt-4o-mini\",\n  \"messages\": [\n    {\"role\": \"system\", \"content\": {{ JSON.stringify($json.system_prompt) }}},\n    {\"role\": \"user\", \"content\": {{ JSON.stringify($json.message_text) }}}\n  ],\n  \"temperature\": 0.7,\n  \"max_tokens\": 1500,\n  \"response_format\": {\"type\": \"json_object\"}\n}"
                },
                "name": "Call OpenAI",
                "type": "n8n-nodes-base.httpRequest",
                "typeVersion": 4.2,
                "position": [
                    2840,
                    500
                ],
                "credentials": {
                    "openAiApi": {
                        "id": "koikxNcf4ds6vKgZ",
                        "name": "OpenAI - Running Coach"
                    }
                }
            },
            {
                "id": "extract-response",
                "parameters": {
                    "functionCode": "const response = items[0].json;\nconst prepareData = $('Prepare Data').first().json;\nconst aiContent = response.choices[0].message.content;\n\nlet extracted = {};\nlet responseText = aiContent;\n\ntry {\n  const parsed = JSON.parse(aiContent);\n  extracted = parsed.extracted || {};\n  responseText = parsed.response || aiContent;\n} catch (e) {}\n\nresponseText = responseText.replace(/\\*/g, 'â€¢').replace(/_/g, ' ').replace(/`/g, \"'\").replace(/\\[/g, '(').replace(/\\]/g, ')');\n\nreturn [{\n  json: {\n    user_id: prepareData.user_id,\n    chat_id: prepareData.chat_id,\n    response_text: responseText,\n    onboarding_stage: prepareData.onboarding_stage,\n    next_stage: prepareData.next_stage,\n    extracted_data: extracted,\n    is_plan_generation: prepareData.is_plan_generation,\n    weekly_runs: prepareData.weekly_runs\n  }\n}];"
                },
                "name": "Extract Response",
                "type": "n8n-nodes-base.function",
                "typeVersion": 1,
                "position": [
                    3040,
                    500
                ]
            },
            {
                "id": "send-telegram",
                "parameters": {
                    "operation": "sendMessage",
                    "chatId": "={{ $json.chat_id.toString() }}",
                    "text": "={{ $json.response_text }}",
                    "additionalFields": {
                        "appendAttribution": false
                    }
                },
                "name": "Send to Telegram",
                "type": "n8n-nodes-base.telegram",
                "typeVersion": 1.2,
                "position": [
                    3240,
                    500
                ],
                "credentials": {
                    "telegramApi": {
                        "id": "SLNhx6dJUSPFBV35",
                        "name": "Telegram Bot - Running Coach"
                    }
                }
            },
            {
                "id": "is-onboarding",
                "parameters": {
                    "conditions": {
                        "options": {
                            "caseSensitive": true,
                            "typeValidation": "strict"
                        },
                        "conditions": [
                            {
                                "id": "c1",
                                "leftValue": "={{ $('Extract Response').first().json.onboarding_stage }}",
                                "rightValue": "completed",
                                "operator": {
                                    "type": "string",
                                    "operation": "notEquals"
                                }
                            }
                        ],
                        "combinator": "and"
                    }
                },
                "name": "Is Onboarding?",
                "type": "n8n-nodes-base.if",
                "typeVersion": 2,
                "position": [
                    3440,
                    500
                ]
            },
            {
                "id": "build-update",
                "parameters": {
                    "functionCode": "const data = $('Extract Response').first().json;\nconst ext = data.extracted_data || {};\nconst updateFields = {};\nlet nextStage = data.next_stage;\n\nif (data.onboarding_stage === 'started') updateFields.goal = 'race';\nif (data.onboarding_stage === 'strategy_preview' && ext.strategy_generated) nextStage = 'completed';\nif (nextStage && nextStage !== data.onboarding_stage) updateFields.onboarding_stage = nextStage;\n\n['level','age','height_cm','weight_kg','current_5k_pace_seconds','weekly_runs','race_distance','race_date','target_time_seconds','resting_hr','max_hr','has_lab_testing','vo2max','lthr'].forEach(k => { if (ext[k] !== undefined) updateFields[k] = ext[k]; });\n\nreturn [{\n  json: {\n    user_id: data.user_id,\n    update_fields: updateFields,\n    has_updates: Object.keys(updateFields).length > 0,\n    is_strategy_stage: data.onboarding_stage === 'strategy_preview' && ext.strategy_generated === true\n  }\n}];"
                },
                "name": "Build Update Data",
                "type": "n8n-nodes-base.function",
                "typeVersion": 1,
                "position": [
                    3640,
                    400
                ]
            },
            {
                "id": "has-updates",
                "parameters": {
                    "conditions": {
                        "options": {
                            "caseSensitive": true,
                            "typeValidation": "strict"
                        },
                        "conditions": [
                            {
                                "id": "c1",
                                "leftValue": "={{ $json.has_updates }}",
                                "rightValue": true,
                                "operator": {
                                    "type": "boolean",
                                    "operation": "equals"
                                }
                            }
                        ],
                        "combinator": "and"
                    }
                },
                "name": "Has Updates?",
                "type": "n8n-nodes-base.if",
                "typeVersion": 2,
                "position": [
                    3840,
                    400
                ]
            },
            {
                "id": "update-user",
                "parameters": {
                    "operation": "update",
                    "tableId": "users",
                    "filterType": "manual",
                    "matchType": "allFilters",
                    "filters": {
                        "conditions": [
                            {
                                "keyName": "id",
                                "condition": "eq",
                                "keyValue": "={{ $json.user_id }}"
                            }
                        ]
                    },
                    "dataToSend": "defineBelow",
                    "fieldsUi": {
                        "fieldValues": [
                            {
                                "fieldId": "onboarding_stage",
                                "fieldValue": "={{ $json.update_fields.onboarding_stage }}"
                            },
                            {
                                "fieldId": "level",
                                "fieldValue": "={{ $json.update_fields.level }}"
                            },
                            {
                                "fieldId": "age",
                                "fieldValue": "={{ $json.update_fields.age }}"
                            },
                            {
                                "fieldId": "weekly_runs",
                                "fieldValue": "={{ $json.update_fields.weekly_runs }}"
                            },
                            {
                                "fieldId": "race_date",
                                "fieldValue": "={{ $json.update_fields.race_date }}"
                            },
                            {
                                "fieldId": "race_distance",
                                "fieldValue": "={{ $json.update_fields.race_distance }}"
                            },
                            {
                                "fieldId": "resting_hr",
                                "fieldValue": "={{ $json.update_fields.resting_hr }}"
                            }
                        ]
                    }
                },
                "name": "Update User Profile",
                "type": "n8n-nodes-base.supabase",
                "typeVersion": 1,
                "position": [
                    4040,
                    300
                ],
                "credentials": {
                    "supabaseApi": {
                        "id": "CJ3Z1MvRt6BxblaB",
                        "name": "Supabase - Running Coach"
                    }
                }
            },
            {
                "id": "is-plan-gen",
                "parameters": {
                    "conditions": {
                        "options": {
                            "caseSensitive": true,
                            "typeValidation": "strict"
                        },
                        "conditions": [
                            {
                                "id": "c1",
                                "leftValue": "={{ $('Extract Response').first().json.is_plan_generation }}",
                                "rightValue": true,
                                "operator": {
                                    "type": "boolean",
                                    "operation": "equals"
                                }
                            }
                        ],
                        "combinator": "and"
                    }
                },
                "name": "Is Plan Generation?",
                "type": "n8n-nodes-base.if",
                "typeVersion": 2,
                "position": [
                    3640,
                    600
                ]
            },
            {
                "id": "save-plan",
                "parameters": {
                    "operation": "create",
                    "tableId": "weekly_plans",
                    "dataToSend": "defineBelow",
                    "fieldsUi": {
                        "fieldValues": [
                            {
                                "fieldId": "user_id",
                                "fieldValue": "={{ $('Extract Response').first().json.user_id }}"
                            },
                            {
                                "fieldId": "week_start",
                                "fieldValue": "={{ $now.format('yyyy-MM-dd') }}"
                            },
                            {
                                "fieldId": "plan_data",
                                "fieldValue": "={{ JSON.stringify({raw_plan: $('Extract Response').first().json.response_text}) }}"
                            },
                            {
                                "fieldId": "status",
                                "fieldValue": "active"
                            }
                        ]
                    }
                },
                "name": "Save Plan",
                "type": "n8n-nodes-base.supabase",
                "typeVersion": 1,
                "position": [
                    3840,
                    600
                ],
                "credentials": {
                    "supabaseApi": {
                        "id": "CJ3Z1MvRt6BxblaB",
                        "name": "Supabase - Running Coach"
                    }
                }
            },
            {
                "id": "download-photo-telegram",
                "parameters": {
                    "resource": "file",
                    "operation": "get",
                    "fileId": "={{ $(\"Check User\").first().json.photo_file_id }}",
                    "download": true
                },
                "name": "Download Photo",
                "type": "n8n-nodes-base.telegram",
                "typeVersion": 1.2,
                "position": [
                    1640,
                    200
                ],
                "credentials": {
                    "telegramApi": {
                        "id": "SLNhx6dJUSPFBV35",
                        "name": "Telegram Bot - Running Coach"
                    }
                }
            },
            {
                "id": "move-binary-to-json",
                "parameters": {
                    "mode": "binaryToJson",
                    "setAllData": false,
                    "sourceKey": "data",
                    "destinationKey": "base64_image",
                    "options": {
                        "keepAsBase64": true
                    }
                },
                "name": "Binary to Base64",
                "type": "n8n-nodes-base.moveBinaryData",
                "typeVersion": 1,
                "position": [
                    1840,
                    200
                ]
            },
            {
                "id": "prepare-vision-data",
                "parameters": {
                    "functionCode": "const checkUserData = $(\"Check User\").first().json;\nconst base64Data = items[0].json.base64_image;\n\nreturn [{\n  json: {\n    user_id: checkUserData.user_id,\n    chat_id: checkUserData.chat_id,\n    message_text: checkUserData.message_text,\n    message_id: checkUserData.message_id,\n    base64_image: base64Data,\n    mime_type: \"image/jpeg\"\n  }\n}];"
                },
                "name": "Prepare Vision Data",
                "type": "n8n-nodes-base.function",
                "typeVersion": 1,
                "position": [
                    2040,
                    200
                ]
            },
            {
                "id": "call-gpt4o-vision",
                "parameters": {
                    "method": "POST",
                    "url": "https://api.openai.com/v1/chat/completions",
                    "authentication": "predefinedCredentialType",
                    "nodeCredentialType": "openAiApi",
                    "sendBody": true,
                    "specifyBody": "json",
                    "jsonBody": "={\n  \"model\": \"gpt-4o\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Ð Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð¹ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÑƒ Ñ Ñ„Ð¾Ñ‚Ð¾. Ð’ÐµÑ€Ð½Ð¸ JSON: {\\\"recognized\\\": true/false, \\\"data\\\": {\\\"distance_km\\\": Ñ‡Ð¸ÑÐ»Ð¾, \\\"duration_seconds\\\": Ñ‡Ð¸ÑÐ»Ð¾, \\\"avg_pace_seconds\\\": Ñ‡Ð¸ÑÐ»Ð¾, \\\"avg_heart_rate\\\": Ñ‡Ð¸ÑÐ»Ð¾ Ð¸Ð»Ð¸ null, \\\"type\\\": \\\"easy_run\\\"/\\\"tempo\\\"/\\\"intervals\\\"}, \\\"response\\\": \\\"Ñ‚ÐµÐºÑÑ‚\\\"}\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"image_url\",\n          \"image_url\": {\n            \"url\": \"data:{{ $json.mime_type }};base64,{{ $json.base64_image }}\"\n          }\n        },\n        {\n          \"type\": \"text\", \n          \"text\": \"Ð Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð¹ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÑƒ\"\n        }\n      ]\n    }\n  ],\n  \"max_tokens\": 500,\n  \"response_format\": {\"type\": \"json_object\"}\n}"
                },
                "name": "GPT-4o Vision",
                "type": "n8n-nodes-base.httpRequest",
                "typeVersion": 4.2,
                "position": [
                    2240,
                    200
                ],
                "credentials": {
                    "openAiApi": {
                        "id": "koikxNcf4ds6vKgZ",
                        "name": "OpenAI - Running Coach"
                    }
                }
            },
            {
                "id": "get-strategy",
                "parameters": {
                    "operation": "getAll",
                    "tableId": "training_strategies",
                    "returnAll": false,
                    "limit": 1,
                    "filterType": "manual",
                    "matchType": "allFilters",
                    "filters": {
                        "conditions": [
                            {
                                "keyName": "user_id",
                                "condition": "eq",
                                "keyValue": "={{ $('Check User').first().json.user_id }}"
                            },
                            {
                                "keyName": "status",
                                "condition": "eq",
                                "keyValue": "active"
                            }
                        ]
                    },
                    "options": {
                        "orderByColumn": "created_at",
                        "orderType": "desc"
                    }
                },
                "name": "Get Strategy",
                "type": "n8n-nodes-base.supabase",
                "typeVersion": 1,
                "position": [
                    2140,
                    600
                ],
                "alwaysOutputData": true,
                "credentials": {
                    "supabaseApi": {
                        "id": "CJ3Z1MvRt6BxblaB",
                        "name": "Supabase - Running Coach"
                    }
                }
            },
            {
                "id": "is-strategy-stage",
                "parameters": {
                    "conditions": {
                        "options": {
                            "caseSensitive": true,
                            "typeValidation": "strict"
                        },
                        "conditions": [
                            {
                                "id": "strategy-check",
                                "leftValue": "={{ $('Build Update Data').first().json.is_strategy_stage }}",
                                "rightValue": true,
                                "operator": {
                                    "type": "boolean",
                                    "operation": "equals"
                                }
                            }
                        ],
                        "combinator": "and"
                    }
                },
                "name": "Is Strategy Stage?",
                "type": "n8n-nodes-base.if",
                "typeVersion": 2,
                "position": [
                    4240,
                    300
                ]
            },
            {
                "id": "save-strategy",
                "parameters": {
                    "operation": "create",
                    "tableId": "training_strategies",
                    "dataToSend": "defineBelow",
                    "fieldsUi": {
                        "fieldValues": [
                            {
                                "fieldId": "user_id",
                                "fieldValue": "={{ $('Extract Response').first().json.user_id }}"
                            },
                            {
                                "fieldId": "goal_type",
                                "fieldValue": "race"
                            },
                            {
                                "fieldId": "race_distance",
                                "fieldValue": "={{ $('Extract Response').first().json.extracted_data.race_distance }}"
                            },
                            {
                                "fieldId": "race_date",
                                "fieldValue": "={{ $('Extract Response').first().json.extracted_data.race_date }}"
                            },
                            {
                                "fieldId": "target_time_seconds",
                                "fieldValue": "={{ $('Extract Response').first().json.extracted_data.target_time_seconds }}"
                            },
                            {
                                "fieldId": "total_weeks",
                                "fieldValue": "={{ $('Extract Response').first().json.extracted_data.total_weeks }}"
                            },
                            {
                                "fieldId": "phases",
                                "fieldValue": "={{ JSON.stringify($('Extract Response').first().json.extracted_data.phases) }}"
                            },
                            {
                                "fieldId": "summary",
                                "fieldValue": "={{ $('Extract Response').first().json.extracted_data.strategy_summary }}"
                            },
                            {
                                "fieldId": "start_date",
                                "fieldValue": "={{ $now.format('yyyy-MM-dd') }}"
                            },
                            {
                                "fieldId": "end_date",
                                "fieldValue": "={{ $('Extract Response').first().json.extracted_data.race_date }}"
                            },
                            {
                                "fieldId": "status",
                                "fieldValue": "active"
                            }
                        ]
                    }
                },
                "name": "Save Strategy",
                "type": "n8n-nodes-base.supabase",
                "typeVersion": 1,
                "position": [
                    4440,
                    200
                ],
                "credentials": {
                    "supabaseApi": {
                        "id": "CJ3Z1MvRt6BxblaB",
                        "name": "Supabase - Running Coach"
                    }
                }
            }
        ],
        "connections": {
            "TelegramTrigger": {
                "main": [
                    [
                        {
                            "node": "Extract Message",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Extract Message": {
                "main": [
                    [
                        {
                            "node": "Get User",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Get User": {
                "main": [
                    [
                        {
                            "node": "Check User",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Check User": {
                "main": [
                    [
                        {
                            "node": "Show Typing",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Show Typing": {
                "main": [
                    [
                        {
                            "node": "Route After Typing",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Route After Typing": {
                "main": [
                    [
                        {
                            "node": "Is Photo?",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Is Photo?": {
                "main": [
                    [
                        {
                            "node": "Download Photo",
                            "type": "main",
                            "index": 0
                        }
                    ],
                    [
                        {
                            "node": "User Not Found?",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "GPT-4o Vision": {
                "main": [
                    [
                        {
                            "node": "Parse Vision Response",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Parse Vision Response": {
                "main": [
                    [
                        {
                            "node": "Training Recognized?",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Training Recognized?": {
                "main": [
                    [
                        {
                            "node": "Save Photo Training",
                            "type": "main",
                            "index": 0
                        }
                    ],
                    [
                        {
                            "node": "Send Not Recognized",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Save Photo Training": {
                "main": [
                    [
                        {
                            "node": "Format Photo Response",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Format Photo Response": {
                "main": [
                    [
                        {
                            "node": "Send Photo Response",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "User Not Found?": {
                "main": [
                    [
                        {
                            "node": "Create User",
                            "type": "main",
                            "index": 0
                        }
                    ],
                    [
                        {
                            "node": "Get Active Plan",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Create User": {
                "main": [
                    [
                        {
                            "node": "Get User Again",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Get User Again": {
                "main": [
                    [
                        {
                            "node": "Prepare New User Data",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Prepare New User Data": {
                "main": [
                    [
                        {
                            "node": "Merge User Flows",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Get Active Plan": {
                "main": [
                    [
                        {
                            "node": "Get Recent Trainings",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Get Recent Trainings": {
                "main": [
                    [
                        {
                            "node": "Get Strategy",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Merge Context": {
                "main": [
                    [
                        {
                            "node": "Merge User Flows",
                            "type": "main",
                            "index": 1
                        }
                    ]
                ]
            },
            "Merge User Flows": {
                "main": [
                    [
                        {
                            "node": "Prepare Data",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Prepare Data": {
                "main": [
                    [
                        {
                            "node": "Call OpenAI",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Call OpenAI": {
                "main": [
                    [
                        {
                            "node": "Extract Response",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Extract Response": {
                "main": [
                    [
                        {
                            "node": "Send to Telegram",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Send to Telegram": {
                "main": [
                    [
                        {
                            "node": "Is Onboarding?",
                            "type": "main",
                            "index": 0
                        },
                        {
                            "node": "Is Plan Generation?",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Is Onboarding?": {
                "main": [
                    [
                        {
                            "node": "Build Update Data",
                            "type": "main",
                            "index": 0
                        }
                    ],
                    []
                ]
            },
            "Build Update Data": {
                "main": [
                    [
                        {
                            "node": "Has Updates?",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Has Updates?": {
                "main": [
                    [
                        {
                            "node": "Update User Profile",
                            "type": "main",
                            "index": 0
                        }
                    ],
                    []
                ]
            },
            "Is Plan Generation?": {
                "main": [
                    [
                        {
                            "node": "Save Plan",
                            "type": "main",
                            "index": 0
                        }
                    ],
                    []
                ]
            },
            "Download Photo": {
                "main": [
                    [
                        {
                            "node": "Binary to Base64",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Binary to Base64": {
                "main": [
                    [
                        {
                            "node": "Prepare Vision Data",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Prepare Vision Data": {
                "main": [
                    [
                        {
                            "node": "GPT-4o Vision",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Get Strategy": {
                "main": [
                    [
                        {
                            "node": "Merge Context",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Update User Profile": {
                "main": [
                    [
                        {
                            "node": "Is Strategy Stage?",
                            "type": "main",
                            "index": 0
                        }
                    ]
                ]
            },
            "Is Strategy Stage?": {
                "main": [
                    [
                        {
                            "node": "Save Strategy",
                            "type": "main",
                            "index": 0
                        }
                    ],
                    []
                ]
            }
        },
        "authors": "Nikita Kuznetsov",
        "name": null,
        "description": null,
        "autosaved": false,
        "workflowPublishHistory": [
            {
                "createdAt": "2026-02-06T23:32:40.268Z",
                "id": 427,
                "workflowId": "7Ar459SadzSXgUEv",
                "versionId": "7ae6bb6d-8da4-4b38-8e71-009144a2fa42",
                "event": "activated",
                "userId": "70308841-4ee1-48e9-854d-73f215836be6"
            }
        ]
    }
}