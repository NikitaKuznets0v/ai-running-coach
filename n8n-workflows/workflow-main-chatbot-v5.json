{
  "name": "AI Running Coach - Main Chatbot v5 (Photo + Stats)",
  "nodes": [
    {
      "id": "telegram-trigger",
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "name": "TelegramTrigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [240, 400],
      "credentials": {
        "telegramApi": {
          "id": "SLNhx6dJUSPFBV35",
          "name": "Telegram Bot - Running Coach"
        }
      }
    },
    {
      "id": "extract-message",
      "parameters": {
        "functionCode": "const msg = items[0].json.message;\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è\nlet messageType = 'text';\nlet photoFileId = null;\nlet photoCaption = '';\n\nif (msg.photo && msg.photo.length > 0) {\n  messageType = 'photo';\n  // –ë–µ—Ä—ë–º —Ñ–æ—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤ –º–∞—Å—Å–∏–≤–µ)\n  photoFileId = msg.photo[msg.photo.length - 1].file_id;\n  photoCaption = msg.caption || '';\n}\n\nreturn [{\n  json: {\n    telegram_id: msg.from.id,\n    chat_id: msg.chat.id,\n    username: msg.from.username || '',\n    first_name: msg.from.first_name || '–î—Ä—É–≥',\n    last_name: msg.from.last_name || '',\n    message_text: msg.text || photoCaption || '',\n    message_id: msg.message_id,\n    message_type: messageType,\n    photo_file_id: photoFileId\n  }\n}];"
      },
      "name": "Extract Message",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [440, 400]
    },
    {
      "id": "get-user",
      "parameters": {
        "operation": "getAll",
        "tableId": "users",
        "returnAll": false,
        "limit": 1,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_id",
              "condition": "eq",
              "keyValue": "={{ $json.telegram_id }}"
            }
          ]
        }
      },
      "name": "Get User",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [640, 400],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    },
    {
      "id": "check-user",
      "parameters": {
        "functionCode": "const messageData = $('Extract Message').first().json;\n\nif (items.length === 0 || !items[0].json || !items[0].json.id) {\n  return [{\n    json: {\n      userExists: false,\n      telegram_id: messageData.telegram_id,\n      chat_id: messageData.chat_id,\n      username: messageData.username,\n      first_name: messageData.first_name,\n      last_name: messageData.last_name,\n      message_text: messageData.message_text,\n      message_id: messageData.message_id,\n      message_type: messageData.message_type,\n      photo_file_id: messageData.photo_file_id\n    }\n  }];\n} else {\n  const userData = items[0].json;\n  return [{\n    json: {\n      userExists: true,\n      user_id: userData.id,\n      telegram_id: userData.telegram_id,\n      first_name: userData.first_name || messageData.first_name,\n      onboarding_stage: userData.onboarding_stage || 'started',\n      level: userData.level,\n      age: userData.age,\n      height_cm: userData.height_cm,\n      weight_kg: userData.weight_kg,\n      weekly_runs: userData.weekly_runs,\n      goal: userData.goal,\n      current_5k_pace_seconds: userData.current_5k_pace_seconds,\n      race_date: userData.race_date,\n      race_distance: userData.race_distance,\n      target_time_seconds: userData.target_time_seconds,\n      resting_hr: userData.resting_hr,\n      max_hr: userData.max_hr,\n      has_lab_testing: userData.has_lab_testing,\n      vo2max: userData.vo2max,\n      lthr: userData.lthr,\n      hr_zone1_max: userData.hr_zone1_max,\n      hr_zone2_max: userData.hr_zone2_max,\n      hr_zone3_max: userData.hr_zone3_max,\n      hr_zone4_max: userData.hr_zone4_max,\n      hr_zone5_max: userData.hr_zone5_max,\n      chat_id: messageData.chat_id,\n      message_text: messageData.message_text,\n      message_id: messageData.message_id,\n      message_type: messageData.message_type,\n      photo_file_id: messageData.photo_file_id\n    }\n  }];\n}"
      },
      "name": "Check User",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [840, 400]
    },
    {
      "id": "is-photo",
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "photo-check",
              "leftValue": "={{ $json.message_type }}",
              "rightValue": "photo",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "completed-check",
              "leftValue": "={{ $json.onboarding_stage }}",
              "rightValue": "completed",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "name": "Is Photo?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1040, 400]
    },
    {
      "id": "get-photo-file",
      "parameters": {
        "resource": "file",
        "operation": "get",
        "fileId": "={{ $json.photo_file_id }}",
        "download": true
      },
      "name": "Download Photo",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1240, 200],
      "credentials": {
        "telegramApi": {
          "id": "SLNhx6dJUSPFBV35",
          "name": "Telegram Bot - Running Coach"
        }
      }
    },
    {
      "id": "prepare-photo-url",
      "parameters": {
        "functionCode": "const checkUserData = $('Check User').first().json;\n\n// –ü–æ–ª—É—á–∞–µ–º –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è\nlet base64Image = '';\nlet mimeType = 'image/jpeg';\n\n// –í n8n Function node –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ items[0].binary\nif (items[0].binary) {\n  const binaryKeys = Object.keys(items[0].binary);\n  if (binaryKeys.length > 0) {\n    const binaryKey = binaryKeys[0];\n    const binaryItem = items[0].binary[binaryKey];\n    \n    if (binaryItem) {\n      base64Image = binaryItem.data;\n      mimeType = binaryItem.mimeType || 'image/jpeg';\n    }\n  }\n}\n\nreturn [{\n  json: {\n    user_id: checkUserData.user_id,\n    chat_id: checkUserData.chat_id,\n    message_text: checkUserData.message_text,\n    message_id: checkUserData.message_id,\n    base64_image: base64Image,\n    mime_type: mimeType,\n    has_image: base64Image.length > 0\n  }\n}];"
      },
      "name": "Prepare Image Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1440, 200]
    },
    {
      "id": "call-gpt4o-vision",
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"–¢—ã ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –±–µ–≥–æ–≤—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.\\n\\n–ê–ù–ê–õ–ò–ó–ò–†–£–ô –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –∏–∑–≤–ª–µ–∫–∏ –¥–∞–Ω–Ω—ã–µ –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ.\\n\\n–ò–©–ò –ù–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ò:\\n‚Ä¢ –î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º –∏–ª–∏ –º)\\n‚Ä¢ –í—Ä–µ–º—è/–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\\n‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Ç–µ–º–ø (–º–∏–Ω:—Å–µ–∫ –Ω–∞ –∫–º)\\n‚Ä¢ –°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å (–µ—Å–ª–∏ –µ—Å—Ç—å)\\n‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª—å—Å (–µ—Å–ª–∏ –µ—Å—Ç—å)\\n‚Ä¢ –ö–∞–ª–æ—Ä–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)\\n‚Ä¢ –ù–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)\\n\\n–í–ï–†–ù–ò –°–¢–†–û–ì–û JSON:\\n{\\n  \\\"recognized\\\": true/false,\\n  \\\"confidence\\\": \\\"high\\\"/\\\"medium\\\"/\\\"low\\\",\\n  \\\"data\\\": {\\n    \\\"distance_km\\\": —á–∏—Å–ª–æ –∏–ª–∏ null,\\n    \\\"duration_seconds\\\": —á–∏—Å–ª–æ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –∏–ª–∏ null,\\n    \\\"avg_pace_seconds\\\": —á–∏—Å–ª–æ (—Å–µ–∫/–∫–º) –∏–ª–∏ null,\\n    \\\"avg_heart_rate\\\": —á–∏—Å–ª–æ –∏–ª–∏ null,\\n    \\\"max_heart_rate\\\": —á–∏—Å–ª–æ –∏–ª–∏ null,\\n    \\\"calories\\\": —á–∏—Å–ª–æ –∏–ª–∏ null,\\n    \\\"elevation_gain_m\\\": —á–∏—Å–ª–æ –∏–ª–∏ null,\\n    \\\"type\\\": \\\"easy_run\\\"/\\\"long_run\\\"/\\\"tempo\\\"/\\\"intervals\\\"/\\\"recovery\\\"\\n  },\\n  \\\"source_app\\\": \\\"–Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –µ—Å–ª–∏ —É–∑–Ω–∞–ª\\\",\\n  \\\"response\\\": \\\"–∫—Ä–∞—Ç–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\\\"\\n}\\n\\n–ü–†–ê–í–ò–õ–ê –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò:\\n‚Ä¢ –¢–µ–º–ø 5:30/–∫–º = 330 —Å–µ–∫—É–Ω–¥\\n‚Ä¢ –í—Ä–µ–º—è 45:30 = 2730 —Å–µ–∫—É–Ω–¥\\n‚Ä¢ –î–∏—Å—Ç–∞–Ω—Ü–∏—è 5.2–∫–º = 5.2\\n‚Ä¢ –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ—á—ë—Ç–∫–∏–µ, confidence = \\\"low\\\"\\n\\n–ï—Å–ª–∏ –ù–ï —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É:\\n{\\n  \\\"recognized\\\": false,\\n  \\\"response\\\": \\\"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π –ø—Ä–∏—Å–ª–∞—Ç—å –±–æ–ª–µ–µ —á—ë—Ç–∫–∏–π —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ–∫—Å—Ç–æ–º.\\\"\\n}\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"image_url\",\n          \"image_url\": {\n            \"url\": \"data:{{ $json.mime_type }};base64,{{ $json.base64_image }}\"\n          }\n        },\n        {\n          \"type\": \"text\",\n          \"text\": \"{{ $json.message_text ? '–ü–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ: ' + $json.message_text : '–†–∞—Å–ø–æ–∑–Ω–∞–π –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å —ç—Ç–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è' }}\"\n        }\n      ]\n    }\n  ],\n  \"max_tokens\": 500,\n  \"response_format\": {\"type\": \"json_object\"}\n}"
      },
      "name": "GPT-4o Vision",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1640, 200],
      "credentials": {
        "openAiApi": {
          "id": "koikxNcf4ds6vKgZ",
          "name": "OpenAI - Running Coach"
        }
      }
    },
    {
      "id": "parse-vision-response",
      "parameters": {
        "functionCode": "const checkUserData = $('Check User').first().json;\nconst visionResponse = items[0].json;\nconst aiContent = visionResponse.choices[0].message.content;\n\nlet parsed;\ntry {\n  parsed = JSON.parse(aiContent);\n} catch (e) {\n  parsed = {\n    recognized: false,\n    response: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ–∫—Å—Ç–æ–º.'\n  };\n}\n\n// –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è Telegram\nlet responseText = parsed.response || '–§–æ—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ';\nresponseText = responseText\n  .replace(/\\*/g, '‚Ä¢')\n  .replace(/_/g, ' ')\n  .replace(/`/g, \"'\")\n  .replace(/\\[/g, '(')\n  .replace(/\\]/g, ')');\n\nreturn [{\n  json: {\n    user_id: checkUserData.user_id,\n    chat_id: checkUserData.chat_id,\n    message_id: checkUserData.message_id,\n    recognized: parsed.recognized || false,\n    confidence: parsed.confidence || 'low',\n    training_data: parsed.data || null,\n    source_app: parsed.source_app || null,\n    response_text: responseText,\n    is_photo_training: true\n  }\n}];"
      },
      "name": "Parse Vision Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1840, 200]
    },
    {
      "id": "is-training-recognized",
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "recognized-check",
              "leftValue": "={{ $json.recognized }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "name": "Training Recognized?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2040, 200]
    },
    {
      "id": "save-photo-training",
      "parameters": {
        "operation": "create",
        "tableId": "trainings",
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id }}"
            },
            {
              "fieldId": "date",
              "fieldValue": "={{ $now.format('yyyy-MM-dd') }}"
            },
            {
              "fieldId": "day_of_week",
              "fieldValue": "={{ $now.format('EEEE').toLowerCase() }}"
            },
            {
              "fieldId": "type",
              "fieldValue": "={{ $json.training_data.type || 'easy_run' }}"
            },
            {
              "fieldId": "distance_km",
              "fieldValue": "={{ $json.training_data.distance_km }}"
            },
            {
              "fieldId": "duration_seconds",
              "fieldValue": "={{ $json.training_data.duration_seconds }}"
            },
            {
              "fieldId": "avg_pace_seconds",
              "fieldValue": "={{ $json.training_data.avg_pace_seconds }}"
            },
            {
              "fieldId": "avg_heart_rate",
              "fieldValue": "={{ $json.training_data.avg_heart_rate }}"
            },
            {
              "fieldId": "max_heart_rate",
              "fieldValue": "={{ $json.training_data.max_heart_rate }}"
            },
            {
              "fieldId": "calories",
              "fieldValue": "={{ $json.training_data.calories }}"
            },
            {
              "fieldId": "elevation_gain_m",
              "fieldValue": "={{ $json.training_data.elevation_gain_m }}"
            },
            {
              "fieldId": "source",
              "fieldValue": "screenshot"
            },
            {
              "fieldId": "is_planned",
              "fieldValue": "={{ false }}"
            }
          ]
        }
      },
      "name": "Save Photo Training",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2240, 100],
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    },
    {
      "id": "update-user-stats",
      "parameters": {
        "functionCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\nconst parseResponse = $('Parse Vision Response').first().json;\nconst trainingData = parseResponse.training_data;\nconst userId = parseResponse.user_id;\n\nif (!trainingData || !trainingData.distance_km) {\n  return [{ json: parseResponse }];\n}\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è stats\nreturn [{\n  json: {\n    ...parseResponse,\n    stats_update: {\n      distance_to_add: trainingData.distance_km,\n      duration_to_add: trainingData.duration_seconds || 0\n    }\n  }\n}];"
      },
      "name": "Prepare Stats Update",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2440, 100]
    },
    {
      "id": "get-user-stats",
      "parameters": {
        "operation": "getAll",
        "tableId": "user_stats",
        "returnAll": false,
        "limit": 1,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $json.user_id }}"
            }
          ]
        }
      },
      "name": "Get User Stats",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2640, 100],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    },
    {
      "id": "upsert-user-stats",
      "parameters": {
        "functionCode": "const prevData = $('Prepare Stats Update').first().json;\nconst statsItems = items;\nconst statsUpdate = prevData.stats_update;\n\nlet existingStats = null;\nif (statsItems.length > 0 && statsItems[0].json && statsItems[0].json.id) {\n  existingStats = statsItems[0].json;\n}\n\nconst now = new Date();\nconst today = now.toISOString().split('T')[0];\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)\nconst dayOfWeek = now.getDay();\nconst mondayOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;\nconst monday = new Date(now);\nmonday.setDate(now.getDate() - mondayOffset);\nconst weekStart = monday.toISOString().split('T')[0];\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞\nconst monthStart = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-01`;\n\nif (existingStats) {\n  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å\n  const lastTrainingDate = existingStats.last_training_date;\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –Ω–µ–¥–µ–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n  let weekDistance = existingStats.week_distance_km || 0;\n  let weekTrainings = existingStats.week_trainings || 0;\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –º–µ—Å—è—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n  let monthDistance = existingStats.month_distance_km || 0;\n  let monthTrainings = existingStats.month_trainings || 0;\n  \n  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∏–∫\n  let currentStreak = existingStats.current_streak_days || 0;\n  if (lastTrainingDate) {\n    const lastDate = new Date(lastTrainingDate);\n    const diffDays = Math.floor((now - lastDate) / (24 * 60 * 60 * 1000));\n    if (diffDays > 1) {\n      currentStreak = 1; // –°—Ç—Ä–∏–∫ –ø—Ä–µ—Ä–≤–∞–ª—Å—è\n    } else if (diffDays === 1) {\n      currentStreak += 1;\n    }\n    // –ï—Å–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å - —Å—Ç—Ä–∏–∫ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è\n  } else {\n    currentStreak = 1;\n  }\n  \n  const longestStreak = Math.max(existingStats.longest_streak_days || 0, currentStreak);\n  \n  return [{\n    json: {\n      operation: 'update',\n      stats_id: existingStats.id,\n      user_id: prevData.user_id,\n      total_distance_km: (existingStats.total_distance_km || 0) + statsUpdate.distance_to_add,\n      total_trainings: (existingStats.total_trainings || 0) + 1,\n      total_duration_seconds: (existingStats.total_duration_seconds || 0) + statsUpdate.duration_to_add,\n      week_distance_km: weekDistance + statsUpdate.distance_to_add,\n      week_trainings: weekTrainings + 1,\n      month_distance_km: monthDistance + statsUpdate.distance_to_add,\n      month_trainings: monthTrainings + 1,\n      current_streak_days: currentStreak,\n      longest_streak_days: longestStreak,\n      last_training_date: today,\n      chat_id: prevData.chat_id,\n      response_text: prevData.response_text\n    }\n  }];\n} else {\n  // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å\n  return [{\n    json: {\n      operation: 'create',\n      user_id: prevData.user_id,\n      total_distance_km: statsUpdate.distance_to_add,\n      total_trainings: 1,\n      total_duration_seconds: statsUpdate.duration_to_add,\n      week_distance_km: statsUpdate.distance_to_add,\n      week_trainings: 1,\n      month_distance_km: statsUpdate.distance_to_add,\n      month_trainings: 1,\n      current_streak_days: 1,\n      longest_streak_days: 1,\n      last_training_date: today,\n      chat_id: prevData.chat_id,\n      response_text: prevData.response_text\n    }\n  }];\n}"
      },
      "name": "Calculate Stats",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2840, 100]
    },
    {
      "id": "is-stats-update",
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "update-check",
              "leftValue": "={{ $json.operation }}",
              "rightValue": "update",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "name": "Stats Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [3040, 100]
    },
    {
      "id": "update-stats-db",
      "parameters": {
        "operation": "update",
        "tableId": "user_stats",
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.stats_id }}"
            }
          ]
        },
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "total_distance_km",
              "fieldValue": "={{ $json.total_distance_km }}"
            },
            {
              "fieldId": "total_trainings",
              "fieldValue": "={{ $json.total_trainings }}"
            },
            {
              "fieldId": "total_duration_seconds",
              "fieldValue": "={{ $json.total_duration_seconds }}"
            },
            {
              "fieldId": "week_distance_km",
              "fieldValue": "={{ $json.week_distance_km }}"
            },
            {
              "fieldId": "week_trainings",
              "fieldValue": "={{ $json.week_trainings }}"
            },
            {
              "fieldId": "month_distance_km",
              "fieldValue": "={{ $json.month_distance_km }}"
            },
            {
              "fieldId": "month_trainings",
              "fieldValue": "={{ $json.month_trainings }}"
            },
            {
              "fieldId": "current_streak_days",
              "fieldValue": "={{ $json.current_streak_days }}"
            },
            {
              "fieldId": "longest_streak_days",
              "fieldValue": "={{ $json.longest_streak_days }}"
            },
            {
              "fieldId": "last_training_date",
              "fieldValue": "={{ $json.last_training_date }}"
            }
          ]
        }
      },
      "name": "Update Stats",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [3240, 0],
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    },
    {
      "id": "create-stats-db",
      "parameters": {
        "operation": "create",
        "tableId": "user_stats",
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id }}"
            },
            {
              "fieldId": "total_distance_km",
              "fieldValue": "={{ $json.total_distance_km }}"
            },
            {
              "fieldId": "total_trainings",
              "fieldValue": "={{ $json.total_trainings }}"
            },
            {
              "fieldId": "total_duration_seconds",
              "fieldValue": "={{ $json.total_duration_seconds }}"
            },
            {
              "fieldId": "week_distance_km",
              "fieldValue": "={{ $json.week_distance_km }}"
            },
            {
              "fieldId": "week_trainings",
              "fieldValue": "={{ $json.week_trainings }}"
            },
            {
              "fieldId": "month_distance_km",
              "fieldValue": "={{ $json.month_distance_km }}"
            },
            {
              "fieldId": "month_trainings",
              "fieldValue": "={{ $json.month_trainings }}"
            },
            {
              "fieldId": "current_streak_days",
              "fieldValue": "={{ $json.current_streak_days }}"
            },
            {
              "fieldId": "longest_streak_days",
              "fieldValue": "={{ $json.longest_streak_days }}"
            },
            {
              "fieldId": "last_training_date",
              "fieldValue": "={{ $json.last_training_date }}"
            }
          ]
        }
      },
      "name": "Create Stats",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [3240, 200],
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    },
    {
      "id": "merge-stats-result",
      "parameters": {
        "mode": "combine",
        "mergeByFields": {
          "values": []
        },
        "options": {}
      },
      "name": "Merge Stats",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [3440, 100]
    },
    {
      "id": "format-photo-response",
      "parameters": {
        "functionCode": "// –ë–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Calculate Stats (–¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î)\nlet calcData;\ntry {\n  calcData = $('Calculate Stats').first().json;\n} catch (e) {\n  calcData = items[0].json;\n}\n\nconst responseText = calcData.response_text || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∞–Ω–∞!';\n\nreturn [{\n  json: {\n    chat_id: calcData.chat_id,\n    response_text: responseText + ' üìä',\n    is_photo_training: true\n  }\n}];"
      },
      "name": "Format Photo Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [3640, 100]
    },
    {
      "id": "send-photo-response",
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $json.chat_id.toString() }}",
        "text": "={{ $json.response_text }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "name": "Send Photo Response",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [3840, 100],
      "credentials": {
        "telegramApi": {
          "id": "SLNhx6dJUSPFBV35",
          "name": "Telegram Bot - Running Coach"
        }
      }
    },
    {
      "id": "send-not-recognized",
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $json.chat_id.toString() }}",
        "text": "={{ $json.response_text }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "name": "Send Not Recognized",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [2240, 300],
      "credentials": {
        "telegramApi": {
          "id": "SLNhx6dJUSPFBV35",
          "name": "Telegram Bot - Running Coach"
        }
      }
    },
    {
      "id": "user-not-found",
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $json.userExists }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "name": "User Not Found?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1240, 500]
    },
    {
      "id": "get-active-plan",
      "parameters": {
        "operation": "getAll",
        "tableId": "weekly_plans",
        "returnAll": false,
        "limit": 1,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('Check User').first().json.user_id }}"
            },
            {
              "keyName": "status",
              "condition": "eq",
              "keyValue": "active"
            }
          ]
        },
        "options": {
          "orderByColumn": "created_at",
          "orderType": "desc"
        }
      },
      "name": "Get Active Plan",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1440, 600],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    },
    {
      "id": "get-trainings-for-stats",
      "parameters": {
        "operation": "getAll",
        "tableId": "trainings",
        "returnAll": false,
        "limit": 50,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('Check User').first().json.user_id }}"
            }
          ]
        },
        "options": {
          "orderByColumn": "date",
          "orderType": "desc"
        }
      },
      "name": "Get Recent Trainings",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1440, 700],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    },
    {
      "id": "merge-user-plan-stats",
      "parameters": {
        "functionCode": "const checkUserData = $('Check User').first().json;\nconst planItems = $('Get Active Plan').all();\nconst trainingItems = $('Get Recent Trainings').all();\n\nlet activePlan = null;\nif (planItems.length > 0 && planItems[0].json && planItems[0].json.id) {\n  activePlan = planItems[0].json;\n}\n\nlet recentTrainings = [];\nif (trainingItems.length > 0) {\n  recentTrainings = trainingItems.map(t => t.json);\n}\n\nreturn [{\n  json: {\n    ...checkUserData,\n    active_plan: activePlan,\n    recent_trainings: recentTrainings\n  }\n}];"
      },
      "name": "Merge User & Plan & Trainings",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1640, 600]
    },
    {
      "id": "create-user",
      "parameters": {
        "operation": "create",
        "tableId": "users",
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "telegram_id",
              "fieldValue": "={{ $json.telegram_id }}"
            },
            {
              "fieldId": "username",
              "fieldValue": "={{ $json.username }}"
            },
            {
              "fieldId": "first_name",
              "fieldValue": "={{ $json.first_name }}"
            },
            {
              "fieldId": "last_name",
              "fieldValue": "={{ $json.last_name }}"
            },
            {
              "fieldId": "onboarding_stage",
              "fieldValue": "started"
            },
            {
              "fieldId": "language",
              "fieldValue": "ru"
            }
          ]
        }
      },
      "name": "Create User",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1440, 400],
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    },
    {
      "id": "get-user-again",
      "parameters": {
        "operation": "getAll",
        "tableId": "users",
        "returnAll": false,
        "limit": 1,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_id",
              "condition": "eq",
              "keyValue": "={{ $('Check User').first().json.telegram_id }}"
            }
          ]
        }
      },
      "name": "Get User Again",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1640, 400],
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    },
    {
      "id": "prepare-data",
      "parameters": {
        "functionCode": "// RACE-ONLY + STATS Prepare Data v0.5.0\n// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ Check User –∏–ª–∏ Merge User & Plan)\nlet checkUserData;\ntry {\n  checkUserData = $('Merge User & Plan & Trainings').first().json;\n} catch (e) {\n  try {\n    checkUserData = $('Check User').first().json;\n  } catch (e2) {\n    checkUserData = items[0].json;\n  }\n}\n\nlet userData, messageData, activePlan, recentTrainings;\n\nif (checkUserData.userExists) {\n  userData = {\n    id: checkUserData.user_id,\n    first_name: checkUserData.first_name,\n    onboarding_stage: checkUserData.onboarding_stage || 'started',\n    level: checkUserData.level,\n    weekly_runs: checkUserData.weekly_runs,\n    age: checkUserData.age,\n    height_cm: checkUserData.height_cm,\n    weight_kg: checkUserData.weight_kg,\n    resting_hr: checkUserData.resting_hr,\n    max_hr: checkUserData.max_hr,\n    has_lab_testing: checkUserData.has_lab_testing,\n    vo2max: checkUserData.vo2max,\n    lthr: checkUserData.lthr,\n    current_5k_pace_seconds: checkUserData.current_5k_pace_seconds,\n    race_date: checkUserData.race_date,\n    race_distance: checkUserData.race_distance,\n    target_time_seconds: checkUserData.target_time_seconds\n  };\n  messageData = {\n    chat_id: checkUserData.chat_id,\n    message_text: checkUserData.message_text,\n    message_id: checkUserData.message_id\n  };\n  activePlan = checkUserData.active_plan || null;\n  recentTrainings = checkUserData.recent_trainings || [];\n} else {\n  userData = items[0].json;\n  userData.onboarding_stage = 'started';\n  messageData = {\n    chat_id: checkUserData.chat_id,\n    message_text: checkUserData.message_text,\n    message_id: checkUserData.message_id\n  };\n  activePlan = null;\n  recentTrainings = [];\n}\n\nconst message = messageData.message_text;\nconst stage = userData.onboarding_stage;\nconst firstName = userData.first_name || '–¥—Ä—É–≥';\n\nlet intent = 'general';\nlet systemPrompt = '';\nlet nextStage = stage;\nlet isPlanGeneration = false;\nlet isStrategyGeneration = false;\nlet isStatsRequest = false;\n\nconst JSON_FORMAT = `–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê ‚Äî –°–¢–†–û–ì–û JSON:\\n{\\n  \"extracted\": {...},\\n  \"response\": \"—Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞\"\\n}\\n\\n–í–ê–ñ–ù–û: –ø–æ–ª–µ \"response\" –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ß–ò–¢–ê–ï–ú–´–ô –¢–ï–ö–°–¢ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\\n–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã * _ \\` [ ] ‚Äî –æ–Ω–∏ –ª–æ–º–∞—é—Ç Telegram.\\n–ò—Å–ø–æ–ª—å–∑—É–π ‚Ä¢ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤, –æ–±—ã—á–Ω—ã–µ —Å–∫–æ–±–∫–∏ () –¥–ª—è –ø–æ—è—Å–Ω–µ–Ω–∏–π.`;\n\n// ============================================\n// –ü–†–û–í–ï–†–ö–ê –ù–ê –ó–ê–ü–†–û–° –°–¢–ê–¢–ò–°–¢–ò–ö–ò\n// ============================================\nconst statsPatterns = /—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫|–∫–∞–∫ —è (–ø–æ)?–±–µ–≥–∞–ª|–º–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç|—Å–∫–æ–ª—å–∫–æ (–ø—Ä–æ|–Ω–∞)–±–µ–≥–∞–ª|–ø—Ä–æ–≥—Ä–µ—Å—Å|–∏—Ç–æ–≥–∏|–∑–∞ (—ç—Ç—É |–ø—Ä–æ—à–ª—É—é )?–Ω–µ–¥–µ–ª|–∑–∞ (—ç—Ç–æ—Ç |–ø—Ä–æ—à–ª—ã–π )?–º–µ—Å—è—Ü|–∑–∞ —Å–µ–≥–æ–¥–Ω—è|–≤—á–µ—Ä–∞|–ø–æ–∑–∞–≤—á–µ—Ä–∞/i;\n\nif (stage === 'completed' && statsPatterns.test(message)) {\n  intent = 'stats';\n  isStatsRequest = true;\n  \n  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö\n  let trainingsContext = '–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.';\n  if (recentTrainings.length > 0) {\n    const formatPace = (sec) => {\n      if (!sec) return '–Ω/–¥';\n      return `${Math.floor(sec/60)}:${(sec%60).toString().padStart(2,'0')}`;\n    };\n    \n    trainingsContext = '–ü–û–°–õ–ï–î–ù–ò–ï –¢–†–ï–ù–ò–†–û–í–ö–ò:\\n';\n    recentTrainings.slice(0, 14).forEach(t => {\n      trainingsContext += `‚Ä¢ ${t.date}: ${t.distance_km}–∫–º –∑–∞ ${Math.round(t.duration_seconds/60)}–º–∏–Ω, —Ç–µ–º–ø ${formatPace(t.avg_pace_seconds)}/–∫–º`;\n      if (t.avg_heart_rate) trainingsContext += `, –ø—É–ª—å—Å ${t.avg_heart_rate}`;\n      trainingsContext += '\\n';\n    });\n  }\n  \n  systemPrompt = `–¢—ã AI-—Ç—Ä–µ–Ω–µ—Ä –¥–ª—è ${firstName}. –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è.\\n\\n–ó–ê–ü–†–û–°: \"${message}\"\\n\\n${trainingsContext}\\n\\n–ó–ê–î–ê–ß–ê: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ –¥–∞–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∑–∞–ø—Ä–æ—Å—É.\\n\\n–ü–†–ê–í–ò–õ–ê:\\n‚Ä¢ –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –∑–∞ –Ω–µ–¥–µ–ª—é ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π\\n‚Ä¢ –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –∑–∞ –º–µ—Å—è—Ü ‚Äî –∑–∞ 30 –¥–Ω–µ–π\\n‚Ä¢ –°—á–∏—Ç–∞–π —Å—É–º–º–∞—Ä–Ω—É—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, —Å—Ä–µ–¥–Ω–∏–π —Ç–µ–º–ø\\n‚Ä¢ –î–∞–π –∫—Ä–∞—Ç–∫—É—é –æ—Ü–µ–Ω–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞\\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ (–Ω–æ —É–º–µ—Ä–µ–Ω–Ω–æ)\\n\\n–§–û–†–ú–ê–¢ –°–¢–ê–¢–ò–°–¢–ò–ö–ò:\\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ [–ø–µ—Ä–∏–æ–¥]:\\n‚Ä¢ –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: X\\n‚Ä¢ –î–∏—Å—Ç–∞–Ω—Ü–∏—è: X –∫–º\\n‚Ä¢ –í—Ä–µ–º—è: X —á X –º–∏–Ω\\n‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Ç–µ–º–ø: X:XX/–∫–º\\n\\nüí¨ –¢–≤–æ—è –æ—Ü–µ–Ω–∫–∞ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\\n\\n${JSON_FORMAT}\\nextracted: {\"stats_period\": \"week\"|\"month\"|\"custom\", \"days\": —á–∏—Å–ª–æ}`;\n  \n}\n// ============================================\n// ONBOARDING (RACE-ONLY)\n// ============================================\nelse if (stage !== 'completed') {\n  intent = 'onboarding';\n\n  switch (stage) {\n    case 'started':\n      systemPrompt = `–¢—ã AI-—Ç—Ä–µ–Ω–µ—Ä –ø–æ –±–µ–≥—É. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${firstName} —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.\\n\\n–ó–ê–î–ê–ß–ê ‚Äî –Ω–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:\\n1. –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –ø–æ –∏–º–µ–Ω–∏\\n2. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∫–∞–∫ AI-—Ç—Ä–µ–Ω–µ—Ä, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫ –®–û–°–°–ï–ô–ù–´–ú –ó–ê–ë–ï–ì–ê–ú (road running)\\n3. –û–±—ä—è—Å–Ω–∏ —á—Ç–æ —É–º–µ–µ—Ç –±–æ—Ç:\\n   ‚Ä¢ –°–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –°–¢–†–ê–¢–ï–ì–ò–Æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –∑–∞–±–µ–≥—É\\n   ‚Ä¢ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã —Å —Ä–∞–∑–º–∏–Ω–∫–æ–π, –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç—å—é –∏ –∑–∞–º–∏–Ω–∫–æ–π\\n   ‚Ä¢ –£—á–∏—Ç—ã–≤–∞–µ—Ç –ø—É–ª—å—Å–æ–≤—ã–µ –∑–æ–Ω—ã –∏ —Ç–µ–º–ø\\n   ‚Ä¢ –†–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —Ñ–æ—Ç–æ/—Å–∫—Ä–∏–Ω—à–æ—Ç—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\\n   ‚Ä¢ –í–µ–¥—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å\\n4. –£—Ç–æ—á–Ω–∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é:\\n   \"–Ø —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å –Ω–∞ —à–æ—Å—Å–µ–π–Ω–æ–º –±–µ–≥–µ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –∑–∞–±–µ–≥–∏ –ø–æ –∞—Å—Ñ–∞–ª—å—Ç—É –æ—Ç 5–ö –¥–æ —É–ª—å—Ç—Ä–∞–º–∞—Ä–∞—Ñ–æ–Ω–æ–≤.\\n   –¢—Ä–µ–π–ª—Ä–∞–Ω–Ω–∏–Ω–≥ (–±–µ–≥ –ø–æ –ø–µ—Ä–µ—Å–µ—á—ë–Ω–Ω–æ–π –º–µ—Å—Ç–Ω–æ—Å—Ç–∏) –ø–æ–∫–∞ –Ω–µ –º–æ—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî —Ç–∞–º –¥—Ä—É–≥–∞—è –º–µ—Ç–æ–¥–∏–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏.\"\\n5. –ó–∞–¥–∞–π –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å: –∫–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –±–µ–≥–∞?\\n   ‚Ä¢ –ù–æ–≤–∏—á–æ–∫ (–±–µ–≥–∞—é –º–µ–Ω—å—à–µ –≥–æ–¥–∞)\\n   ‚Ä¢ –õ—é–±–∏—Ç–µ–ª—å (1-3 –≥–æ–¥–∞ —Ä–µ–≥—É–ª—è—Ä–Ω–æ)\\n   ‚Ä¢ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π (3+ –≥–æ–¥–∞, –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ –∑–∞–±–µ–≥–∞—Ö)\\n\\n${JSON_FORMAT}\\nextracted: {}`;\n      nextStage = 'profile';\n      break;\n\n    case 'profile':\n      systemPrompt = `AI-—Ç—Ä–µ–Ω–µ—Ä. ${firstName} –æ—Ç–≤–µ—Ç–∏–ª –ø—Ä–æ —É—Ä–æ–≤–µ–Ω—å –±–µ–≥–∞. –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è ‚Äî –¥–∏–∞–ª–æ–≥ —É–∂–µ –∏–¥—ë—Ç.\\n\\n–ó–ê–î–ê–ß–ê:\\n1. –û–ø—Ä–µ–¥–µ–ª–∏ —É—Ä–æ–≤–µ–Ω—å: beginner (–Ω–æ–≤–∏—á–æ–∫), intermediate (–ª—é–±–∏—Ç–µ–ª—å), advanced (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)\\n2. –ö–æ—Ä–æ—Ç–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –≤—ã–±–æ—Ä\\n3. –°–ø—Ä–æ—Å–∏ –≤–æ–∑—Ä–∞—Å—Ç ‚Äî –Ω—É–∂–µ–Ω –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—É–ª—å—Å–∞ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –∑–æ–Ω\\n\\n${JSON_FORMAT}\\nextracted: {\"level\": \"beginner\"|\"intermediate\"|\"advanced\"}`;\n      nextStage = 'physical';\n      break;\n\n    case 'physical':\n      systemPrompt = `AI-—Ç—Ä–µ–Ω–µ—Ä. ${firstName} —É–∫–∞–∑–∞–ª –≤–æ–∑—Ä–∞—Å—Ç. –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è.\\n\\n–ó–ê–î–ê–ß–ê:\\n1. –ò–∑–≤–ª–µ–∫–∏ –≤–æ–∑—Ä–∞—Å—Ç\\n2. –°–ø—Ä–æ—Å–∏ —Ä–æ—Å—Ç (—Å–º) –∏ –≤–µ—Å (–∫–≥) ‚Äî –Ω—É–∂–Ω–æ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ –∏ BMI\\n\\n${JSON_FORMAT}\\nextracted: {\"age\": —á–∏—Å–ª–æ}`;\n      nextStage = 'heart_rate';\n      break;\n\n    case 'heart_rate':\n      systemPrompt = `AI-—Ç—Ä–µ–Ω–µ—Ä. ${firstName} —É–∫–∞–∑–∞–ª —Ä–æ—Å—Ç –∏ –≤–µ—Å. –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è.\\n\\n–ó–ê–î–ê–ß–ê:\\n1. –ò–∑–≤–ª–µ–∫–∏ —Ä–æ—Å—Ç (—Å–º) –∏ –≤–µ—Å (–∫–≥)\\n2. –°–ø—Ä–æ—Å–∏ –ø—Ä–æ –ø—É–ª—å—Å –ø–æ–∫–æ—è:\\n\\n\"–ó–Ω–∞–µ—à—å —Å–≤–æ–π –ø—É–ª—å—Å –ø–æ–∫–æ—è?\\n\\n–ö–∞–∫ –∏–∑–º–µ—Ä–∏—Ç—å: —É—Ç—Ä–æ–º, –Ω–µ –≤—Å—Ç–∞–≤–∞—è —Å –∫—Ä–æ–≤–∞—Ç–∏, –ø–æ—Å—á–∏—Ç–∞–π –ø—É–ª—å—Å –∑–∞ 60 —Å–µ–∫—É–Ω–¥.\\n–õ—É—á—à–µ –∏–∑–º–µ—Ä–∏—Ç—å 3-5 –¥–Ω–µ–π –∏ –≤–∑—è—Ç—å —Å—Ä–µ–¥–Ω–µ–µ.\\n\\n–¢–∏–ø–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:\\n‚Ä¢ 60-80 —É–¥/–º–∏–Ω ‚Äî –æ–±—ã—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å\\n‚Ä¢ 50-60 —É–¥/–º–∏–Ω ‚Äî —Ö–æ—Ä–æ—à–∞—è —Ñ–æ—Ä–º–∞\\n‚Ä¢ 40-50 —É–¥/–º–∏–Ω ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è —Ñ–æ—Ä–º–∞\\n\\n–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî –Ω–∞–ø–∏—à–∏ '–Ω–µ –∑–Ω–∞—é', –ø–æ—Å—á–∏—Ç–∞—é –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º.\"\\n\\n${JSON_FORMAT}\\nextracted: {\"height_cm\": —á–∏—Å–ª–æ, \"weight_kg\": —á–∏—Å–ª–æ}`;\n      nextStage = 'running_info';\n      break;\n\n    case 'running_info':\n      systemPrompt = `AI-—Ç—Ä–µ–Ω–µ—Ä. ${firstName} –æ—Ç–≤–µ—Ç–∏–ª –ø—Ä–æ –ø—É–ª—å—Å –ø–æ–∫–æ—è. –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è.\\n\\n–ó–ê–î–ê–ß–ê:\\n1. –ò–∑–≤–ª–µ–∫–∏ –ø—É–ª—å—Å –ø–æ–∫–æ—è –≤ —É–¥/–º–∏–Ω. –ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–ª \"–Ω–µ –∑–Ω–∞—é\" ‚Äî –ø–æ—Å—Ç–∞–≤—å null\\n2. –°–ø—Ä–æ—Å–∏ –ø—Ä–æ —Ç–µ–∫—É—â–∏–π —Ç–µ–º–ø:\\n\\n\"–ö–∞–∫–æ–π —Ç–≤–æ–π —Ç–µ–∫—É—â–∏–π —Ç–µ–º–ø –Ω–∞ 5 –∫–º?\\n\\n–ü—Ä–∏–º–µ—Ä—ã:\\n‚Ä¢ '5:30 –Ω–∞ –∫–º'\\n‚Ä¢ '–ø—Ä–æ–±–µ–≥–∞—é 5–∫–º –∑–∞ 28 –º–∏–Ω—É—Ç'\\n‚Ä¢ '–±–µ–≥–∞—é –≤ —Ç–µ–º–ø–µ 6 –º–∏–Ω—É—Ç'\\n\\n–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω–æ ‚Äî –Ω–∞–ø–∏—à–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ –∏–ª–∏ '–Ω–µ –∑–Ω–∞—é'\"\\n\\n${JSON_FORMAT}\\nextracted: {\"resting_hr\": —á–∏—Å–ª–æ|null}`;\n      nextStage = 'lab_testing';\n      break;\n\n    case 'lab_testing':\n      systemPrompt = `AI-—Ç—Ä–µ–Ω–µ—Ä. ${firstName} —É–∫–∞–∑–∞–ª —Ç–µ–º–ø. –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è.\\n\\n–ó–ê–î–ê–ß–ê:\\n1. –ò–∑–≤–ª–µ–∫–∏ —Ç–µ–º–ø –≤ —Å–µ–∫—É–Ω–¥–∞—Ö/–∫–º:\\n   ‚Ä¢ \"5:30\" = 330 —Å–µ–∫\\n   ‚Ä¢ \"6:00 –Ω–∞ –∫–º\" = 360 —Å–µ–∫\\n   ‚Ä¢ \"28 –º–∏–Ω –Ω–∞ 5–∫–º\" = 336 —Å–µ–∫ (28*60/5)\\n   ‚Ä¢ –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–ª ‚Äî null\\n\\n2. –°–ø—Ä–æ—Å–∏ –ø—Ä–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:\\n\\n\"–ï—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–ø–∏—Ä–æ—ç—Ä–≥–æ–º–µ—Ç—Ä–∏—è, VO2max —Ç–µ—Å—Ç –Ω–∞ –¥–æ—Ä–æ–∂–∫–µ —Å –º–∞—Å–∫–æ–π)?\\n\\n–ï—Å–ª–∏ –¥–∞ ‚Äî –º–æ–∂–µ—à—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è:\\n‚Ä¢ VO2max (–º–ª/–∫–≥/–º–∏–Ω)\\n‚Ä¢ –ü–æ—Ä–æ–≥–æ–≤—ã–π –ø—É–ª—å—Å (LTHR)\\n\\n–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –Ω–∞–ø–∏—à–∏ '–Ω–µ—Ç', —Ä–∞—Å—Å—á–∏—Ç–∞—é –∑–æ–Ω—ã –ø–æ —Ñ–æ—Ä–º—É–ª–∞–º.\"\\n\\n${JSON_FORMAT}\\nextracted: {\"current_5k_pace_seconds\": —á–∏—Å–ª–æ|null}`;\n      nextStage = 'training_freq';\n      break;\n\n    case 'training_freq':\n      systemPrompt = `AI-—Ç—Ä–µ–Ω–µ—Ä. ${firstName} –æ—Ç–≤–µ—Ç–∏–ª –ø—Ä–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è.\\n\\n–ó–ê–î–ê–ß–ê:\\n1. –û–ø—Ä–µ–¥–µ–ª–∏, –µ—Å—Ç—å –ª–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\\n   ‚Ä¢ –ï—Å–ª–∏ –¥–∞ ‚Äî –∏–∑–≤–ª–µ–∫–∏ vo2max –∏/–∏–ª–∏ lthr\\n   ‚Ä¢ –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî has_lab_testing = false\\n\\n2. –°–ø—Ä–æ—Å–∏ –ø—Ä–æ —á–∞—Å—Ç–æ—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:\\n\\n\"–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é –≥–æ—Ç–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è?\\n\\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\\n‚Ä¢ 3 –¥–Ω—è ‚Äî –º–∏–Ω–∏–º—É–º –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞\\n‚Ä¢ 4 –¥–Ω—è ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è –ª—é–±–∏—Ç–µ–ª–µ–π\\n‚Ä¢ 5-6 –¥–Ω–µ–π ‚Äî –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –±–µ–≥—É–Ω–æ–≤\\n\\n–í–∞–∂–Ω–æ: 1-2 –¥–Ω—è –æ—Ç–¥—ã—Ö–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è!\"\\n\\n${JSON_FORMAT}\\nextracted: {\"has_lab_testing\": true|false, \"vo2max\": —á–∏—Å–ª–æ|null, \"lthr\": —á–∏—Å–ª–æ|null}`;\n      nextStage = 'race_details';\n      break;\n\n    case 'race_details':\n      systemPrompt = `AI-—Ç—Ä–µ–Ω–µ—Ä. ${firstName} —É–∫–∞–∑–∞–ª —á–∞—Å—Ç–æ—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è.\\n\\n–ó–ê–î–ê–ß–ê:\\n1. –ò–∑–≤–ª–µ–∫–∏ weekly_runs (3-6 –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é)\\n2. –°–ø—Ä–æ—Å–∏ –¥–µ—Ç–∞–ª–∏ –∑–∞–±–µ–≥–∞:\\n\\n\"–ö –∫–∞–∫–æ–º—É –∑–∞–±–µ–≥—É –≥–æ—Ç–æ–≤–∏–º—Å—è?\\n\\n–†–∞—Å—Å–∫–∞–∂–∏:\\n‚Ä¢ –î–∏—Å—Ç–∞–Ω—Ü–∏—è (5–ö, 10–ö, –ø–æ–ª—É–º–∞—Ä–∞—Ñ–æ–Ω, –º–∞—Ä–∞—Ñ–æ–Ω –∏–ª–∏ —É–ª—å—Ç—Ä–∞)\\n‚Ä¢ –ö–æ–≥–¥–∞ –∑–∞–±–µ–≥? (–¥–∞—Ç–∞ –∏–ª–∏ '—á–µ—Ä–µ–∑ X –º–µ—Å—è—Ü–µ–≤')\\n‚Ä¢ –¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ü–µ–ª—å)\\n\\n–ù–∞–ø—Ä–∏–º–µ—Ä: '–ø–æ–ª—É–º–∞—Ä–∞—Ñ–æ–Ω –≤ —Å–µ–Ω—Ç—è–±—Ä–µ, —Ö–æ—á—É –∑–∞ 1:50'\"\\n\\n${JSON_FORMAT}\\nextracted: {\"weekly_runs\": —á–∏—Å–ª–æ}`;\n      nextStage = 'strategy_preview';\n      break;\n\n    case 'strategy_preview':\n      const distanceRu = {\n        '5k': '5 –∫–º', '10k': '10 –∫–º', 'half': '–ø–æ–ª—É–º–∞—Ä–∞—Ñ–æ–Ω',\n        'marathon': '–º–∞—Ä–∞—Ñ–æ–Ω', 'ultra': '—É–ª—å—Ç—Ä–∞'\n      };\n\n      let weeksToRace = 12;\n      if (userData.race_date) {\n        const raceDate = new Date(userData.race_date);\n        const today = new Date();\n        weeksToRace = Math.floor((raceDate - today) / (7 * 24 * 60 * 60 * 1000));\n        if (weeksToRace < 4) weeksToRace = 4;\n        if (weeksToRace > 52) weeksToRace = 52;\n      }\n\n      const maxHR = userData.max_hr || (220 - userData.age);\n      const restingHR = userData.resting_hr || (userData.level === 'beginner' ? 70 : userData.level === 'intermediate' ? 60 : 50);\n\n      const hrReserve = maxHR - restingHR;\n      const zone1Max = Math.round(restingHR + hrReserve * 0.6);\n      const zone2Max = Math.round(restingHR + hrReserve * 0.7);\n      const zone3Max = Math.round(restingHR + hrReserve * 0.8);\n      const zone4Max = Math.round(restingHR + hrReserve * 0.9);\n\n      systemPrompt = `AI-—Ç—Ä–µ–Ω–µ—Ä. ${firstName} —É–∫–∞–∑–∞–ª –¥–µ—Ç–∞–ª–∏ –∑–∞–±–µ–≥–∞. –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è.\\n\\n–°–û–û–ë–©–ï–ù–ò–ï: \"${message}\"\\n\\n–ó–ê–î–ê–ß–ê:\\n1. –ò–∑–≤–ª–µ–∫–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è:\\n   ‚Ä¢ race_distance: \"5k\", \"10k\", \"half\", \"marathon\", \"ultra\"\\n   ‚Ä¢ race_date: —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD\\n     - \"–≤ —Å–µ–Ω—Ç—è–±—Ä–µ\" ‚Üí \"2026-09-15\"\\n     - \"—á–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞\" ‚Üí –ø–æ—Å—á–∏—Ç–∞–π –æ—Ç —Å–µ–≥–æ–¥–Ω—è (—Ñ–µ–≤—Ä–∞–ª—å 2026)\\n   ‚Ä¢ target_time_seconds: —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)\\n\\n2. –°–ì–ï–ù–ï–†–ò–†–£–ô –°–¢–†–ê–¢–ï–ì–ò–Æ –ü–û–î–ì–û–¢–û–í–ö–ò:\\n\\n–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\\n‚Ä¢ –£—Ä–æ–≤–µ–Ω—å: ${userData.level === 'beginner' ? '–Ω–æ–≤–∏—á–æ–∫' : userData.level === 'intermediate' ? '–ª—é–±–∏—Ç–µ–ª—å' : '–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π'}\\n‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç: ${userData.age} –ª–µ—Ç\\n‚Ä¢ Max HR: ${maxHR} —É–¥/–º–∏–Ω\\n‚Ä¢ Resting HR: ${restingHR} —É–¥/–º–∏–Ω\\n‚Ä¢ –¢–µ–º–ø 5–∫–º: ${userData.current_5k_pace_seconds ? Math.floor(userData.current_5k_pace_seconds/60) + ':' + (userData.current_5k_pace_seconds%60).toString().padStart(2,'0') + '/–∫–º' : '–Ω–µ —É–∫–∞–∑–∞–Ω'}\\n‚Ä¢ –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –Ω–µ–¥–µ–ª—é: ${userData.weekly_runs}\\n${userData.vo2max ? '‚Ä¢ VO2max: ' + userData.vo2max + ' –º–ª/–∫–≥/–º–∏–Ω' : ''}\\n${userData.lthr ? '‚Ä¢ –ü–æ—Ä–æ–≥–æ–≤—ã–π –ø—É–ª—å—Å: ' + userData.lthr + ' —É–¥/–º–∏–Ω' : ''}\\n\\n–ü–£–õ–¨–°–û–í–´–ï –ó–û–ù–´ (–ö–∞—Ä–≤–æ–Ω–µ–Ω):\\n‚Ä¢ –ó–æ–Ω–∞ 1 (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ): –¥–æ ${zone1Max} —É–¥/–º–∏–Ω\\n‚Ä¢ –ó–æ–Ω–∞ 2 (–∞—ç—Ä–æ–±–Ω–∞—è –±–∞–∑–∞): ${zone1Max}-${zone2Max} —É–¥/–º–∏–Ω ‚Äî 80% —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫!\\n‚Ä¢ –ó–æ–Ω–∞ 3 (—Ç–µ–º–ø–æ–≤–∞—è): ${zone2Max}-${zone3Max} —É–¥/–º–∏–Ω\\n‚Ä¢ –ó–æ–Ω–∞ 4 (–ø–æ—Ä–æ–≥–æ–≤–∞—è): ${zone3Max}-${zone4Max} —É–¥/–º–∏–Ω\\n‚Ä¢ –ó–æ–Ω–∞ 5 (VO2max): ${zone4Max}+ —É–¥/–º–∏–Ω\\n\\n–§–û–†–ú–ê–¢ –°–¢–†–ê–¢–ï–ì–ò–ò:\\n–ü–æ–∫–∞–∂–∏ –ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏—é —Å —É—á—ë—Ç–æ–º –Ω–µ–¥–µ–ª—å –¥–æ –∑–∞–±–µ–≥–∞.\\n–ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∞–∑—ã: –ë–ê–ó–ê ‚Üí –†–ê–ó–í–ò–¢–ò–ï ‚Üí –°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ‚Üí –¢–ï–ô–ü–ï–†\\n–£–∫–∞–∂–∏ –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –æ–±—ä—ë–º—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã.\\n\\n–í –∫–æ–Ω—Ü–µ —Å–ø—Ä–æ—Å–∏: \"–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å? –°–æ—Å—Ç–∞–≤–ª—é –ø–µ—Ä–≤—ã–π –Ω–µ–¥–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω!\"\\n\\n–¢–∞–∫–∂–µ –Ω–∞–ø–æ–º–Ω–∏, —á—Ç–æ –º–æ–∂–Ω–æ:\\n‚Ä¢ –ü—Ä–∏—Å—ã–ª–∞—Ç—å —Ñ–æ—Ç–æ/—Å–∫—Ä–∏–Ω—à–æ—Ç—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Äî –±–æ—Ç –∏—Ö —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç\\n‚Ä¢ –°–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –ª—é–±–æ–π –ø–µ—Ä–∏–æ–¥\\n\\n${JSON_FORMAT}\\nextracted: {\\n  \"race_distance\": \"...\",\\n  \"race_date\": \"YYYY-MM-DD\",\\n  \"target_time_seconds\": —á–∏—Å–ª–æ|null,\\n  \"strategy_generated\": true,\\n  \"weeks_to_race\": —á–∏—Å–ª–æ,\\n  \"max_hr\": ${maxHR},\\n  \"resting_hr\": ${restingHR}\\n}`;\n      nextStage = 'completed';\n      isStrategyGeneration = true;\n      break;\n  }\n} else {\n  // ============================================\n  // COMPLETED ONBOARDING ‚Äî TRAINING MODE\n  // ============================================\n  const levelRu = userData.level === 'beginner' ? '–Ω–æ–≤–∏—á–æ–∫' :\n                  userData.level === 'intermediate' ? '–ª—é–±–∏—Ç–µ–ª—å' : '–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π';\n\n  const maxHR = userData.max_hr || (220 - userData.age);\n  const restingHR = userData.resting_hr || 60;\n  const hrReserve = maxHR - restingHR;\n\n  const zone1Max = Math.round(restingHR + hrReserve * 0.6);\n  const zone2Max = Math.round(restingHR + hrReserve * 0.7);\n  const zone3Max = Math.round(restingHR + hrReserve * 0.8);\n  const zone4Max = Math.round(restingHR + hrReserve * 0.9);\n\n  let paceStr = '–Ω–µ —É–∫–∞–∑–∞–Ω';\n  let easyPace, tempoPace, longPace, intervalPace;\n\n  if (userData.current_5k_pace_seconds) {\n    const paceMin = Math.floor(userData.current_5k_pace_seconds / 60);\n    const paceSec = userData.current_5k_pace_seconds % 60;\n    paceStr = `${paceMin}:${paceSec.toString().padStart(2, '0')}/–∫–º`;\n\n    easyPace = userData.current_5k_pace_seconds + 60;\n    tempoPace = userData.current_5k_pace_seconds + 15;\n    longPace = easyPace + 15;\n    intervalPace = userData.current_5k_pace_seconds - 10;\n  } else {\n    easyPace = 420;\n    tempoPace = 360;\n    longPace = 450;\n    intervalPace = 330;\n  }\n\n  const formatPace = (sec) => `${Math.floor(sec/60)}:${(sec%60).toString().padStart(2,'0')}`;\n  const paceToSpeed = (sec) => (60 / (sec / 60)).toFixed(1);\n\n  let raceInfo = '';\n  if (userData.race_date) {\n    const distanceRu = {\n      '5k': '5 –∫–º', '10k': '10 –∫–º', 'half': '–ø–æ–ª—É–º–∞—Ä–∞—Ñ–æ–Ω',\n      'marathon': '–º–∞—Ä–∞—Ñ–æ–Ω', 'ultra': '—É–ª—å—Ç—Ä–∞'\n    }[userData.race_distance] || userData.race_distance;\n    raceInfo = `\\n–¶–ï–õ–¨: ${distanceRu}, ${userData.race_date}`;\n\n    const raceDate = new Date(userData.race_date);\n    const today = new Date();\n    const weeksLeft = Math.floor((raceDate - today) / (7 * 24 * 60 * 60 * 1000));\n    if (weeksLeft > 0) {\n      raceInfo += ` (${weeksLeft} –Ω–µ–¥. –¥–æ —Å—Ç–∞—Ä—Ç–∞)`;\n    }\n  }\n\n  const wantsPlan = /–ø–ª–∞–Ω|—Å–æ—Å—Ç–∞–≤|–¥–∞–≤–∞–π|–Ω–∞—á–Ω|–≥–æ—Ç–æ–≤|—Ö–æ—á—É|—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫|–Ω–µ–¥–µ–ª/i.test(message);\n\n  if (wantsPlan) {\n    isPlanGeneration = true;\n\n    systemPrompt = `–¢—ã AI-—Ç—Ä–µ–Ω–µ—Ä –¥–ª—è ${firstName}. –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è.\\n\\n–ü–†–û–§–ò–õ–¨:\\n‚Ä¢ –£—Ä–æ–≤–µ–Ω—å: ${levelRu}\\n‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç: ${userData.age} –ª–µ—Ç\\n‚Ä¢ –¢–µ–º–ø 5–∫–º: ${paceStr}\\n‚Ä¢ –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫/–Ω–µ–¥: ${userData.weekly_runs}${raceInfo}\\n\\n–ü–£–õ–¨–°–û–í–´–ï –ó–û–ù–´:\\n‚Ä¢ –ó–æ–Ω–∞ 1 (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ): –¥–æ ${zone1Max} —É–¥/–º–∏–Ω\\n‚Ä¢ –ó–æ–Ω–∞ 2 (–∞—ç—Ä–æ–±–Ω–∞—è): ${zone1Max}-${zone2Max} —É–¥/–º–∏–Ω\\n‚Ä¢ –ó–æ–Ω–∞ 3 (—Ç–µ–º–ø–æ–≤–∞—è): ${zone2Max}-${zone3Max} —É–¥/–º–∏–Ω\\n‚Ä¢ –ó–æ–Ω–∞ 4 (–ø–æ—Ä–æ–≥–æ–≤–∞—è): ${zone3Max}-${zone4Max} —É–¥/–º–∏–Ω\\n‚Ä¢ –ó–æ–Ω–∞ 5 (–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã): ${zone4Max}+ —É–¥/–º–∏–Ω\\n\\n–¢–ï–ú–ü–´ / –°–ö–û–†–û–°–¢–ò –î–õ–Ø –î–û–†–û–ñ–ö–ò:\\n‚Ä¢ –õ—ë–≥–∫–∏–π: ${formatPace(easyPace)}/–∫–º = ${paceToSpeed(easyPace)} –∫–º/—á\\n‚Ä¢ –¢–µ–º–ø–æ–≤—ã–π: ${formatPace(tempoPace)}/–∫–º = ${paceToSpeed(tempoPace)} –∫–º/—á\\n‚Ä¢ –î–ª–∏–Ω–Ω—ã–π: ${formatPace(longPace)}/–∫–º = ${paceToSpeed(longPace)} –∫–º/—á\\n‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–π: ${formatPace(intervalPace)}/–∫–º = ${paceToSpeed(intervalPace)} –∫–º/—á\\n\\n–ó–ê–î–ê–ß–ê: –°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é (${userData.weekly_runs} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫)\\n\\n–§–û–†–ú–ê–¢ –ö–ê–ñ–î–û–ô –¢–†–ï–ù–ò–†–û–í–ö–ò:\\n–î–µ–Ω—å ‚Äî –¢–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\\n\\n–†–ê–ó–ú–ò–ù–ö–ê (10-15 –º–∏–Ω):\\n‚Ä¢ 5-10 –º–∏–Ω –ª—ë–≥–∫–∞—è —Ç—Ä—É—Å—Ü–∞ (–∑–æ–Ω–∞ 1-2)\\n‚Ä¢ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞\\n\\n–û–°–ù–û–í–ù–ê–Ø –ß–ê–°–¢–¨:\\n‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–µ–º–ø–∞/—Å–∫–æ—Ä–æ—Å—Ç–∏ –ò –ø—É–ª—å—Å–æ–≤–æ–π –∑–æ–Ω—ã\\n‚Ä¢ –î–ª—è –¥–æ—Ä–æ–∂–∫–∏: —Ç–æ—á–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤ –∫–º/—á\\n\\n–ó–ê–ú–ò–ù–ö–ê (5-10 –º–∏–Ω):\\n‚Ä¢ 5 –º–∏–Ω –ª—ë–≥–∫–∞—è —Ç—Ä—É—Å—Ü–∞\\n‚Ä¢ –†–∞—Å—Ç—è–∂–∫–∞\\n\\n–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)\\n\\n---\\n\\n–ü–†–ê–í–ò–õ–ê –ü–õ–ê–ù–ê:\\n‚Ä¢ 80% —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –∑–æ–Ω–∞—Ö 1-2 (–ª—ë–≥–∫–∏–µ)\\n‚Ä¢ –ù–µ –±–æ–ª–µ–µ 2 –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –Ω–µ–¥–µ–ª—é\\n‚Ä¢ –ü–æ—Å–ª–µ —Ç—è–∂—ë–ª–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –ª—ë–≥–∫–∞—è –∏–ª–∏ –æ—Ç–¥—ã—Ö\\n‚Ä¢ –ú–∏–Ω–∏–º—É–º 1 –ø–æ–ª–Ω—ã–π –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞\\n\\n–ò—Ç–æ–≥–æ –∑–∞ –Ω–µ–¥–µ–ª—é: X –∫–º\\n\\n${JSON_FORMAT}\\nextracted: {\"plan_generated\": true, \"total_km\": —á–∏—Å–ª–æ, \"total_sessions\": ${userData.weekly_runs}}`;\n\n  } else {\n    let planContext = '';\n    if (activePlan && activePlan.plan_data) {\n      const planData = typeof activePlan.plan_data === 'string' ? JSON.parse(activePlan.plan_data) : activePlan.plan_data;\n      planContext = `\\n\\n–ê–ö–¢–ò–í–ù–´–ô –ü–õ–ê–ù –¢–†–ï–ù–ò–†–û–í–û–ö (${activePlan.week_start} - ${activePlan.week_end}):\\n${planData.raw_plan || JSON.stringify(planData)}`;\n    }\n\n    systemPrompt = `–¢—ã AI-—Ç—Ä–µ–Ω–µ—Ä –¥–ª—è ${firstName}. –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è.\\n\\n–ü–†–û–§–ò–õ–¨: ${levelRu}, ${userData.age} –ª–µ—Ç, ${userData.weekly_runs} —Ç—Ä–µ–Ω/–Ω–µ–¥${raceInfo}${planContext}\\n\\n–ü–£–õ–¨–°–û–í–´–ï –ó–û–ù–´:\\n‚Ä¢ –ó–æ–Ω–∞ 2 (–æ—Å–Ω–æ–≤–Ω–∞—è): ${zone1Max}-${zone2Max} —É–¥/–º–∏–Ω\\n‚Ä¢ –ó–æ–Ω–∞ 3 (—Ç–µ–º–ø–æ): ${zone2Max}-${zone3Max} —É–¥/–º–∏–Ω\\n‚Ä¢ –ó–æ–Ω–∞ 4 (–ø–æ—Ä–æ–≥): ${zone3Max}-${zone4Max} —É–¥/–º–∏–Ω\\n\\n–¢–ï–ú–ü–´ / –°–ö–û–†–û–°–¢–ò:\\n‚Ä¢ –õ—ë–≥–∫–∏–π: ${formatPace(easyPace)}/–∫–º = ${paceToSpeed(easyPace)} –∫–º/—á\\n‚Ä¢ –¢–µ–º–ø–æ–≤—ã–π: ${formatPace(tempoPace)}/–∫–º = ${paceToSpeed(tempoPace)} –∫–º/—á\\n\\n–°–û–û–ë–©–ï–ù–ò–ï: \"${message}\"\\n\\n–í–ê–ñ–ù–û:\\n‚Ä¢ –û—Ç–≤–µ—á–∞–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –∑–∞–±–µ–≥—É\\n‚Ä¢ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ —Ç–µ–º–ø/—Å–∫–æ—Ä–æ—Å—Ç—å ‚Äî –í–°–ï–ì–î–ê –¥–∞–≤–∞–π –∏ —Ç–µ–º–ø, –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –¥–æ—Ä–æ–∂–∫–∏\\n‚Ä¢ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –ø—É–ª—å—Å ‚Äî –æ–±—ä—è—Å–Ω—è–π —á–µ—Ä–µ–∑ –∑–æ–Ω—ã\\n‚Ä¢ –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º\\n\\n${JSON_FORMAT}\\nextracted: {}`;\n  }\n}\n\nreturn [{\n  json: {\n    user_id: userData.id,\n    chat_id: messageData.chat_id,\n    message_text: message,\n    message_id: messageData.message_id,\n    intent: intent,\n    system_prompt: systemPrompt,\n    onboarding_stage: stage,\n    next_stage: nextStage,\n    is_plan_generation: isPlanGeneration,\n    is_strategy_generation: isStrategyGeneration,\n    is_stats_request: isStatsRequest,\n    weekly_runs: userData.weekly_runs\n  }\n}];\n"
      },
      "name": "Prepare Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1840, 500]
    },
    {
      "id": "call-openai",
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o-mini\",\n  \"messages\": [\n    {\"role\": \"system\", \"content\": {{ JSON.stringify($json.system_prompt) }}},\n    {\"role\": \"user\", \"content\": {{ JSON.stringify($json.message_text) }}}\n  ],\n  \"temperature\": 0.7,\n  \"max_tokens\": 1500,\n  \"response_format\": {\"type\": \"json_object\"}\n}"
      },
      "name": "Call OpenAI",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2040, 500],
      "credentials": {
        "openAiApi": {
          "id": "koikxNcf4ds6vKgZ",
          "name": "OpenAI - Running Coach"
        }
      }
    },
    {
      "id": "extract-response",
      "parameters": {
        "functionCode": "const response = items[0].json;\nconst prepareData = $('Prepare Data').first().json;\nconst aiContent = response.choices[0].message.content;\n\nlet extracted = {};\nlet responseText = aiContent;\n\ntry {\n  const parsed = JSON.parse(aiContent);\n  extracted = parsed.extracted || {};\n  responseText = parsed.response || aiContent;\n} catch (e) {\n  responseText = aiContent;\n}\n\nresponseText = responseText\n  .replace(/\\*/g, '‚Ä¢')\n  .replace(/_/g, ' ')\n  .replace(/`/g, \"'\")\n  .replace(/\\[/g, '(')\n  .replace(/\\]/g, ')');\n\nreturn [{\n  json: {\n    user_id: prepareData.user_id,\n    chat_id: prepareData.chat_id,\n    message_id: prepareData.message_id,\n    user_message: prepareData.message_text,\n    intent: prepareData.intent,\n    response_text: responseText,\n    onboarding_stage: prepareData.onboarding_stage,\n    next_stage: prepareData.next_stage,\n    extracted_data: extracted,\n    is_plan_generation: prepareData.is_plan_generation,\n    is_strategy_generation: prepareData.is_strategy_generation,\n    is_stats_request: prepareData.is_stats_request,\n    weekly_runs: prepareData.weekly_runs\n  }\n}];"
      },
      "name": "Extract Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2240, 500]
    },
    {
      "id": "send-telegram",
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $json.chat_id.toString() }}",
        "text": "={{ $json.response_text }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "name": "Send to Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [2440, 500],
      "credentials": {
        "telegramApi": {
          "id": "SLNhx6dJUSPFBV35",
          "name": "Telegram Bot - Running Coach"
        }
      }
    },
    {
      "id": "is-onboarding",
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $('Extract Response').first().json.intent }}",
              "rightValue": "onboarding",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "name": "Is Onboarding?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2640, 500]
    },
    {
      "id": "build-update-data",
      "parameters": {
        "functionCode": "// RACE-ONLY Build Update Data v0.5.0\nconst data = $('Extract Response').first().json;\nconst extractedData = data.extracted_data || {};\n\nconst updateFields = {};\n\nlet actualNextStage = data.next_stage;\n\nif (data.onboarding_stage === 'started') {\n  updateFields.goal = 'race';\n}\n\nif (data.onboarding_stage === 'strategy_preview' && extractedData.strategy_generated) {\n  actualNextStage = 'completed';\n}\n\nif (actualNextStage && actualNextStage !== data.onboarding_stage) {\n  updateFields.onboarding_stage = actualNextStage;\n}\n\nif (extractedData.level) updateFields.level = extractedData.level;\nif (extractedData.age) updateFields.age = extractedData.age;\nif (extractedData.height_cm) updateFields.height_cm = extractedData.height_cm;\nif (extractedData.weight_kg) updateFields.weight_kg = extractedData.weight_kg;\nif (extractedData.current_5k_pace_seconds) updateFields.current_5k_pace_seconds = extractedData.current_5k_pace_seconds;\nif (extractedData.weekly_runs) updateFields.weekly_runs = extractedData.weekly_runs;\n\nif (extractedData.race_distance) updateFields.race_distance = extractedData.race_distance;\nif (extractedData.race_date) updateFields.race_date = extractedData.race_date;\nif (extractedData.target_time_seconds) updateFields.target_time_seconds = extractedData.target_time_seconds;\n\nif (extractedData.resting_hr) updateFields.resting_hr = extractedData.resting_hr;\nif (extractedData.max_hr) updateFields.max_hr = extractedData.max_hr;\nif (extractedData.has_lab_testing !== undefined) updateFields.has_lab_testing = extractedData.has_lab_testing;\nif (extractedData.vo2max) updateFields.vo2max = extractedData.vo2max;\nif (extractedData.lthr) updateFields.lthr = extractedData.lthr;\n\nif (extractedData.hr_zone1_max) updateFields.hr_zone1_max = extractedData.hr_zone1_max;\nif (extractedData.hr_zone2_max) updateFields.hr_zone2_max = extractedData.hr_zone2_max;\nif (extractedData.hr_zone3_max) updateFields.hr_zone3_max = extractedData.hr_zone3_max;\nif (extractedData.hr_zone4_max) updateFields.hr_zone4_max = extractedData.hr_zone4_max;\nif (extractedData.hr_zone5_max) updateFields.hr_zone5_max = extractedData.hr_zone5_max;\n\nreturn [{\n  json: {\n    user_id: data.user_id,\n    chat_id: data.chat_id,\n    update_fields: updateFields,\n    has_updates: Object.keys(updateFields).length > 0,\n    is_plan_generation: data.is_plan_generation || extractedData.plan_generated,\n    is_strategy_generation: data.is_strategy_generation || extractedData.strategy_generated,\n    plan_data: extractedData.plan_generated ? {\n      total_km: extractedData.total_km,\n      total_sessions: extractedData.total_sessions\n    } : null,\n    response_text: data.response_text,\n    weekly_runs: data.weekly_runs\n  }\n}];\n"
      },
      "name": "Build Update Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2840, 400]
    },
    {
      "id": "has-updates",
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $json.has_updates }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "name": "Has Updates?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [3040, 400]
    },
    {
      "id": "update-user",
      "parameters": {
        "operation": "update",
        "tableId": "users",
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.user_id }}"
            }
          ]
        },
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "onboarding_stage",
              "fieldValue": "={{ $json.update_fields.onboarding_stage }}"
            },
            {
              "fieldId": "level",
              "fieldValue": "={{ $json.update_fields.level }}"
            },
            {
              "fieldId": "current_5k_pace_seconds",
              "fieldValue": "={{ $json.update_fields.current_5k_pace_seconds }}"
            },
            {
              "fieldId": "weekly_runs",
              "fieldValue": "={{ $json.update_fields.weekly_runs }}"
            },
            {
              "fieldId": "goal",
              "fieldValue": "={{ $json.update_fields.goal }}"
            },
            {
              "fieldId": "age",
              "fieldValue": "={{ $json.update_fields.age }}"
            },
            {
              "fieldId": "height_cm",
              "fieldValue": "={{ $json.update_fields.height_cm }}"
            },
            {
              "fieldId": "weight_kg",
              "fieldValue": "={{ $json.update_fields.weight_kg }}"
            },
            {
              "fieldId": "race_date",
              "fieldValue": "={{ $json.update_fields.race_date }}"
            },
            {
              "fieldId": "race_distance",
              "fieldValue": "={{ $json.update_fields.race_distance }}"
            },
            {
              "fieldId": "target_time_seconds",
              "fieldValue": "={{ $json.update_fields.target_time_seconds }}"
            },
            {
              "fieldId": "resting_hr",
              "fieldValue": "={{ $json.update_fields.resting_hr }}"
            },
            {
              "fieldId": "max_hr",
              "fieldValue": "={{ $json.update_fields.max_hr }}"
            },
            {
              "fieldId": "has_lab_testing",
              "fieldValue": "={{ $json.update_fields.has_lab_testing }}"
            },
            {
              "fieldId": "vo2max",
              "fieldValue": "={{ $json.update_fields.vo2max }}"
            },
            {
              "fieldId": "lthr",
              "fieldValue": "={{ $json.update_fields.lthr }}"
            },
            {
              "fieldId": "hr_zone1_max",
              "fieldValue": "={{ $json.update_fields.hr_zone1_max }}"
            },
            {
              "fieldId": "hr_zone2_max",
              "fieldValue": "={{ $json.update_fields.hr_zone2_max }}"
            },
            {
              "fieldId": "hr_zone3_max",
              "fieldValue": "={{ $json.update_fields.hr_zone3_max }}"
            },
            {
              "fieldId": "hr_zone4_max",
              "fieldValue": "={{ $json.update_fields.hr_zone4_max }}"
            },
            {
              "fieldId": "hr_zone5_max",
              "fieldValue": "={{ $json.update_fields.hr_zone5_max }}"
            }
          ]
        }
      },
      "name": "Update User Profile",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [3240, 300],
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    },
    {
      "id": "is-plan-generation",
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $('Extract Response').first().json.is_plan_generation }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "name": "Is Plan Generation?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2840, 600]
    },
    {
      "id": "prepare-plan-data",
      "parameters": {
        "functionCode": "const extractResponse = $('Extract Response').first().json;\n\nif (!extractResponse.is_plan_generation) {\n  return [];\n}\n\nconst now = new Date();\nconst dayOfWeek = now.getDay();\nconst monday = new Date(now);\nmonday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));\nmonday.setHours(0, 0, 0, 0);\n\nconst sunday = new Date(monday);\nsunday.setDate(monday.getDate() + 6);\n\nconst formatDate = (d) => d.toISOString().split('T')[0];\n\nconst responseText = extractResponse.response_text || '';\nconst extracted = extractResponse.extracted_data || {};\n\nconst planData = {\n  raw_plan: responseText,\n  generated_at: new Date().toISOString(),\n  total_km: extracted.total_km || null,\n  total_sessions: extracted.total_sessions || extractResponse.weekly_runs || 3\n};\n\nreturn [{\n  json: {\n    user_id: extractResponse.user_id,\n    week_start: formatDate(monday),\n    week_end: formatDate(sunday),\n    week_number: 1,\n    plan_data: planData,\n    total_distance_km: extracted.total_km || null,\n    total_sessions: extracted.total_sessions || 3,\n    status: 'active'\n  }\n}];"
      },
      "name": "Prepare Plan Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [3040, 600]
    },
    {
      "id": "save-plan",
      "parameters": {
        "operation": "create",
        "tableId": "weekly_plans",
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id }}"
            },
            {
              "fieldId": "week_start",
              "fieldValue": "={{ $json.week_start }}"
            },
            {
              "fieldId": "week_end",
              "fieldValue": "={{ $json.week_end }}"
            },
            {
              "fieldId": "week_number",
              "fieldValue": "={{ $json.week_number }}"
            },
            {
              "fieldId": "plan_data",
              "fieldValue": "={{ JSON.stringify($json.plan_data) }}"
            },
            {
              "fieldId": "total_distance_km",
              "fieldValue": "={{ $json.total_distance_km }}"
            },
            {
              "fieldId": "total_sessions",
              "fieldValue": "={{ $json.total_sessions }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "={{ $json.status }}"
            }
          ]
        }
      },
      "name": "Save Plan",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [3240, 600],
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    },
    {
      "id": "save-user-message",
      "parameters": {
        "operation": "create",
        "tableId": "chat_history",
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Extract Response').first().json.user_id }}"
            },
            {
              "fieldId": "role",
              "fieldValue": "user"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $('Extract Response').first().json.user_message }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "={{ $('Extract Response').first().json.intent === 'onboarding' ? 'onboarding' : $('Extract Response').first().json.is_stats_request ? 'feedback' : 'general' }}"
            },
            {
              "fieldId": "telegram_message_id",
              "fieldValue": "={{ $('Extract Response').first().json.message_id }}"
            }
          ]
        }
      },
      "name": "Save User Message",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2640, 700],
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    },
    {
      "id": "save-bot-response",
      "parameters": {
        "operation": "create",
        "tableId": "chat_history",
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Extract Response').first().json.user_id }}"
            },
            {
              "fieldId": "role",
              "fieldValue": "assistant"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $('Extract Response').first().json.response_text }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "={{ $('Extract Response').first().json.intent === 'onboarding' ? 'onboarding' : $('Extract Response').first().json.is_plan_generation ? 'planning' : $('Extract Response').first().json.is_stats_request ? 'feedback' : 'general' }}"
            }
          ]
        }
      },
      "name": "Save Bot Response",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2840, 700],
      "credentials": {
        "supabaseApi": {
          "id": "CJ3Z1MvRt6BxblaB",
          "name": "Supabase - Running Coach"
        }
      }
    }
  ],
  "connections": {
    "TelegramTrigger": {
      "main": [
        [
          {
            "node": "Extract Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Message": {
      "main": [
        [
          {
            "node": "Get User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User": {
      "main": [
        [
          {
            "node": "Check User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check User": {
      "main": [
        [
          {
            "node": "Is Photo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Photo?": {
      "main": [
        [
          {
            "node": "Download Photo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "User Not Found?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Photo": {
      "main": [
        [
          {
            "node": "Prepare Image Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Image Data": {
      "main": [
        [
          {
            "node": "GPT-4o Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GPT-4o Vision": {
      "main": [
        [
          {
            "node": "Parse Vision Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Vision Response": {
      "main": [
        [
          {
            "node": "Training Recognized?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Training Recognized?": {
      "main": [
        [
          {
            "node": "Save Photo Training",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Not Recognized",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Photo Training": {
      "main": [
        [
          {
            "node": "Prepare Stats Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Stats Update": {
      "main": [
        [
          {
            "node": "Get User Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User Stats": {
      "main": [
        [
          {
            "node": "Calculate Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Stats": {
      "main": [
        [
          {
            "node": "Stats Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stats Exists?": {
      "main": [
        [
          {
            "node": "Update Stats",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Stats": {
      "main": [
        [
          {
            "node": "Merge Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Stats": {
      "main": [
        [
          {
            "node": "Merge Stats",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Stats": {
      "main": [
        [
          {
            "node": "Format Photo Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Photo Response": {
      "main": [
        [
          {
            "node": "Send Photo Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Not Found?": {
      "main": [
        [
          {
            "node": "Create User",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Active Plan",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Recent Trainings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Active Plan": {
      "main": [
        [
          {
            "node": "Merge User & Plan & Trainings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Recent Trainings": {
      "main": [
        [
          {
            "node": "Merge User & Plan & Trainings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge User & Plan & Trainings": {
      "main": [
        [
          {
            "node": "Prepare Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create User": {
      "main": [
        [
          {
            "node": "Get User Again",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User Again": {
      "main": [
        [
          {
            "node": "Prepare Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Data": {
      "main": [
        [
          {
            "node": "Call OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call OpenAI": {
      "main": [
        [
          {
            "node": "Extract Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Response": {
      "main": [
        [
          {
            "node": "Send to Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to Telegram": {
      "main": [
        [
          {
            "node": "Is Onboarding?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Is Plan Generation?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Save User Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Onboarding?": {
      "main": [
        [
          {
            "node": "Build Update Data",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Build Update Data": {
      "main": [
        [
          {
            "node": "Has Updates?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Updates?": {
      "main": [
        [
          {
            "node": "Update User Profile",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Is Plan Generation?": {
      "main": [
        [
          {
            "node": "Prepare Plan Data",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Prepare Plan Data": {
      "main": [
        [
          {
            "node": "Save Plan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save User Message": {
      "main": [
        [
          {
            "node": "Save Bot Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  }
}
