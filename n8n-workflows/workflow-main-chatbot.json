{
  "name": "Main Chatbot v2 Fixed",
  "nodes": [
    {
      "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "parameters": {
        "updates": ["message"]
      },
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [240, 400]
    },
    {
      "id": "b2c3d4e5-f6a7-8901-bcde-f23456789012",
      "parameters": {
        "jsCode": "const msg = $input.item.json.message;\n\nreturn [{\n  json: {\n    telegram_id: msg.from.id,\n    chat_id: msg.chat.id,\n    username: msg.from.username || '',\n    first_name: msg.from.first_name || '–î—Ä—É–≥',\n    last_name: msg.from.last_name || '',\n    message_text: msg.text || '',\n    message_id: msg.message_id\n  }\n}];"
      },
      "name": "Extract Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 400]
    },
    {
      "id": "c3d4e5f6-a7b8-9012-cdef-345678901234",
      "parameters": {
        "operation": "getAll",
        "tableId": "users",
        "returnAll": false,
        "limit": 1,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_id",
              "condition": "eq",
              "keyValue": "={{ $json.telegram_id }}"
            }
          ]
        }
      },
      "name": "Get User",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [640, 400],
      "alwaysOutputData": true
    },
    {
      "id": "d4e5f6a7-b8c9-0123-defa-456789012345",
      "parameters": {
        "jsCode": "const items = $input.all();\nconst messageData = $('Extract Message').item.json;\n\nif (items.length === 0 || !items[0].json || !items[0].json.id) {\n  return [{\n    json: {\n      userExists: false,\n      telegram_id: messageData.telegram_id,\n      chat_id: messageData.chat_id,\n      username: messageData.username,\n      first_name: messageData.first_name,\n      last_name: messageData.last_name,\n      message_text: messageData.message_text,\n      message_id: messageData.message_id\n    }\n  }];\n} else {\n  const userData = items[0].json;\n  return [{\n    json: {\n      userExists: true,\n      user_id: userData.id,\n      telegram_id: userData.telegram_id,\n      first_name: userData.first_name || messageData.first_name,\n      onboarding_stage: userData.onboarding_stage || 'started',\n      level: userData.level,\n      weekly_runs: userData.weekly_runs,\n      goal: userData.goal,\n      training_type: userData.training_type,\n      current_5k_pace_seconds: userData.current_5k_pace_seconds,\n      age: userData.age,\n      height_cm: userData.height_cm,\n      weight_kg: userData.weight_kg,\n      onboarding_data: userData.onboarding_data || {},\n      chat_id: messageData.chat_id,\n      message_text: messageData.message_text,\n      message_id: messageData.message_id\n    }\n  }];\n}"
      },
      "name": "Check User",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [840, 400],
      "notesInFlow": true,
      "notes": "Added onboarding_data for tracking"
    },
    {
      "id": "e5f6a7b8-c9d0-1234-efab-567890123456",
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-1",
              "leftValue": "={{ $json.userExists }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "User Not Found?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1040, 400]
    },
    {
      "id": "f6a7b8c9-d0e1-2345-fabc-678901234567",
      "parameters": {
        "operation": "create",
        "tableId": "users",
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "telegram_id",
              "fieldValue": "={{ $json.telegram_id }}"
            },
            {
              "fieldId": "username",
              "fieldValue": "={{ $json.username }}"
            },
            {
              "fieldId": "first_name",
              "fieldValue": "={{ $json.first_name }}"
            },
            {
              "fieldId": "last_name",
              "fieldValue": "={{ $json.last_name }}"
            },
            {
              "fieldId": "onboarding_stage",
              "fieldValue": "started"
            },
            {
              "fieldId": "language",
              "fieldValue": "ru"
            }
          ]
        }
      },
      "name": "Create User",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1240, 550]
    },
    {
      "id": "a7b8c9d0-e1f2-3456-abcd-789012345678",
      "parameters": {
        "operation": "getAll",
        "tableId": "users",
        "returnAll": false,
        "limit": 1,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_id",
              "condition": "eq",
              "keyValue": "={{ $('Check User').item.json.telegram_id }}"
            }
          ]
        }
      },
      "name": "Get User Again",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1440, 550]
    },
    {
      "id": "b8c9d0e1-f2a3-4567-bcde-890123456789",
      "parameters": {
        "jsCode": "let userData;\nlet messageData;\n\nconst checkUserData = $('Check User').item.json;\n\nif (checkUserData.userExists) {\n  userData = {\n    id: checkUserData.user_id,\n    first_name: checkUserData.first_name,\n    onboarding_stage: checkUserData.onboarding_stage || 'started',\n    level: checkUserData.level,\n    weekly_runs: checkUserData.weekly_runs,\n    goal: checkUserData.goal,\n    training_type: checkUserData.training_type,\n    current_5k_pace_seconds: checkUserData.current_5k_pace_seconds,\n    age: checkUserData.age,\n    height_cm: checkUserData.height_cm,\n    weight_kg: checkUserData.weight_kg,\n    onboarding_data: checkUserData.onboarding_data || {}\n  };\n  messageData = {\n    chat_id: checkUserData.chat_id,\n    message_text: checkUserData.message_text,\n    message_id: checkUserData.message_id\n  };\n} else {\n  userData = $input.item.json;\n  userData.onboarding_stage = 'started';\n  userData.onboarding_data = {};\n  messageData = {\n    chat_id: $('Check User').item.json.chat_id,\n    message_text: $('Check User').item.json.message_text,\n    message_id: $('Check User').item.json.message_id\n  };\n}\n\nconst message = messageData.message_text;\nconst stage = userData.onboarding_stage;\nconst firstName = userData.first_name || '–¥—Ä—É–≥';\nconst onboardingData = userData.onboarding_data || {};\n\nlet intent = 'general';\nlet systemPrompt = '';\nlet extractField = null;\nlet nextStage = stage;\nlet newOnboardingData = { ...onboardingData };\n\nconst JSON_INSTRUCTION = '–í–ê–ñ–ù–û: –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ markdown. –§–æ—Ä–º–∞—Ç: {\"extracted\": {...}, \"response\": \"—Ç–≤–æ–π –æ—Ç–≤–µ—Ç\"}';\n\nif (stage !== 'completed') {\n  intent = 'onboarding';\n  \n  switch (stage) {\n    case 'started':\n      systemPrompt = `–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π AI-—Ç—Ä–µ–Ω–µ—Ä –ø–æ –±–µ–≥—É. –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π ${firstName} —Ç–µ–ø–ª–æ –∏ —Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ:\n- –¢—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-—Ç—Ä–µ–Ω–µ—Ä –ø–æ –±–µ–≥—É\n- –ü–æ–º–æ–≥–∞–µ—à—å —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–ª–∞–Ω—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—à—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –¥–∞—ë—à—å —Å–æ–≤–µ—Ç—ã\n- –° —Ç–æ–±–æ–π –º–æ–∂–Ω–æ –æ–±—â–∞—Ç—å—Å—è –∫–∞–∫ —Å –∂–∏–≤—ã–º —Ç—Ä–µ–Ω–µ—Ä–æ–º - –ø–∏—Å–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ, –≥–æ–ª–æ—Å–æ–≤—ã–º–∏, –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n\n–ü–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è —Å–ø—Ä–æ—Å–∏ –ø—Ä–æ —É—Ä–æ–≤–µ–Ω—å –±–µ–≥–∞: –Ω–æ–≤–∏—á–æ–∫ (–±–µ–≥–∞—é –º–µ–Ω—å—à–µ –≥–æ–¥–∞), –ª—é–±–∏—Ç–µ–ª—å (1-3 –≥–æ–¥–∞), –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π (–±–æ–ª–µ–µ 3 –ª–µ—Ç). ${JSON_INSTRUCTION} extracted –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–æ–º {}.`;\n      nextStage = 'profile';\n      break;\n      \n    case 'profile':\n      systemPrompt = `–¢—ã AI-—Ç—Ä–µ–Ω–µ—Ä. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ–± —É—Ä–æ–≤–Ω–µ –±–µ–≥–∞. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ –æ—Ç–≤–µ—Ç –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ —É—Ä–æ–≤–µ–Ω—å: beginner (–Ω–æ–≤–∏—á–æ–∫, –Ω–∞—á–∏–Ω–∞—é—â–∏–π, –º–µ–Ω—å—à–µ –≥–æ–¥–∞), intermediate (–ª—é–±–∏—Ç–µ–ª—å, —Å—Ä–µ–¥–Ω–∏–π, 1-3 –≥–æ–¥–∞), advanced (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π, –æ–ø—ã—Ç–Ω—ã–π, –±–æ–ª–µ–µ 3 –ª–µ—Ç). –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å - –ø–µ—Ä–µ—Å–ø—Ä–æ—Å–∏. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–ø—Ä–æ—Å–∏ –≤–æ–∑—Ä–∞—Å—Ç, —Ä–æ—Å—Ç –∏ –≤–µ—Å (–ø—Ä–∏–º–µ—Ä–Ω–æ) - —ç—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω –ø—É–ª—å—Å–∞ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞. ${JSON_INSTRUCTION} extracted: {\"level\": \"beginner\"|\"intermediate\"|\"advanced\"|null}`;\n      extractField = 'level';\n      nextStage = 'physical';\n      break;\n      \n    case 'physical':\n      systemPrompt = `–¢—ã AI-—Ç—Ä–µ–Ω–µ—Ä. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –ø—Ä–æ –≤–æ–∑—Ä–∞—Å—Ç, —Ä–æ—Å—Ç –∏ –≤–µ—Å. –ò–∑–≤–ª–µ–∫–∏: –≤–æ–∑—Ä–∞—Å—Ç (—á–∏—Å–ª–æ –ª–µ—Ç, 10-100), —Ä–æ—Å—Ç –≤ —Å–º (100-250), –≤–µ—Å –≤ –∫–≥ (30-200). –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ: \"30 –ª–µ—Ç, 175 —Å–º, 75 –∫–≥\", \"–º–Ω–µ 30, —Ä–æ—Å—Ç 175, –≤–µ—à—É 75\" –∏ —Ç.–¥. –ï—Å–ª–∏ —É–∫–∞–∑–∞–ª –Ω–µ –≤—Å—ë - –ø–æ–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π, —Å–ø—Ä–æ—Å–∏ –ø—Ä–æ —Ç–µ–º–ø –Ω–∞ 5 –∫–º (–Ω–∞–ø—Ä–∏–º–µ—Ä 6 –º–∏–Ω/–∫–º –∏–ª–∏ –æ–±—â–µ–µ –≤—Ä–µ–º—è). –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—Ç —Ç–µ–º–ø - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. ${JSON_INSTRUCTION} extracted: {\"age\": —á–∏—Å–ª–æ|null, \"height_cm\": —á–∏—Å–ª–æ|null, \"weight_kg\": —á–∏—Å–ª–æ|null}`;\n      extractField = 'physical';\n      nextStage = 'running_info';\n      break;\n      \n    case 'running_info':\n      systemPrompt = `–¢—ã AI-—Ç—Ä–µ–Ω–µ—Ä. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –ø—Ä–æ —Ç–µ–º–ø –±–µ–≥–∞. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π: –µ—Å–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç –≤—Ä–µ–º—è –Ω–∞ 5–∫–º (–Ω–∞–ø—Ä–∏–º–µ—Ä 30 –º–∏–Ω—É—Ç) - —Ä–∞–∑–¥–µ–ª–∏ –Ω–∞ 5 —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–º–ø –Ω–∞ –∫–º –≤ —Å–µ–∫—É–Ω–¥–∞—Ö. –ï—Å–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç —Ç–µ–º–ø (6 –º–∏–Ω/–∫–º) - –ø–µ—Ä–µ–≤–µ–¥–∏ –≤ —Å–µ–∫—É–Ω–¥—ã (360). –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—Ç - –≤–µ—Ä–Ω–∏ null. –ó–∞—Ç–µ–º —Å–ø—Ä–æ—Å–∏ —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –±–µ–≥–∞–µ—Ç –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç (–æ—Ç 1 –¥–æ 7). ${JSON_INSTRUCTION} extracted: {\"pace_seconds\": —á–∏—Å–ª–æ|null}`;\n      extractField = 'pace';\n      nextStage = 'goal';\n      newOnboardingData.step = 'frequency';\n      break;\n      \n    case 'goal':\n      const currentStep = onboardingData.step || 'frequency';\n      \n      if (currentStep === 'frequency') {\n        systemPrompt = `–¢—ã AI-—Ç—Ä–µ–Ω–µ—Ä. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –±–µ–≥–∞–µ—Ç. –ò–∑–≤–ª–µ–∫–∏ —á–∏—Å–ª–æ (1-7). –ï—Å–ª–∏ –Ω–µ –ø–æ–Ω—è—Ç–Ω–æ - –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏ 3. –ó–∞—Ç–µ–º —Å–ø—Ä–æ—Å–∏ –ø—Ä–æ —Ü–µ–ª—å: –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è –∏ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–±–µ–≥—É, –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. ${JSON_INSTRUCTION} extracted: {\"weekly_runs\": —á–∏—Å–ª–æ}`;\n        extractField = 'frequency';\n        nextStage = 'goal';\n        newOnboardingData.step = 'goal_select';\n      } else {\n        systemPrompt = `–¢—ã AI-—Ç—Ä–µ–Ω–µ—Ä. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –ø—Ä–æ —Ü–µ–ª—å –±–µ–≥–∞. –û–ø—Ä–µ–¥–µ–ª–∏: general (–∑–¥–æ—Ä–æ–≤—å–µ, —Ñ–æ—Ä–º–∞, —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ, –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ), race (–∑–∞–±–µ–≥, —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ, –º–∞—Ä–∞—Ñ–æ–Ω, –ø–æ–ª—É–º–∞—Ä–∞—Ñ–æ–Ω), improvement (—É–ª—É—á—à–∏—Ç—å, –±—ã—Å—Ç—Ä–µ–µ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –ø—Ä–æ–≥—Ä–µ—Å—Å). –ü–æ–∑–¥—Ä–∞–≤—å —Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –ø—Ä–æ—Ñ–∏–ª—è –∏ —Å–∫–∞–∂–∏ —á—Ç–æ —É–∂–µ —Å–æ—Å—Ç–∞–≤–ª—è–µ—à—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∞ –Ω–µ–¥–µ–ª—é - —Å–∫–æ—Ä–æ –ø—Ä–∏—à–ª—ë—à—å! ${JSON_INSTRUCTION} extracted: {\"goal\": \"general\"|\"race\"|\"improvement\"}`;\n        extractField = 'goal';\n        nextStage = 'completed';\n        newOnboardingData.step = 'completed';\n      }\n      break;\n  }\n} else {\n  const msgLower = message.toLowerCase();\n  if (msgLower.includes('–ø–ª–∞–Ω') || msgLower.includes('/plan')) {\n    intent = 'plan';\n    systemPrompt = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. –°–∫–∞–∂–∏ —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç. ${JSON_INSTRUCTION} extracted: {}`;\n  } else if (msgLower.includes('—É–ª–∏—Ü') || msgLower.includes('–Ω–∞ —É–ª–∏—Ü–µ') || msgLower.includes('–ø–∞—Ä–∫')) {\n    intent = 'change_type';\n    systemPrompt = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –±–µ–≥–∞—Ç—å –Ω–∞ —É–ª–∏—Ü–µ. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ —Å–º–µ–Ω—É —Ñ–æ—Ä–º–∞—Ç–∞. ${JSON_INSTRUCTION} extracted: {\"training_type\": \"outdoor\"}`;\n  } else if (msgLower.includes('–∑–∞–ª') || msgLower.includes('–¥–æ—Ä–æ–∂–∫') || msgLower.includes('—Ç—Ä–µ–Ω–∞–∂–µ—Ä')) {\n    intent = 'change_type';\n    systemPrompt = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –≤ –∑–∞–ª. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ —Å–º–µ–Ω—É —Ñ–æ—Ä–º–∞—Ç–∞. ${JSON_INSTRUCTION} extracted: {\"training_type\": \"treadmill\"}`;\n  } else {\n    systemPrompt = `–¢—ã AI-—Ç—Ä–µ–Ω–µ—Ä –ø–æ –±–µ–≥—É –¥–ª—è ${firstName}. –£—Ä–æ–≤–µ–Ω—å: ${userData.level}, —Ü–µ–ª—å: ${userData.goal}. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ. ${JSON_INSTRUCTION} extracted: {}`;\n  }\n}\n\nreturn [{\n  json: {\n    user_id: userData.id,\n    chat_id: messageData.chat_id,\n    message_text: message,\n    message_id: messageData.message_id,\n    intent: intent,\n    system_prompt: systemPrompt,\n    onboarding_stage: stage,\n    next_stage: nextStage,\n    extract_field: extractField,\n    new_onboarding_data: newOnboardingData\n  }\n}];"
      },
      "name": "Prepare Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1640, 400]
    },
    {
      "id": "c9d0e1f2-a3b4-5678-cdef-901234567890",
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o-mini\",\n  \"messages\": [\n    {\"role\": \"system\", \"content\": \"{{ $json.system_prompt.replace(/\\\"/g, '\\\\\"').replace(/\\n/g, '\\\\n') }}\"},\n    {\"role\": \"user\", \"content\": \"{{ $json.message_text.replace(/\\\"/g, '\\\\\"').replace(/\\n/g, '\\\\n') }}\"}\n  ],\n  \"temperature\": 0.7,\n  \"max_tokens\": 500,\n  \"response_format\": {\"type\": \"json_object\"}\n}",
        "options": {}
      },
      "name": "Call OpenAI",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1840, 400]
    },
    {
      "id": "d0e1f2a3-b4c5-6789-defa-012345678901",
      "parameters": {
        "jsCode": "const response = $input.item.json;\nconst prepareData = $('Prepare Data').item.json;\nconst aiContent = response.choices[0].message.content;\n\n// Parse JSON response from AI\nlet extracted = {};\nlet responseText = aiContent;\n\ntry {\n  const parsed = JSON.parse(aiContent);\n  extracted = parsed.extracted || {};\n  responseText = parsed.response || aiContent;\n} catch (e) {\n  // If JSON parsing fails, use raw content as response\n  responseText = aiContent;\n}\n\nreturn [{\n  json: {\n    user_id: prepareData.user_id,\n    chat_id: prepareData.chat_id,\n    message_id: prepareData.message_id,\n    user_message: prepareData.message_text,\n    intent: prepareData.intent,\n    response_text: responseText,\n    onboarding_stage: prepareData.onboarding_stage,\n    next_stage: prepareData.next_stage,\n    extracted_data: extracted,\n    new_onboarding_data: prepareData.new_onboarding_data\n  }\n}];"
      },
      "name": "Extract Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2040, 400]
    },
    {
      "id": "e1f2a3b4-c5d6-7890-efab-123456789012",
      "parameters": {
        "operation": "create",
        "tableId": "chat_history",
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id }}"
            },
            {
              "fieldId": "role",
              "fieldValue": "user"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $json.user_message }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "={{ $json.intent }}"
            },
            {
              "fieldId": "telegram_message_id",
              "fieldValue": "={{ $json.message_id }}"
            }
          ]
        }
      },
      "name": "Save User Msg",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2240, 300]
    },
    {
      "id": "f2a3b4c5-d6e7-8901-fabc-234567890123",
      "parameters": {
        "operation": "create",
        "tableId": "chat_history",
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Extract Response').item.json.user_id }}"
            },
            {
              "fieldId": "role",
              "fieldValue": "assistant"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $('Extract Response').item.json.response_text }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "={{ $('Extract Response').item.json.intent }}"
            }
          ]
        }
      },
      "name": "Save AI Msg",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2440, 300]
    },
    {
      "id": "a3b4c5d6-e7f8-9012-abcd-345678901234",
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $json.chat_id.toString() }}",
        "text": "={{ $json.response_text }}",
        "additionalFields": {}
      },
      "name": "Send to Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [2240, 500]
    },
    {
      "id": "b4c5d6e7-f8a9-0123-bcde-456789012345",
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-onboarding",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "onboarding",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Is Onboarding?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2240, 700]
    },
    {
      "id": "c5d6e7f8-a9b0-1234-cdef-567890123456",
      "parameters": {
        "jsCode": "const data = $input.item.json;\nconst extractedData = data.extracted_data || {};\n\n// Build update fields from AI-extracted data\nconst updateFields = {};\n\n// Always update stage if it changed\nif (data.next_stage && data.next_stage !== data.onboarding_stage) {\n  updateFields.onboarding_stage = data.next_stage;\n}\n\n// Add extracted data from AI response\nif (extractedData.level) updateFields.level = extractedData.level;\nif (extractedData.pace_seconds) updateFields.current_5k_pace_seconds = extractedData.pace_seconds;\nif (extractedData.weekly_runs) updateFields.weekly_runs = extractedData.weekly_runs;\nif (extractedData.goal) updateFields.goal = extractedData.goal;\nif (extractedData.training_type) updateFields.training_type = extractedData.training_type;\nif (extractedData.age) updateFields.age = extractedData.age;\nif (extractedData.height_cm) updateFields.height_cm = extractedData.height_cm;\nif (extractedData.weight_kg) updateFields.weight_kg = extractedData.weight_kg;\n\n// Always update onboarding_data to preserve step tracking\nif (data.new_onboarding_data) {\n  updateFields.onboarding_data = data.new_onboarding_data;\n}\n\nreturn [{\n  json: {\n    user_id: data.user_id,\n    update_fields: updateFields,\n    has_updates: Object.keys(updateFields).length > 0\n  }\n}];"
      },
      "name": "Build Update Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2440, 700]
    },
    {
      "id": "d6e7f8a9-b0c1-2345-defa-678901234567",
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-has-updates",
              "leftValue": "={{ $json.has_updates }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Has Updates?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2640, 700]
    },
    {
      "id": "e7f8a9b0-c1d2-3456-efab-789012345678",
      "parameters": {
        "operation": "update",
        "tableId": "users",
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.user_id }}"
            }
          ]
        },
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "onboarding_stage",
              "fieldValue": "={{ $json.update_fields.onboarding_stage }}"
            },
            {
              "fieldId": "level",
              "fieldValue": "={{ $json.update_fields.level }}"
            },
            {
              "fieldId": "current_5k_pace_seconds",
              "fieldValue": "={{ $json.update_fields.current_5k_pace_seconds }}"
            },
            {
              "fieldId": "weekly_runs",
              "fieldValue": "={{ $json.update_fields.weekly_runs }}"
            },
            {
              "fieldId": "goal",
              "fieldValue": "={{ $json.update_fields.goal }}"
            },
            {
              "fieldId": "training_type",
              "fieldValue": "={{ $json.update_fields.training_type }}"
            },
            {
              "fieldId": "age",
              "fieldValue": "={{ $json.update_fields.age }}"
            },
            {
              "fieldId": "height_cm",
              "fieldValue": "={{ $json.update_fields.height_cm }}"
            },
            {
              "fieldId": "weight_kg",
              "fieldValue": "={{ $json.update_fields.weight_kg }}"
            },
            {
              "fieldId": "onboarding_data",
              "fieldValue": "={{ $json.update_fields.onboarding_data }}"
            }
          ]
        }
      },
      "name": "Update User Profile",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2840, 650]
    },
    {
      "id": "plan-check-001",
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-just-completed",
              "leftValue": "={{ $('Extract Response').item.json.next_stage }}",
              "rightValue": "completed",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "condition-was-not-completed",
              "leftValue": "={{ $('Extract Response').item.json.onboarding_stage }}",
              "rightValue": "completed",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Just Completed?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [3040, 650]
    },
    {
      "id": "plan-get-user-002",
      "parameters": {
        "operation": "getAll",
        "tableId": "users",
        "returnAll": false,
        "limit": 1,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Extract Response').item.json.user_id }}"
            }
          ]
        }
      },
      "name": "Get User For Plan",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [3240, 600]
    },
    {
      "id": "plan-prepare-003",
      "parameters": {
        "jsCode": "const user = $input.item.json;\nconst chatId = $('Extract Response').item.json.chat_id;\n\n// Calculate week boundaries (Monday to Sunday)\nconst today = new Date();\nconst dayOfWeek = today.getDay();\nconst mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;\nconst weekStart = new Date(today);\nweekStart.setDate(today.getDate() + mondayOffset);\nweekStart.setHours(0, 0, 0, 0);\n\nconst weekEnd = new Date(weekStart);\nweekEnd.setDate(weekStart.getDate() + 6);\n\nconst formatDate = (d) => d.toISOString().split('T')[0];\n\nconst formatPace = (seconds) => {\n  if (!seconds) return null;\n  const min = Math.floor(seconds / 60);\n  const sec = seconds % 60;\n  return `${min}:${sec.toString().padStart(2, '0')}`;\n};\n\nconst formatPaceRange = (baseSec, addMin, addMax) => {\n  if (!baseSec) return null;\n  const minPace = formatPace(baseSec + addMin);\n  const maxPace = formatPace(baseSec + addMax);\n  return `${minPace}-${maxPace}`;\n};\n\n// ========== COACH KNOWLEDGE BASE ==========\n// Based on scientific-foundation.md v2.0\n\nconst LEVEL_PARAMS = {\n  beginner: {\n    name: '–ù–æ–≤–∏—á–æ–∫',\n    weeklyKmRange: [10, 20],\n    longRunMaxKm: 8,\n    intensityPerWeek: 0,\n    allowedTypes: ['rest', 'easy_run', 'long_run'],\n    easyPaceAdd: [60, 90],\n    longPaceAdd: [90, 120]\n  },\n  intermediate: {\n    name: '–õ—é–±–∏—Ç–µ–ª—å',\n    weeklyKmRange: [25, 40],\n    longRunMaxKm: 15,\n    intensityPerWeek: 1,\n    allowedTypes: ['rest', 'easy_run', 'long_run', 'tempo', 'fartlek'],\n    easyPaceAdd: [45, 60],\n    longPaceAdd: [60, 90],\n    tempoPaceAdd: [-5, 15]\n  },\n  advanced: {\n    name: '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π',\n    weeklyKmRange: [50, 80],\n    longRunMaxKm: 25,\n    intensityPerWeek: 2,\n    allowedTypes: ['rest', 'easy_run', 'long_run', 'tempo', 'intervals', 'fartlek', 'recovery'],\n    easyPaceAdd: [30, 45],\n    longPaceAdd: [45, 60],\n    tempoPaceAdd: [-10, 5],\n    intervalPaceAdd: [-20, -10]\n  }\n};\n\nconst GOAL_FOCUS = {\n  general: '–†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å, —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ, 90% –ª—ë–≥–∫–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',\n  race: '–°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏, —Ç–µ–º–ø–æ–≤—ã–µ –∏ –¥–ª–∏–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ',\n  improvement: '–ü—Ä–æ–≥—Ä–µ—Å—Å –≤ —Å–∫–æ—Ä–æ—Å—Ç–∏, –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∏ —Ç–µ–º–ø–æ–≤—ã–µ –¥–ª—è VO2max –∏ –ø–æ—Ä–æ–≥–∞'\n};\n\nconst level = user.level || 'beginner';\nconst goal = user.goal || 'general';\nconst weeklyRuns = user.weekly_runs || 3;\nconst pace5k = user.current_5k_pace_seconds;\nconst age = user.age;\nconst heightCm = user.height_cm;\nconst weightKg = user.weight_kg;\nconst params = LEVEL_PARAMS[level];\n\n// Calculate BMI and safety flags\nlet bmi = null;\nlet bmiWarning = '';\nlet walkingOnly = false;\nif (heightCm && weightKg) {\n  const heightM = heightCm / 100;\n  bmi = weightKg / (heightM * heightM);\n  bmi = Math.round(bmi * 10) / 10;\n  if (bmi >= 35) {\n    walkingOnly = true;\n    bmiWarning = '‚ö†Ô∏è –í–ê–ñ–ù–û: BMI >= 35. –¢–æ–ª—å–∫–æ —Ö–æ–¥—å–±–∞ –∏ –æ—á–µ–Ω—å –ª—ë–≥–∫–∏–π –±–µ–≥. –ù–∏–∫–∞–∫–∏—Ö –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫!';\n  } else if (bmi >= 30) {\n    bmiWarning = '‚ö†Ô∏è BMI >= 30. –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –ª—ë–≥–∫–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –º–∏–Ω–∏–º—É–º –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å—É—Å—Ç–∞–≤—ã.';\n  }\n}\n\n// Calculate MAF heart rate zone (180 - age)\nlet mafHR = null;\nlet hrInfo = '';\nif (age) {\n  mafHR = 180 - age;\n  hrInfo = `\n- MAF –ø—É–ª—å—Å (–∞—ç—Ä–æ–±–Ω–∞—è –∑–æ–Ω–∞): –¥–æ ${mafHR} —É–¥/–º–∏–Ω`;\n}\n\n// Calculate paces\nlet paceInfo = '';\nif (pace5k) {\n  const easyPace = formatPaceRange(pace5k, params.easyPaceAdd[0], params.easyPaceAdd[1]);\n  const longPace = formatPaceRange(pace5k, params.longPaceAdd[0], params.longPaceAdd[1]);\n  paceInfo = `\n- –¢–µ–º–ø –Ω–∞ 5–ö: ${formatPace(pace5k)} –º–∏–Ω/–∫–º\n- –õ—ë–≥–∫–∏–π –±–µ–≥: ${easyPace} –º–∏–Ω/–∫–º\n- –î–ª–∏–Ω–Ω–∞—è: ${longPace} –º–∏–Ω/–∫–º`;\n  \n  if (params.tempoPaceAdd) {\n    paceInfo += `\n- –¢–µ–º–ø–æ–≤–∞—è: ${formatPaceRange(pace5k, params.tempoPaceAdd[0], params.tempoPaceAdd[1])} –º–∏–Ω/–∫–º`;\n  }\n  if (params.intervalPaceAdd) {\n    paceInfo += `\n- –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã: ${formatPaceRange(pace5k, params.intervalPaceAdd[0], params.intervalPaceAdd[1])} –º–∏–Ω/–∫–º`;\n  }\n} else {\n  paceInfo = '\n- –¢–µ–º–ø –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –æ–ø–∏—Å–∞–Ω–∏—è –æ—â—É—â–µ–Ω–∏–π (RPE)';\n}\n\n// Add HR info to pace info\nif (hrInfo) {\n  paceInfo += hrInfo;\n}\n\n// Safety overrides for high BMI\nlet actualParams = { ...params };\nlet safetyNote = '';\nif (walkingOnly) {\n  actualParams.allowedTypes = ['rest', 'easy_run'];\n  actualParams.intensityPerWeek = 0;\n  actualParams.weeklyKmRange = [5, 15];\n  actualParams.longRunMaxKm = 5;\n  safetyNote = bmiWarning + '\n';\n} else if (bmiWarning) {\n  safetyNote = bmiWarning + '\n';\n}\n\nconst systemPrompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ –±–µ–≥—É. –°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –°–¢–†–û–ì–û –ø–æ –Ω–∞—É—á–Ω—ã–º –ø—Ä–∏–Ω—Ü–∏–ø–∞–º.\n${safetyNote}\n=== –ñ–ï–õ–ï–ó–ù–´–ï –ü–†–ê–í–ò–õ–ê (–ù–ï–õ–¨–ó–Ø –ù–ê–†–£–®–ê–¢–¨) ===\n1. –ü—Ä–∞–≤–∏–ª–æ 80/20: 80% —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Äî –ª—ë–≥–∫–∏–µ (–∑–æ–Ω—ã 1-2), —Ç–æ–ª—å–∫–æ 20% –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ\n2. –ú–∏–Ω–∏–º—É–º 1 –ø–æ–ª–Ω—ã–π –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞ –≤ –Ω–µ–¥–µ–ª—é\n3. –ù–ò–ö–û–ì–î–ê 2 —Ç—è–∂—ë–ª—ã—Ö –¥–Ω—è –ø–æ–¥—Ä—è–¥ ‚Äî –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π –≤—Å–µ–≥–¥–∞ –æ—Ç–¥—ã—Ö –∏–ª–∏ –ª—ë–≥–∫–∞—è\n4. –î–ª–∏–Ω–Ω–∞—è –ø—Ä–æ–±–µ–∂–∫–∞ ‚â§30% –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ–±—ä—ë–º–∞\n5. –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –Ω–µ–¥–µ–ª—é: –º–∞–∫—Å–∏–º—É–º ${actualParams.intensityPerWeek}\n6. –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è —É—Ä–æ–≤–Ω—è ${params.name}: ${actualParams.allowedTypes.join(', ')}\n\n=== –ü–†–û–§–ò–õ–¨ –ë–ï–ì–£–ù–ê ===\n- –£—Ä–æ–≤–µ–Ω—å: ${params.name}\n- –í–æ–∑—Ä–∞—Å—Ç: ${age || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n- BMI: ${bmi || '–Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω'}\n- –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –Ω–µ–¥–µ–ª—é: ${weeklyRuns}\n- –¶–µ–ª—å: ${GOAL_FOCUS[goal]}\n- –ù–µ–¥–µ–ª—å–Ω—ã–π –æ–±—ä—ë–º: ${actualParams.weeklyKmRange[0]}-${actualParams.weeklyKmRange[1]} –∫–º\n- –ú–∞–∫—Å. –¥–ª–∏–Ω–Ω–∞—è: ${actualParams.longRunMaxKm} –∫–º\n${paceInfo}\n\n=== –¢–ò–ü–´ –¢–†–ï–ù–ò–†–û–í–û–ö ===\n- rest: –ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö\n- easy_run: –õ—ë–≥–∫–∏–π –±–µ–≥, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Ç–µ–º–ø, RPE 3-5\n- long_run: –î–ª–∏–Ω–Ω–∞—è, –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π —Ç–µ–º–ø, RPE 4-6\n- tempo: –¢–µ–º–ø–æ–≤–∞—è, –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ-—Ç—è–∂–µ–ª–æ, RPE 6-7 (—Ç–æ–ª—å–∫–æ intermediate+)\n- intervals: –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã, –æ—á–µ–Ω—å —Ç—è–∂–µ–ª–æ, RPE 8-10 (—Ç–æ–ª—å–∫–æ advanced)\n- fartlek: –§–∞—Ä—Ç–ª–µ–∫, –∏–≥—Ä–∞ —Å —Ç–µ–º–ø–æ–º, RPE 5-8 (—Ç–æ–ª—å–∫–æ intermediate+)\n- recovery: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π, –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ, RPE 2-3\n\n=== –ó–ê–î–ê–ù–ò–ï ===\n–°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω –Ω–∞ 7 –¥–Ω–µ–π. –£—á–∏—Ç—ã–≤–∞–π: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –±–µ–≥–∞—Ç—å ${weeklyRuns} —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é.\n–û—Å—Ç–∞–ª—å–Ω—ã–µ –¥–Ω–∏ ‚Äî rest.\n\n–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON:\n{\n  \"plan\": {\n    \"monday\": {\"type\": \"—Ç–∏–ø\", \"distance_km\": —á–∏—Å–ª–æ, \"pace_range\": \"M:SS-M:SS –∏–ª–∏ null\", \"duration_minutes\": —á–∏—Å–ª–æ, \"notes\": \"–æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º\"},\n    \"tuesday\": {...},\n    \"wednesday\": {...},\n    \"thursday\": {...},\n    \"friday\": {...},\n    \"saturday\": {...},\n    \"sunday\": {...}\n  },\n  \"total_distance_km\": —á–∏—Å–ª–æ,\n  \"total_sessions\": —á–∏—Å–ª–æ,\n  \"summary\": \"–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞–Ω–∞\"\n}`;\n\nreturn [{\n  json: {\n    user_id: user.id,\n    chat_id: chatId,\n    week_start: formatDate(weekStart),\n    week_end: formatDate(weekEnd),\n    system_prompt: systemPrompt,\n    user_data: {\n      level: level,\n      pace: pace5k,\n      weekly_runs: weeklyRuns,\n      goal: goal,\n      age: age,\n      bmi: bmi,\n      maf_hr: mafHR\n    }\n  }\n}];"
      },
      "name": "Prepare Plan Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3440, 600]
    },
    {
      "id": "plan-generate-004",
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o-mini\",\n  \"messages\": [\n    {\"role\": \"system\", \"content\": \"{{ $json.system_prompt.replace(/\\\"/g, '\\\\\"').replace(/\\n/g, '\\\\n') }}\"},\n    {\"role\": \"user\", \"content\": \"–°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\"}\n  ],\n  \"temperature\": 0.7,\n  \"max_tokens\": 1500,\n  \"response_format\": {\"type\": \"json_object\"}\n}",
        "options": {}
      },
      "name": "Generate Plan AI",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3640, 600]
    },
    {
      "id": "plan-parse-005",
      "parameters": {
        "jsCode": "const response = $input.item.json;\nconst prepData = $('Prepare Plan Prompt').item.json;\nconst aiContent = response.choices[0].message.content;\n\nlet planData = {};\nlet totalDistance = 0;\nlet totalSessions = 0;\nlet summary = '';\n\ntry {\n  const parsed = JSON.parse(aiContent);\n  planData = parsed.plan || {};\n  totalDistance = parsed.total_distance_km || 0;\n  totalSessions = parsed.total_sessions || 0;\n  summary = parsed.summary || '';\n} catch (e) {\n  // Fallback plan if parsing fails\n  planData = {\n    monday: { type: 'easy_run', distance_km: 5, notes: '–õ—ë–≥–∫–∏–π –±–µ–≥' },\n    tuesday: { type: 'rest', notes: '–û—Ç–¥—ã—Ö' },\n    wednesday: { type: 'intervals', distance_km: 6, notes: '–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã' },\n    thursday: { type: 'rest', notes: '–û—Ç–¥—ã—Ö' },\n    friday: { type: 'easy_run', distance_km: 5, notes: '–õ—ë–≥–∫–∏–π –±–µ–≥' },\n    saturday: { type: 'long_run', distance_km: 10, notes: '–î–ª–∏–Ω–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞' },\n    sunday: { type: 'rest', notes: '–û—Ç–¥—ã—Ö' }\n  };\n  totalDistance = 26;\n  totalSessions = 4;\n  summary = '–ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫';\n}\n\n// Add completed: false to each day\nfor (const day of Object.keys(planData)) {\n  planData[day].completed = false;\n  planData[day].completed_at = null;\n}\n\nreturn [{\n  json: {\n    user_id: prepData.user_id,\n    chat_id: prepData.chat_id,\n    week_start: prepData.week_start,\n    week_end: prepData.week_end,\n    plan_data: planData,\n    total_distance_km: totalDistance,\n    total_sessions: totalSessions,\n    summary: summary\n  }\n}];"
      },
      "name": "Parse Plan",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3840, 600]
    },
    {
      "id": "plan-save-006",
      "parameters": {
        "operation": "create",
        "tableId": "weekly_plans",
        "dataToSend": "defineBelow",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id }}"
            },
            {
              "fieldId": "week_start",
              "fieldValue": "={{ $json.week_start }}"
            },
            {
              "fieldId": "week_end",
              "fieldValue": "={{ $json.week_end }}"
            },
            {
              "fieldId": "week_number",
              "fieldValue": "1"
            },
            {
              "fieldId": "plan_data",
              "fieldValue": "={{ $json.plan_data }}"
            },
            {
              "fieldId": "total_distance_km",
              "fieldValue": "={{ $json.total_distance_km }}"
            },
            {
              "fieldId": "total_sessions",
              "fieldValue": "={{ $json.total_sessions }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "active"
            }
          ]
        }
      },
      "name": "Save Weekly Plan",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [4040, 600]
    },
    {
      "id": "plan-format-007",
      "parameters": {
        "jsCode": "const data = $('Parse Plan').item.json;\nconst plan = data.plan_data;\n\nconst dayNames = {\n  monday: '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',\n  tuesday: '–í—Ç–æ—Ä–Ω–∏–∫',\n  wednesday: '–°—Ä–µ–¥–∞',\n  thursday: '–ß–µ—Ç–≤–µ—Ä–≥',\n  friday: '–ü—è—Ç–Ω–∏—Ü–∞',\n  saturday: '–°—É–±–±–æ—Ç–∞',\n  sunday: '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'\n};\n\nconst typeEmoji = {\n  rest: 'üò¥',\n  easy_run: 'üèÉ',\n  long_run: 'üèÉ‚Äç‚ôÇÔ∏è',\n  tempo: '‚ö°',\n  intervals: 'üî•',\n  fartlek: 'üéØ'\n};\n\nconst typeNames = {\n  rest: '–û—Ç–¥—ã—Ö',\n  easy_run: '–õ—ë–≥–∫–∏–π –±–µ–≥',\n  long_run: '–î–ª–∏–Ω–Ω–∞—è',\n  tempo: '–¢–µ–º–ø–æ–≤–∞—è',\n  intervals: '–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã',\n  fartlek: '–§–∞—Ä—Ç–ª–µ–∫'\n};\n\nlet message = 'üóì *–ü–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∞ –Ω–µ–¥–µ–ª—é*\\n';\nmessage += `üìÖ ${data.week_start} ‚Äî ${data.week_end}\\n\\n`;\n\nconst days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];\n\nfor (const day of days) {\n  const workout = plan[day];\n  if (!workout) continue;\n  \n  const emoji = typeEmoji[workout.type] || 'üìå';\n  const typeName = typeNames[workout.type] || workout.type;\n  \n  message += `*${dayNames[day]}* ${emoji}\\n`;\n  \n  if (workout.type === 'rest') {\n    message += `‚îî ${workout.notes || '–î–µ–Ω—å –æ—Ç–¥—ã—Ö–∞'}\\n`;\n  } else {\n    if (workout.distance_km) {\n      message += `‚îî ${typeName}: ${workout.distance_km} –∫–º`;\n      if (workout.pace_range) {\n        message += ` @ ${workout.pace_range}`;\n      }\n      message += '\\n';\n    }\n    if (workout.notes && workout.type !== 'rest') {\n      message += `‚îî ${workout.notes}\\n`;\n    }\n  }\n  message += '\\n';\n}\n\nmessage += `üìä *–ò—Ç–æ–≥–æ:* ${data.total_distance_km} –∫–º –∑–∞ ${data.total_sessions} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\\n\\n`;\nmessage += `üí° ${data.summary}\\n\\n`;\nmessage += '_–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–∞–ø–∏—à–∏ –º–Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî —è —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é –ø–ª–∞–Ω!_';\n\nreturn [{\n  json: {\n    chat_id: data.chat_id,\n    message: message\n  }\n}];"
      },
      "name": "Format Plan Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4240, 600]
    },
    {
      "id": "plan-send-008",
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $json.chat_id.toString() }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "name": "Send Plan to Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [4440, 600]
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [[{"node": "Extract Message", "type": "main", "index": 0}]]
    },
    "Extract Message": {
      "main": [[{"node": "Get User", "type": "main", "index": 0}]]
    },
    "Get User": {
      "main": [[{"node": "Check User", "type": "main", "index": 0}]]
    },
    "Check User": {
      "main": [[{"node": "User Not Found?", "type": "main", "index": 0}]]
    },
    "User Not Found?": {
      "main": [
        [{"node": "Create User", "type": "main", "index": 0}],
        [{"node": "Prepare Data", "type": "main", "index": 0}]
      ]
    },
    "Create User": {
      "main": [[{"node": "Get User Again", "type": "main", "index": 0}]]
    },
    "Get User Again": {
      "main": [[{"node": "Prepare Data", "type": "main", "index": 0}]]
    },
    "Prepare Data": {
      "main": [[{"node": "Call OpenAI", "type": "main", "index": 0}]]
    },
    "Call OpenAI": {
      "main": [[{"node": "Extract Response", "type": "main", "index": 0}]]
    },
    "Extract Response": {
      "main": [[
        {"node": "Save User Msg", "type": "main", "index": 0},
        {"node": "Send to Telegram", "type": "main", "index": 0},
        {"node": "Is Onboarding?", "type": "main", "index": 0}
      ]]
    },
    "Save User Msg": {
      "main": [[{"node": "Save AI Msg", "type": "main", "index": 0}]]
    },
    "Is Onboarding?": {
      "main": [
        [{"node": "Build Update Data", "type": "main", "index": 0}],
        []
      ]
    },
    "Build Update Data": {
      "main": [[{"node": "Has Updates?", "type": "main", "index": 0}]]
    },
    "Has Updates?": {
      "main": [
        [{"node": "Update User Profile", "type": "main", "index": 0}],
        []
      ]
    },
    "Update User Profile": {
      "main": [[{"node": "Just Completed?", "type": "main", "index": 0}]]
    },
    "Just Completed?": {
      "main": [
        [{"node": "Get User For Plan", "type": "main", "index": 0}],
        []
      ]
    },
    "Get User For Plan": {
      "main": [[{"node": "Prepare Plan Prompt", "type": "main", "index": 0}]]
    },
    "Prepare Plan Prompt": {
      "main": [[{"node": "Generate Plan AI", "type": "main", "index": 0}]]
    },
    "Generate Plan AI": {
      "main": [[{"node": "Parse Plan", "type": "main", "index": 0}]]
    },
    "Parse Plan": {
      "main": [[{"node": "Save Weekly Plan", "type": "main", "index": 0}]]
    },
    "Save Weekly Plan": {
      "main": [[{"node": "Format Plan Message", "type": "main", "index": 0}]]
    },
    "Format Plan Message": {
      "main": [[{"node": "Send Plan to Telegram", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": []
}
